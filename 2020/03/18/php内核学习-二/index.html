<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>php内核学习(二) | knight'blog</title><meta name="description" content="php内核学习(2)开始的时候，找函数下断点找得够呛，网上查资料想起来，php内核的操作符都在zend的zend_operators.c里面，应该去这里面找的&#x3D;&#x3D;操作符的函数下断点，然后进行调试，此模式为cgi模式 test.php 12&lt;?phpvar_dump(&quot;0e12331&quot;&#x3D;&#x3D;&quot;0e4543&quot;);    cgi_main.c main()12345678910111213if((q"><meta name="keywords" content="web,PHP内核"><meta name="author" content="knight"><meta name="copyright" content="knight"><meta name="format-detection" content="telephone=no"><link rel="shortcut icon" href="/knightswd.github.io/img/favicon.png"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="dns-prefetch" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="crossorigin"/><link rel="dns-prefetch" href="https://www.google-analytics.com"/><link rel="preconnect" href="http://ta.qq.com"/><link rel="dns-prefetch" href="http://ta.qq.com"/><link rel="preconnect" href="https://fonts.googleapis.com" crossorigin="crossorigin"/><link rel="dns-prefetch" href="https://fonts.googleapis.com"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="dns-prefetch" href="//busuanzi.ibruce.info"/><meta name="google-site-verification" content="google58c08015384a8851.html"/><meta name="baidu-site-verification" content="j6nEJEfPLf"/><meta name="twitter:card" content="summary"><meta name="twitter:title" content="php内核学习(二)"><meta name="twitter:description" content="php内核学习(2)开始的时候，找函数下断点找得够呛，网上查资料想起来，php内核的操作符都在zend的zend_operators.c里面，应该去这里面找的&#x3D;&#x3D;操作符的函数下断点，然后进行调试，此模式为cgi模式 test.php 12&lt;?phpvar_dump(&quot;0e12331&quot;&#x3D;&#x3D;&quot;0e4543&quot;);    cgi_main.c main()12345678910111213if((q"><meta name="twitter:image" content="https://knightswd.github.io/2020/03/18/php%E5%86%85%E6%A0%B8%E5%AD%A6%E4%B9%A0-%E4%BA%8C/cover.jpg"><meta property="og:type" content="article"><meta property="og:title" content="php内核学习(二)"><meta property="og:url" content="https://knightswd.github.io/2020/03/18/php%E5%86%85%E6%A0%B8%E5%AD%A6%E4%B9%A0-%E4%BA%8C/"><meta property="og:site_name" content="knight'blog"><meta property="og:description" content="php内核学习(2)开始的时候，找函数下断点找得够呛，网上查资料想起来，php内核的操作符都在zend的zend_operators.c里面，应该去这里面找的&#x3D;&#x3D;操作符的函数下断点，然后进行调试，此模式为cgi模式 test.php 12&lt;?phpvar_dump(&quot;0e12331&quot;&#x3D;&#x3D;&quot;0e4543&quot;);    cgi_main.c main()12345678910111213if((q"><meta property="og:image" content="https://knightswd.github.io/2020/03/18/php%E5%86%85%E6%A0%B8%E5%AD%A6%E4%B9%A0-%E4%BA%8C/cover.jpg"><meta property="article:published_time" content="2020-03-18T10:20:01.000Z"><meta property="article:modified_time" content="2020-03-18T10:34:36.046Z"><script src="https://cdn.jsdelivr.net/npm/js-cookie/dist/js.cookie.min.js"></script><script>var autoChangeMode = '1'
var t = Cookies.get("theme")
if (autoChangeMode == '1'){
  var isDarkMode = window.matchMedia("(prefers-color-scheme: dark)").matches
  var isLightMode = window.matchMedia("(prefers-color-scheme: light)").matches
  var isNotSpecified = window.matchMedia("(prefers-color-scheme: no-preference)").matches
  var hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified

  if (t === undefined){
    if (isLightMode) activateLightMode()
    else if (isDarkMode) activateDarkMode()
    else if (isNotSpecified || hasNoSupport){
      console.log('You specified no preference for a color scheme or your browser does not support it. I Schedule dark mode during night time.')
      var now = new Date()
      var hour = now.getHours()
      var isNight = hour < 6 || hour >= 18
      isNight ? activateDarkMode() : activateLightMode()
  }
  } else if (t == 'light') activateLightMode()
  else activateDarkMode()

} else if (autoChangeMode == '2'){
  now = new Date();
  hour = now.getHours();
  isNight = hour < 6 || hour >= 18
  if(t === undefined) isNight? activateDarkMode() : activateLightMode()
  else if (t === 'light') activateLightMode()
  else activateDarkMode() 
} else {
  if ( t == 'dark' ) activateDarkMode()
  else if ( t == 'light') activateLightMode()
}

function activateDarkMode(){
  document.documentElement.setAttribute('data-theme', 'dark')
  if (document.querySelector('meta[name="theme-color"]') !== null){
    document.querySelector('meta[name="theme-color"]').setAttribute('content','#000')
  }
}
function activateLightMode(){
  document.documentElement.setAttribute('data-theme', 'light')
  if (document.querySelector('meta[name="theme-color"]') !== null){
  document.querySelector('meta[name="theme-color"]').setAttribute('content','#fff')
  }
}</script><link rel="stylesheet" href="/knightswd.github.io/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@latest/css/font-awesome.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.css"><link rel="canonical" href="https://knightswd.github.io/2020/03/18/php%E5%86%85%E6%A0%B8%E5%AD%A6%E4%B9%A0-%E4%BA%8C/"><link rel="prev" title="php内核学习(三)" href="https://knightswd.github.io/2020/03/29/php%E5%86%85%E6%A0%B8%E5%AD%A6%E4%B9%A0-%E4%B8%89/"><link rel="next" title="php内核学习(一)" href="https://knightswd.github.io/2020/03/12/php%E5%86%85%E6%A0%B8%E5%AD%A6%E4%B9%A0-%E4%B8%80/"><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/gitalk/dist/gitalk.min.css"><script src="https://cdn.jsdelivr.net/npm/gitalk@latest/dist/gitalk.min.js"></script><script src="https://cdn.jsdelivr.net/npm/blueimp-md5/js/md5.min.js"></script><script async="async" src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><script>(adsbygoogle = window.adsbygoogle || []).push({
  google_ad_client: '',
  enable_page_level_ads: 'true'
});</script><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-167213955-1', 'auto');
ga('send', 'pageview');
</script><script src="https://tajs.qq.com/stats?sId=66558945" charset="UTF-8"></script><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Titillium+Web"><script>var GLOBAL_CONFIG = { 
  root: '/knightswd.github.io/',
  algolia: undefined,
  localSearch: undefined,
  translate: {"defaultEncoding":2,"translateDelay":0,"cookieDomain":"https://knlght.top/","msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"簡"},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  bookmark: {
    message_prev: '按',
    message_next: '键将本页加入书签'
  },
  runtime_unit: '天',
  runtime: true,
  copyright: undefined,
  ClickShowText: undefined,
  medium_zoom: true,
  fancybox: true,
  Snackbar: {"bookmark":{"message_prev":"按","message_next":"键将本页加入书签"},"chs_to_cht":"你已切换为繁体","cht_to_chs":"你已切换为简体","day_to_night":"你已切换为深色模式","night_to_day":"你已切换为浅色模式","bgLight":"#49b1f5","bgDark":"#2d3035","position":"bottom-left"},
  baiduPush: true,
  highlightCopy: true,
  highlightLang: true,
  highlightShrink: 'false',
  isFontAwesomeV5: false,
  isPhotoFigcaption: false,
  islazyload: true,
  isanchor: true
  
}</script><script>var GLOBAL_CONFIG_SITE = { 
  isPost: true,
  isHome: false,
  isSidebar: true  
  }</script><noscript><style>
#page-header {
  opacity: 1
}
.justified-gallery img{
  opacity: 1
}
</style></noscript><meta name="generator" content="Hexo 4.2.1"><link rel="alternate" href="/knightswd.github.io/atom.xml" title="knight'blog" type="application/atom+xml">
</head><body><div id="loading-box"><div class="loading-left-bg"></div><div class="loading-right-bg"></div><div class="spinner-box"><div class="configure-border-1"><div class="configure-core"></div></div><div class="configure-border-2"><div class="configure-core"></div></div><div class="loading-word">加载中...</div></div></div><canvas class="fireworks"></canvas><div id="mobile-sidebar"><div id="menu_mask"></div><div id="mobile-sidebar-menus"><div class="mobile_author_icon"><img class="avatar-img" src="/knightswd.github.io/img/avatar.png" onerror="onerror=null;src='/img/avatar.jpg'" alt="avatar"/></div><div class="mobile_post_data"><div class="mobile_data_item is-center"><div class="mobile_data_link"><a href="/knightswd.github.io/archives/"><div class="headline">文章</div><div class="length_num">23</div></a></div></div><div class="mobile_data_item is-center">      <div class="mobile_data_link"><a href="/knightswd.github.io/tags/"><div class="headline">标签</div><div class="length_num">35</div></a></div></div><div class="mobile_data_item is-center">     <div class="mobile_data_link"><a href="/knightswd.github.io/categories/"><div class="headline">分类</div><div class="length_num">2</div></a></div></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/knightswd.github.io/"><i class="fa-fw fa fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/knightswd.github.io/archives/"><i class="fa-fw fa fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/knightswd.github.io/tags/"><i class="fa-fw fa fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/knightswd.github.io/categories/"><i class="fa-fw fa fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="/knightswd.github.io/link/"><i class="fa-fw fa fa-link"></i><span> Link</span></a></div><div class="menus_item"><a class="site-page" href="/knightswd.github.io/about/"><i class="fa-fw fa fa-heart"></i><span> About</span></a></div><div class="menus_item"><a class="site-page"><i class="fa-fw fa fa-list" aria-hidden="true"></i><span> List</span><i class="fa fa-chevron-down menus-expand" aria-hidden="true"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/knightswd.github.io/music/"><i class="fa-fw fa fa-music"></i><span> Music</span></a></li><li><a class="site-page" href="/knightswd.github.io/movies/"><i class="fa-fw fa fa-film"></i><span> Movie</span></a></li></ul></div></div></div></div><i class="fa fa-arrow-right on" id="toggle-sidebar" aria-hidden="true">     </i><div id="sidebar"><div class="sidebar-toc"><div class="sidebar-toc__title">目录</div><div class="sidebar-toc__progress"><span class="progress-notice">你已经读了</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar">     </div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#php内核学习-2"><span class="toc-text">php内核学习(2)</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#cgi-main-c-main"><span class="toc-text">cgi_main.c main()</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#main-c-php-execute-script"><span class="toc-text">main.c php_execute_script()</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#phar-c-phar-compile-file"><span class="toc-text">phar.c phar_compile_file()</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#zend-language-scanner-l-compile-file"><span class="toc-text">zend_language_scanner.l compile_file()</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#zend-operators-c-is-equal-function"><span class="toc-text">zend_operators.c is_equal_function()</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#zend-operators-c-zend-compare"><span class="toc-text">zend_operators.c zend_compare()</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#zend-operators-c-zendi-smart-strcmp"><span class="toc-text">zend_operators.c zendi_smart_strcmp()</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#zend-operators-c-is-numeric-string-ex"><span class="toc-text">zend_operators.c _is_numeric_string_ex()</span></a></li></ol></li></ol></div></div></div><div id="body-wrap"><div class="post-bg" id="nav" style="background-image: url(/knightswd.github.io/2020/03/18/php%E5%86%85%E6%A0%B8%E5%AD%A6%E4%B9%A0-%E4%BA%8C/cover.jpg)"><div id="page-header"><span class="pull_left" id="blog_name"><a class="blog_title" id="site-name" href="/knightswd.github.io/">knight'blog</a></span><span class="pull_right menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/knightswd.github.io/"><i class="fa-fw fa fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/knightswd.github.io/archives/"><i class="fa-fw fa fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/knightswd.github.io/tags/"><i class="fa-fw fa fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/knightswd.github.io/categories/"><i class="fa-fw fa fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="/knightswd.github.io/link/"><i class="fa-fw fa fa-link"></i><span> Link</span></a></div><div class="menus_item"><a class="site-page" href="/knightswd.github.io/about/"><i class="fa-fw fa fa-heart"></i><span> About</span></a></div><div class="menus_item"><a class="site-page"><i class="fa-fw fa fa-list" aria-hidden="true"></i><span> List</span><i class="fa fa-chevron-down menus-expand" aria-hidden="true"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/knightswd.github.io/music/"><i class="fa-fw fa fa-music"></i><span> Music</span></a></li><li><a class="site-page" href="/knightswd.github.io/movies/"><i class="fa-fw fa fa-film"></i><span> Movie</span></a></li></ul></div></div><span class="toggle-menu close"><a class="site-page"><i class="fa fa-bars fa-fw" aria-hidden="true"></i></a></span></span></div><div id="post-info"><div id="post-title"><div class="posttitle">php内核学习(二)</div></div><div id="post-meta"><div class="meta-firstline"><time class="post-meta__date"><span class="post-meta__date-created" title="发表于 2020-03-18 18:20:01"><i class="fa fa-calendar" aria-hidden="true"></i> 发表于 2020-03-18</span><span class="post-meta__separator">|</span><span class="post-meta__date-updated" title="更新于 2020-03-18 18:34:36"><i class="fa fa-history" aria-hidden="true"></i> 更新于 2020-03-18</span></time></div><div class="meta-secondline"> <span class="post-meta-wordcount"><i class="post-meta__icon fa fa-file-word-o" aria-hidden="true"></i><span>字数总计:</span><span class="word-count">1.4k</span><span class="post-meta__separator">|</span><i class="post-meta__icon fa fa-clock-o" aria-hidden="true"></i><span>阅读时长: 7 分钟</span></span></div><div class="meta-thirdline"><span class="post-meta-pv-cv"><span class="post-meta__separator">|</span><i class="fa fa-eye post-meta__icon" aria-hidden="true"> </i><span>阅读量:</span><span id="busuanzi_value_page_pv"></span></span><span class="post-meta-commentcount"><span class="post-meta__separator">|</span><i class="post-meta__icon fa fa-comment-o" aria-hidden="true"></i><span>评论数:</span><a href="/knightswd.github.io/2020/03/18/php%E5%86%85%E6%A0%B8%E5%AD%A6%E4%B9%A0-%E4%BA%8C/#post-comment"><span class="gitalk-comment-count comment-count"></span></a></span></div></div></div></div><main class="layout_post" id="content-inner"><article id="post"><div class="post-content" id="article-container"><h1 id="php内核学习-2"><a href="#php内核学习-2" class="headerlink" title="php内核学习(2)"></a>php内核学习(2)</h1><p>开始的时候，找函数下断点找得够呛，网上查资料想起来，php内核的操作符都在zend的zend_operators.c里面，应该去这里面找的==操作符的函数下断点，然后进行调试，此模式为cgi模式</p>
<p>test.php</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">var_dump(<span class="string">"0e12331"</span>==<span class="string">"0e4543"</span>);</span><br></pre></td></tr></table></figure>



<h2 id="cgi-main-c-main"><a href="#cgi-main-c-main" class="headerlink" title="cgi_main.c main()"></a>cgi_main.c main()</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>((query_string = getenv(<span class="string">"QUERY_STRING"</span>)) != <span class="literal">NULL</span> &amp;&amp; <span class="built_in">strchr</span>(query_string, <span class="string">'='</span>) == <span class="literal">NULL</span>) &#123;</span><br><span class="line">		<span class="comment">/* we've got query string that has no = - apache CGI will pass it to command line */</span></span><br><span class="line">		<span class="keyword">unsigned</span> <span class="keyword">char</span> *p;</span><br><span class="line">		decoded_query_string = strdup(query_string);</span><br><span class="line">		php_url_decode(decoded_query_string, <span class="built_in">strlen</span>(decoded_query_string));</span><br><span class="line">		<span class="keyword">for</span> (p = (<span class="keyword">unsigned</span> <span class="keyword">char</span> *)decoded_query_string; *p &amp;&amp;  *p &lt;= <span class="string">' '</span>; p++) &#123;</span><br><span class="line">			<span class="comment">/* skip all leading spaces */</span></span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span>(*p == <span class="string">'-'</span>) &#123;</span><br><span class="line">			skip_getopt = <span class="number">1</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="built_in">free</span>(decoded_query_string);</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>

<p>url中查询中编码的字符串在此处解码</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">				we never take stdin if we're (f)cgi, always</span></span><br><span class="line"><span class="comment">				rely on the web server giving us the info</span></span><br><span class="line"><span class="comment">				we need in the environment.</span></span><br><span class="line"><span class="comment">			*/</span></span><br><span class="line">			<span class="keyword">if</span> (SG(request_info).path_translated || cgi || fastcgi) &#123;</span><br><span class="line">				zend_stream_init_filename(&amp;file_handle, SG(request_info).path_translated);</span><br><span class="line">			&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">				zend_stream_init_fp(&amp;file_handle, <span class="built_in">stdin</span>, <span class="string">"Standard input code"</span>);</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			<span class="comment">/* request startup only after we've done all we can to</span></span><br><span class="line"><span class="comment">			 * get path_translated */</span></span><br><span class="line">			<span class="keyword">if</span> (php_request_startup() == FAILURE) &#123;</span><br><span class="line">				<span class="keyword">if</span> (fastcgi) &#123;</span><br><span class="line">					fcgi_finish_request(request, <span class="number">1</span>);</span><br><span class="line">				&#125;</span><br><span class="line">				SG(server_context) = <span class="literal">NULL</span>;</span><br><span class="line">				php_module_shutdown();</span><br><span class="line">				<span class="keyword">return</span> FAILURE;</span><br><span class="line">			&#125;</span><br></pre></td></tr></table></figure>

<p>将服务器传输过来的数据存入结构体</p>
<h2 id="main-c-php-execute-script"><a href="#main-c-php-execute-script" class="headerlink" title="main.c php_execute_script()"></a>main.c php_execute_script()</h2><p>这个和后面的查找函数，分析数据就和之前第一版的一样了，这里主要是研究php弱类型，所以这次我们进入zend_compile_file()的函数编译阶段</p>
<h2 id="phar-c-phar-compile-file"><a href="#phar-c-phar-compile-file" class="headerlink" title="phar.c phar_compile_file()"></a>phar.c phar_compile_file()</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (<span class="built_in">strstr</span>(file_handle-&gt;filename, <span class="string">".phar"</span>) &amp;&amp; !<span class="built_in">strstr</span>(file_handle-&gt;filename, <span class="string">"://"</span>)) &#123;</span><br><span class="line">		<span class="keyword">if</span> (SUCCESS == phar_open_from_filename((<span class="keyword">char</span>*)file_handle-&gt;filename, <span class="built_in">strlen</span>(file_handle-&gt;filename), <span class="literal">NULL</span>, <span class="number">0</span>, <span class="number">0</span>, &amp;phar, <span class="literal">NULL</span>)) &#123;</span><br><span class="line">			<span class="keyword">if</span> (phar-&gt;is_zip || phar-&gt;is_tar) &#123;</span><br><span class="line">				zend_file_handle f = *file_handle;</span><br><span class="line"></span><br><span class="line">				<span class="comment">/* zip or tar-based phar */</span></span><br><span class="line">				spprintf(&amp;name, <span class="number">4096</span>, <span class="string">"phar://%s/%s"</span>, file_handle-&gt;filename, <span class="string">".phar/stub.php"</span>);</span><br><span class="line">				<span class="keyword">if</span> (SUCCESS == phar_orig_zend_open((<span class="keyword">const</span> <span class="keyword">char</span> *)name, &amp;f)) &#123;</span><br><span class="line"></span><br><span class="line">					efree(name);</span><br><span class="line">					name = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">					f.filename = file_handle-&gt;filename;</span><br><span class="line">					<span class="keyword">if</span> (f.opened_path) &#123;</span><br><span class="line">						efree(f.opened_path);</span><br><span class="line">					&#125;</span><br><span class="line">					f.opened_path = file_handle-&gt;opened_path;</span><br><span class="line">					f.free_filename = file_handle-&gt;free_filename;</span><br><span class="line"></span><br><span class="line">					<span class="keyword">switch</span> (file_handle-&gt;type) &#123;</span><br><span class="line">						<span class="keyword">case</span> ZEND_HANDLE_STREAM:</span><br><span class="line">							<span class="keyword">if</span> (file_handle-&gt;handle.stream.closer &amp;&amp; file_handle-&gt;handle.stream.handle) &#123;</span><br><span class="line">								file_handle-&gt;handle.stream.closer(file_handle-&gt;handle.stream.handle);</span><br><span class="line">							&#125;</span><br><span class="line">							file_handle-&gt;handle.stream.handle = <span class="literal">NULL</span>;</span><br><span class="line">							<span class="keyword">break</span>;</span><br><span class="line">						<span class="keyword">default</span>:</span><br><span class="line">							<span class="keyword">break</span>;</span><br><span class="line">					&#125;</span><br><span class="line">					*file_handle = f;</span><br><span class="line">				&#125;</span><br><span class="line">			&#125; <span class="keyword">else</span> <span class="keyword">if</span> (phar-&gt;flags &amp; PHAR_FILE_COMPRESSION_MASK) &#123;</span><br><span class="line">				zend_file_handle_dtor(file_handle);</span><br><span class="line">				<span class="comment">/* compressed phar */</span></span><br><span class="line">				file_handle-&gt;type = ZEND_HANDLE_STREAM;</span><br><span class="line">				<span class="comment">/* we do our own reading directly from the phar, don't change the next line */</span></span><br><span class="line">				file_handle-&gt;handle.stream.handle  = phar;</span><br><span class="line">				file_handle-&gt;handle.stream.reader  = phar_zend_stream_reader;</span><br><span class="line">				file_handle-&gt;handle.stream.closer  = <span class="literal">NULL</span>;</span><br><span class="line">				file_handle-&gt;handle.stream.fsizer  = phar_zend_stream_fsizer;</span><br><span class="line">				file_handle-&gt;handle.stream.isatty  = <span class="number">0</span>;</span><br><span class="line">				phar-&gt;is_persistent ?</span><br><span class="line">					php_stream_rewind(PHAR_G(cached_fp)[phar-&gt;phar_pos].fp) :</span><br><span class="line">					php_stream_rewind(phar-&gt;fp);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>

<p>这里对phar的处理，就解释了为什么phar://phar.phar/xxx后面可以是任意的文件名了。</p>
<h2 id="zend-language-scanner-l-compile-file"><a href="#zend-language-scanner-l-compile-file" class="headerlink" title="zend_language_scanner.l compile_file()"></a>zend_language_scanner.l compile_file()</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (open_file_for_scanning(file_handle)==FAILURE) &#123;</span><br><span class="line">		<span class="keyword">if</span> (!EG(exception)) &#123;</span><br><span class="line">			<span class="keyword">if</span> (type==ZEND_REQUIRE) &#123;</span><br><span class="line">				zend_message_dispatcher(ZMSG_FAILED_REQUIRE_FOPEN, file_handle-&gt;filename);</span><br><span class="line">				zend_bailout();</span><br><span class="line">			&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">				zend_message_dispatcher(ZMSG_FAILED_INCLUDE_FOPEN, file_handle-&gt;filename);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		op_array = zend_compile(ZEND_USER_FUNCTION);</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>

<p>打开之前传人的文件，即获取文件内容，接着就是调用re2c和bison进行语法解析和词法解析，将代码解析成抽象语法树(ast树)的过程了。</p>
<h2 id="zend-operators-c-is-equal-function"><a href="#zend-operators-c-is-equal-function" class="headerlink" title="zend_operators.c is_equal_function()"></a>zend_operators.c is_equal_function()</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">ZEND_API <span class="keyword">int</span> ZEND_FASTCALL <span class="title">is_equal_function</span><span class="params">(zval *result, zval *op1, zval *op2)</span> <span class="comment">/* &#123;&#123;&#123; */</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	ZVAL_BOOL(result, zend_compare(op1, op2) == <span class="number">0</span>);</span><br><span class="line">	<span class="keyword">return</span> SUCCESS;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>此处主要是调用zend_compare()来进行比较</p>
<h2 id="zend-operators-c-zend-compare"><a href="#zend-operators-c-zend-compare" class="headerlink" title="zend_operators.c zend_compare()"></a>zend_operators.c zend_compare()</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">while</span> (<span class="number">1</span>) &#123;</span><br><span class="line">		<span class="keyword">switch</span> (TYPE_PAIR(Z_TYPE_P(op1), Z_TYPE_P(op2))) &#123;<span class="comment">//根据两个数的类型来进行比较</span></span><br><span class="line">			<span class="function"><span class="keyword">case</span> <span class="title">TYPE_PAIR</span><span class="params">(IS_LONG, IS_LONG)</span>:</span></span><br><span class="line">				return Z_LVAL_P(op1)&gt;Z_LVAL_P(op2)?1:(Z_LVAL_P(op1)&lt;Z_LVAL_P(op2)?-1:0);</span><br><span class="line"></span><br><span class="line">			<span class="function"><span class="keyword">case</span> <span class="title">TYPE_PAIR</span><span class="params">(IS_DOUBLE, IS_LONG)</span>:<span class="comment">//将long转成double</span></span></span><br><span class="line"><span class="function">				<span class="keyword">return</span> <span class="title">ZEND_NORMALIZE_BOOL</span><span class="params">(Z_DVAL_P(op1) - (<span class="keyword">double</span>)Z_LVAL_P(op2))</span></span>;</span><br><span class="line"></span><br><span class="line">			<span class="function"><span class="keyword">case</span> <span class="title">TYPE_PAIR</span><span class="params">(IS_LONG, IS_DOUBLE)</span>:</span></span><br><span class="line"><span class="function">				<span class="keyword">return</span> <span class="title">ZEND_NORMALIZE_BOOL</span><span class="params">((<span class="keyword">double</span>)Z_LVAL_P(op1) - Z_DVAL_P(op2))</span></span>;</span><br><span class="line"></span><br><span class="line">			<span class="function"><span class="keyword">case</span> <span class="title">TYPE_PAIR</span><span class="params">(IS_DOUBLE, IS_DOUBLE)</span>:</span></span><br><span class="line"><span class="function">				<span class="title">if</span> <span class="params">(Z_DVAL_P(op1) == Z_DVAL_P(op2))</span> </span>&#123;</span><br><span class="line">					<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">				&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">					<span class="keyword">return</span> ZEND_NORMALIZE_BOOL(Z_DVAL_P(op1) - Z_DVAL_P(op2));</span><br><span class="line">				&#125;</span><br><span class="line"></span><br><span class="line">			<span class="function"><span class="keyword">case</span> <span class="title">TYPE_PAIR</span><span class="params">(IS_ARRAY, IS_ARRAY)</span>:</span></span><br><span class="line"><span class="function">				<span class="keyword">return</span> <span class="title">zend_compare_arrays</span><span class="params">(op1, op2)</span></span>;</span><br><span class="line"></span><br><span class="line">			<span class="function"><span class="keyword">case</span> <span class="title">TYPE_PAIR</span><span class="params">(IS_NULL, IS_NULL)</span>:</span></span><br><span class="line"><span class="function">			<span class="keyword">case</span> <span class="title">TYPE_PAIR</span><span class="params">(IS_NULL, IS_FALSE)</span>:</span></span><br><span class="line"><span class="function">			<span class="keyword">case</span> <span class="title">TYPE_PAIR</span><span class="params">(IS_FALSE, IS_NULL)</span>:</span></span><br><span class="line"><span class="function">			<span class="keyword">case</span> <span class="title">TYPE_PAIR</span><span class="params">(IS_FALSE, IS_FALSE)</span>:</span></span><br><span class="line"><span class="function">			<span class="keyword">case</span> <span class="title">TYPE_PAIR</span><span class="params">(IS_TRUE, IS_TRUE)</span>:</span></span><br><span class="line"><span class="function">				<span class="keyword">return</span> 0</span>;</span><br><span class="line"></span><br><span class="line">			<span class="function"><span class="keyword">case</span> <span class="title">TYPE_PAIR</span><span class="params">(IS_NULL, IS_TRUE)</span>:</span></span><br><span class="line">				return -1;</span><br><span class="line"></span><br><span class="line">			<span class="function"><span class="keyword">case</span> <span class="title">TYPE_PAIR</span><span class="params">(IS_TRUE, IS_NULL)</span>:</span></span><br><span class="line"><span class="function">				<span class="keyword">return</span> 1</span>;</span><br><span class="line"></span><br><span class="line">			<span class="function"><span class="keyword">case</span> <span class="title">TYPE_PAIR</span><span class="params">(IS_STRING, IS_STRING)</span>:</span></span><br><span class="line"><span class="function">				<span class="title">if</span> <span class="params">(Z_STR_P(op1) == Z_STR_P(op2))</span> </span>&#123;</span><br><span class="line">					<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">				&#125;</span><br><span class="line">				<span class="keyword">return</span> zendi_smart_strcmp(Z_STR_P(op1), Z_STR_P(op2));</span><br><span class="line"></span><br><span class="line">			<span class="function"><span class="keyword">case</span> <span class="title">TYPE_PAIR</span><span class="params">(IS_NULL, IS_STRING)</span>:</span></span><br><span class="line"><span class="function">				<span class="keyword">return</span> <span class="title">Z_STRLEN_P</span><span class="params">(op2)</span> </span>== <span class="number">0</span> ? <span class="number">0</span> : <span class="number">-1</span>;</span><br><span class="line"></span><br><span class="line">			<span class="function"><span class="keyword">case</span> <span class="title">TYPE_PAIR</span><span class="params">(IS_STRING, IS_NULL)</span>:</span></span><br><span class="line"><span class="function">				<span class="keyword">return</span> <span class="title">Z_STRLEN_P</span><span class="params">(op1)</span> </span>== <span class="number">0</span> ? <span class="number">0</span> : <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">			<span class="function"><span class="keyword">case</span> <span class="title">TYPE_PAIR</span><span class="params">(IS_OBJECT, IS_NULL)</span>:</span></span><br><span class="line"><span class="function">				<span class="keyword">return</span> 1</span>;</span><br><span class="line"></span><br><span class="line">			<span class="function"><span class="keyword">case</span> <span class="title">TYPE_PAIR</span><span class="params">(IS_NULL, IS_OBJECT)</span>:</span></span><br><span class="line">				return -1;</span><br><span class="line"></span><br><span class="line">			<span class="keyword">default</span>:</span><br><span class="line">				<span class="keyword">if</span> (Z_ISREF_P(op1)) &#123;</span><br><span class="line">					op1 = Z_REFVAL_P(op1);</span><br><span class="line">					<span class="keyword">continue</span>;</span><br><span class="line">				&#125; <span class="keyword">else</span> <span class="keyword">if</span> (Z_ISREF_P(op2)) &#123;</span><br><span class="line">					op2 = Z_REFVAL_P(op2);</span><br><span class="line">					<span class="keyword">continue</span>;</span><br><span class="line">				&#125;</span><br><span class="line"></span><br><span class="line">				<span class="keyword">if</span> (Z_TYPE_P(op1) == IS_OBJECT</span><br><span class="line">				 &amp;&amp; Z_TYPE_P(op2) == IS_OBJECT</span><br><span class="line">				 &amp;&amp; Z_OBJ_P(op1) == Z_OBJ_P(op2)) &#123;</span><br><span class="line">					<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">				&#125; <span class="keyword">else</span> <span class="keyword">if</span> (Z_TYPE_P(op1) == IS_OBJECT) &#123;</span><br><span class="line">					<span class="keyword">return</span> Z_OBJ_HANDLER_P(op1, compare)(op1, op2);</span><br><span class="line">				&#125; <span class="keyword">else</span> <span class="keyword">if</span> (Z_TYPE_P(op2) == IS_OBJECT) &#123;</span><br><span class="line">					<span class="keyword">return</span> Z_OBJ_HANDLER_P(op2, compare)(op1, op2);</span><br><span class="line">				&#125;</span><br><span class="line"></span><br><span class="line">				<span class="keyword">if</span> (!converted) &#123;</span><br><span class="line">					<span class="keyword">if</span> (Z_TYPE_P(op1) &lt; IS_TRUE) &#123;</span><br><span class="line">						<span class="keyword">return</span> zval_is_true(op2) ? <span class="number">-1</span> : <span class="number">0</span>;</span><br><span class="line">					&#125; <span class="keyword">else</span> <span class="keyword">if</span> (Z_TYPE_P(op1) == IS_TRUE) &#123;</span><br><span class="line">						<span class="keyword">return</span> zval_is_true(op2) ? <span class="number">0</span> : <span class="number">1</span>;</span><br><span class="line">					&#125; <span class="keyword">else</span> <span class="keyword">if</span> (Z_TYPE_P(op2) &lt; IS_TRUE) &#123;</span><br><span class="line">						<span class="keyword">return</span> zval_is_true(op1) ? <span class="number">1</span> : <span class="number">0</span>;</span><br><span class="line">					&#125; <span class="keyword">else</span> <span class="keyword">if</span> (Z_TYPE_P(op2) == IS_TRUE) &#123;</span><br><span class="line">						<span class="keyword">return</span> zval_is_true(op1) ? <span class="number">0</span> : <span class="number">-1</span>;</span><br><span class="line">					&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">						op1 = _zendi_convert_scalar_to_number(op1, &amp;op1_copy);</span><br><span class="line">						op2 = _zendi_convert_scalar_to_number(op2, &amp;op2_copy);</span><br><span class="line">						<span class="keyword">if</span> (EG(exception)) &#123;</span><br><span class="line">							<span class="keyword">return</span> <span class="number">1</span>; <span class="comment">/* to stop comparison of arrays */</span></span><br><span class="line">						&#125;</span><br><span class="line">						converted = <span class="number">1</span>;</span><br><span class="line">					&#125;</span><br><span class="line">				&#125; <span class="keyword">else</span> <span class="keyword">if</span> (Z_TYPE_P(op1)==IS_ARRAY) &#123;</span><br><span class="line">					<span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">				&#125; <span class="keyword">else</span> <span class="keyword">if</span> (Z_TYPE_P(op2)==IS_ARRAY) &#123;</span><br><span class="line">					<span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">				&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">					ZEND_ASSERT(<span class="number">0</span>);</span><br><span class="line">					zend_throw_error(<span class="literal">NULL</span>, <span class="string">"Unsupported operand types"</span>);</span><br><span class="line">					<span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">				&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>

<p>本次进入case TYPE_PAIR(IS_STRING, IS_STRING)，然后跟进zendi_smart_strcmp()</p>
<h2 id="zend-operators-c-zendi-smart-strcmp"><a href="#zend-operators-c-zendi-smart-strcmp" class="headerlink" title="zend_operators.c zendi_smart_strcmp()"></a>zend_operators.c zendi_smart_strcmp()</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ((ret1 = is_numeric_string_ex(s1-&gt;val, s1-&gt;len, &amp;lval1, &amp;dval1, <span class="number">0</span>, &amp;oflow1)) &amp;&amp;</span><br><span class="line">		(ret2 = is_numeric_string_ex(s2-&gt;val, s2-&gt;len, &amp;lval2, &amp;dval2, <span class="number">0</span>, &amp;oflow2)))</span><br></pre></td></tr></table></figure>

<p>跟进is_numeric_string_ex（）</p>
<h2 id="zend-operators-c-is-numeric-string-ex"><a href="#zend-operators-c-is-numeric-string-ex" class="headerlink" title="zend_operators.c _is_numeric_string_ex()"></a>zend_operators.c _is_numeric_string_ex()</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* Skip any whitespace</span></span><br><span class="line"><span class="comment">	 * This is much faster than the isspace() function */</span></span><br><span class="line">	<span class="keyword">while</span> (*str == <span class="string">' '</span> || *str == <span class="string">'\t'</span> || *str == <span class="string">'\n'</span> || *str == <span class="string">'\r'</span> || *str == <span class="string">'\v'</span> || *str == <span class="string">'\f'</span>) &#123;</span><br><span class="line">		str++;</span><br><span class="line">		length--;</span><br><span class="line">	&#125;</span><br><span class="line">	ptr = str;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (*ptr == <span class="string">'-'</span>) &#123;</span><br><span class="line">		neg = <span class="number">1</span>;</span><br><span class="line">		ptr++;</span><br><span class="line">	&#125; <span class="keyword">else</span> <span class="keyword">if</span> (*ptr == <span class="string">'+'</span>) &#123;</span><br><span class="line">		ptr++;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (ZEND_IS_DIGIT(*ptr)) &#123;</span><br><span class="line">		<span class="comment">/* Skip any leading 0s */</span></span><br><span class="line">		<span class="keyword">while</span> (*ptr == <span class="string">'0'</span>) &#123;</span><br><span class="line">			ptr++;</span><br><span class="line">		&#125;</span><br><span class="line">    <span class="comment">/* Count the number of digits. If a decimal point/exponent is found,</span></span><br><span class="line"><span class="comment">		 * it's a double. Otherwise, if there's a dval or no need to check for</span></span><br><span class="line"><span class="comment">		 * a full match, stop when there are too many digits for a long */</span></span><br><span class="line">		<span class="keyword">for</span> (type = IS_LONG; !(digits &gt;= MAX_LENGTH_OF_LONG &amp;&amp; (dval || allow_errors == <span class="number">1</span>)); digits++, ptr++) &#123;</span><br><span class="line">check_digits:</span><br><span class="line">			<span class="keyword">if</span> (ZEND_IS_DIGIT(*ptr)) &#123;</span><br><span class="line">				tmp_lval = tmp_lval * <span class="number">10</span> + (*ptr) - <span class="string">'0'</span>;</span><br><span class="line">				<span class="keyword">continue</span>;</span><br><span class="line">			&#125; <span class="keyword">else</span> <span class="keyword">if</span> (*ptr == <span class="string">'.'</span> &amp;&amp; dp_or_e &lt; <span class="number">1</span>) &#123;</span><br><span class="line">				<span class="keyword">goto</span> process_double;</span><br><span class="line">			&#125; <span class="keyword">else</span> <span class="keyword">if</span> ((*ptr == <span class="string">'e'</span> || *ptr == <span class="string">'E'</span>) &amp;&amp; dp_or_e &lt; <span class="number">2</span>) &#123;<span class="comment">//检查科学计数法</span></span><br><span class="line">				<span class="keyword">const</span> <span class="keyword">char</span> *e = ptr + <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">				<span class="keyword">if</span> (*e == <span class="string">'-'</span> || *e == <span class="string">'+'</span>) &#123;</span><br><span class="line">					ptr = e++;</span><br><span class="line">				&#125;</span><br><span class="line">				<span class="keyword">if</span> (ZEND_IS_DIGIT(*e)) &#123;</span><br><span class="line">					<span class="keyword">goto</span> process_double;</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		&#125;</span><br></pre></td></tr></table></figure>

<p>这是这个函数开始对字符串进行的过滤，过滤掉那些对字符串转数字有影响的字符。过滤完成以后再检查小数的位数，因为检查到了e，然后再检查后面的数字，其中<code>local_dval = zend_strtod(str, &amp;ptr);</code>很关键，我们可以看看zned_strtod()的内容。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (se)</span><br><span class="line">		*se = (<span class="keyword">char</span> *)s;<span class="comment">//此处将后面的数字转化为字符</span></span><br><span class="line">	<span class="keyword">return</span> sign ? -dval(&amp;rv) : dval(&amp;rv);</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>

<p>在两个函数都执行完这一套流程后，就进行比较，最后返回true</p>
</div><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">knight</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="https://knightswd.github.io/2020/03/18/php%E5%86%85%E6%A0%B8%E5%AD%A6%E4%B9%A0-%E4%BA%8C/">https://knightswd.github.io/2020/03/18/php%E5%86%85%E6%A0%B8%E5%AD%A6%E4%B9%A0-%E4%BA%8C/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://knightswd.github.io" target="_blank">knight'blog</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/knightswd.github.io/tags/web/">web</a><a class="post-meta__tags" href="/knightswd.github.io/tags/PHP%E5%86%85%E6%A0%B8/">PHP内核</a></div><div class="post_share"><div class="social-share" data-image="/knightswd.github.io/2020/08/03/chrome%E6%B5%8F%E8%A7%88%E5%99%A8cookie%E5%8F%8A%E5%AF%86%E7%A0%81%E8%A7%A3%E5%AF%86/cover.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css"/><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js"></script></div></div><div class="post-reward"><a class="reward-button button--primary button--animated"> <i class="fa fa-qrcode"></i> 打赏<div class="reward-main"><ul class="reward-all"><li class="reward-item"><img class="post-qr-code__img" src="/knightswd.github.io/img/wechat.jpg" alt="微信"/><div class="post-qr-code__desc">微信</div></li><li class="reward-item"><img class="post-qr-code__img" src="/knightswd.github.io/img/alipay.jpg" alt="支付寶"/><div class="post-qr-code__desc">支付寶</div></li></ul></div></a></div><nav class="pagination_post" id="pagination"><div class="prev-post pull_left"><a href="/knightswd.github.io/2020/03/29/php%E5%86%85%E6%A0%B8%E5%AD%A6%E4%B9%A0-%E4%B8%89/"><img class="prev_cover" data-src="/knightswd.github.io/2020/03/29/php%E5%86%85%E6%A0%B8%E5%AD%A6%E4%B9%A0-%E4%B8%89/cover.jpg" onerror="onerror=null;src='/knightswd.github.io/img/404.jpg'"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">php内核学习(三)</div></div></a></div><div class="next-post pull_right"><a href="/knightswd.github.io/2020/03/12/php%E5%86%85%E6%A0%B8%E5%AD%A6%E4%B9%A0-%E4%B8%80/"><img class="next_cover" data-src="/knightswd.github.io/2020/03/12/php%E5%86%85%E6%A0%B8%E5%AD%A6%E4%B9%A0-%E4%B8%80/cover.jpg" onerror="onerror=null;src='/knightswd.github.io/img/404.jpg'"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">php内核学习(一)</div></div></a></div></nav><div class="relatedPosts"><div class="relatedPosts_headline"><i class="fa fa-fw fa-thumbs-up" aria-hidden="true"></i><span> 相关推荐</span></div><div class="relatedPosts_list"><div class="relatedPosts_item"><a href="/knightswd.github.io/2019/11/06/网站大合集/" title="网站大合集"><img class="relatedPosts_cover" data-src="/2019/11/06/网站大合集/cover.jpg"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> 2019-11-06</div><div class="relatedPosts_title">网站大合集</div></div></a></div><div class="relatedPosts_item"><a href="/knightswd.github.io/2020/03/12/php内核学习-一/" title="php内核学习(一)"><img class="relatedPosts_cover" data-src="/2020/03/12/php内核学习-一/cover.jpg"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> 2020-03-12</div><div class="relatedPosts_title">php内核学习(一)</div></div></a></div></div><div class="clear_both"></div></div><hr><div id="post-comment"><div class="comment_headling"><i class="fa fa-comments fa-fw" aria-hidden="true"></i><span> 评论</span></div><div id="gitalk-container"></div><script>var gitalk = new Gitalk({
  clientID: '495c867eecd1a9295e35',
  clientSecret: 'b75492891f10bbf3a7a855d0301a0f3d702d15a1',
  repo: 'git@github.com:knightswd/knightswd.github.io.git',
  owner: 'knightswd',
  admin: ['knight'],
  id: md5(decodeURI(location.pathname)),
  language: 'zh-CN',
  perPage: 10,
  distractionFreeMode: false,
  pagerDirection: 'last',
  createIssueManually: false,
  updateCountCallback: commentCount
})
gitalk.render('gitalk-container')

function commentCount(n){
  try {
    document.getElementsByClassName('gitalk-comment-count')[0].innerHTML= n
  } catch (e) {
    return false
  }
}</script></div></article></main><footer id="footer" style="background-image: url(/knightswd.github.io/2020/03/18/php%E5%86%85%E6%A0%B8%E5%AD%A6%E4%B9%A0-%E4%BA%8C/cover.jpg)" data-type="photo"><div id="footer-wrap"><div class="copyright">&copy;2019 - 2020 By knight</div><div class="framework-info"><span>驱动 </span><a href="https://hexo.io" target="_blank" rel="noopener"><span>Hexo</span></a><span class="footer-separator">|</span><span>主题 </span><a href="https://github.com/jerryc127/hexo-theme-butterfly" target="_blank" rel="noopener"><span>Butterfly</span></a></div></div></footer></div><section class="rightside" id="rightside"><div id="rightside-config-hide"><i class="fa fa-book" id="readmode" title="阅读模式"></i><i class="fa fa-plus" id="font_plus" title="放大字体"></i><i class="fa fa-minus" id="font_minus" title="缩小字体"></i><a class="translate_chn_to_cht" id="translateLink" href="javascript:translatePage();" title="简繁转换" target="_self">繁</a><i class="darkmode fa fa-moon-o" id="darkmode" title="夜间模式"></i></div><div id="rightside-config-show"><div id="rightside_config" title="设置"><i class="fa fa-cog" aria-hidden="true"></i></div><a id="to_comment" href="#post-comment" title="直达评论"><i class="scroll_to_comment fa fa-comments">  </i></a><i class="fa fa-list-ul close" id="mobile-toc-button" title="目录" aria-hidden="true"></i><i class="fa fa-arrow-up" id="go-up" title="回到顶部" aria-hidden="true"></i></div></section><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="/knightswd.github.io/js/utils.js"></script><script src="/knightswd.github.io/js/main.js"></script><script src="/knightswd.github.io/js/tw_cn.js"></script><script src="https://cdn.jsdelivr.net/npm/medium-zoom/dist/medium-zoom.min.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script src="https://cdn.jsdelivr.net/npm/animejs@latest/anime.min.js"></script><script src="/knightswd.github.io/js/third-party/fireworks.js"></script><script src="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.js"></script><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page@latest/instantpage.min.js" type="module"></script><script src="https://cdn.jsdelivr.net/npm/lozad/dist/lozad.min.js"></script><script>if (document.getElementsByClassName('mermaid').length) {
  loadScript('https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js',function () {
    mermaid.initialize({
      theme: 'default',
  })
})
}</script><script>var endLoading = function () {
  document.body.style.overflow = 'auto';
  document.getElementById('loading-box').classList.add("loaded")
}
window.addEventListener('load',endLoading)</script></body></html>